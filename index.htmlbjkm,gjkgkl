<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ß–ò–°–õ–û–ë–ò–¢–í–ê</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Russo+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f0e17;
  --bg2: #1a1828;
  --bg3: #252338;
  --yellow: #ffd700;
  --orange: #ff8c00;
  --red: #e63946;
  --green: #4ecdc4;
  --blue: #4361ee;
  --white: #fffffe;
  --gray: #6e6d7a;
  --light: #a7a9be;
  --glow-y: 0 0 20px rgba(255,215,0,0.5);
  --glow-o: 0 0 20px rgba(255,140,0,0.5);
  --glow-r: 0 0 20px rgba(230,57,70,0.5);
  --glow-g: 0 0 20px rgba(78,205,196,0.5);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--white);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(ellipse at 20% 20%, rgba(67,97,238,0.12) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 80%, rgba(230,57,70,0.10) 0%, transparent 60%),
    radial-gradient(ellipse at 50% 50%, rgba(255,215,0,0.04) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}
.screen { display: none; position: relative; z-index: 1; }
.screen.active { display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
#introScreen { justify-content: center; padding: 40px 20px; text-align: center; }
.game-title {
  font-family: 'Bebas Neue', cursive;
  font-size: clamp(3rem, 10vw, 7rem);
  letter-spacing: 4px;
  line-height: 1;
  background: linear-gradient(135deg, var(--yellow), var(--orange), var(--red));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 30px rgba(255,140,0,0.4));
  animation: titlePulse 3s ease-in-out infinite;
}
@keyframes titlePulse {
  0%,100% { filter: drop-shadow(0 0 30px rgba(255,140,0,0.4)); }
  50% { filter: drop-shadow(0 0 50px rgba(255,140,0,0.7)); }
}
.game-subtitle { font-family: 'Russo One', sans-serif; font-size: 1rem; color: var(--light); letter-spacing: 6px; margin-top: 4px; margin-bottom: 40px; }
.intro-cards-preview { display: flex; gap: 12px; justify-content: center; margin-bottom: 40px; flex-wrap: wrap; }
.preview-card { width: 60px; height: 85px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', cursive; font-size: 2rem; animation: floatCard 3s ease-in-out infinite; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
.preview-card:nth-child(1) { background: linear-gradient(135deg, #b8860b, var(--yellow)); color: #333; animation-delay: 0s; }
.preview-card:nth-child(2) { background: linear-gradient(135deg, #cc6600, var(--orange)); color: #fff; animation-delay: 0.3s; }
.preview-card:nth-child(3) { background: linear-gradient(135deg, #9b0c16, var(--red)); color: #fff; animation-delay: 0.6s; }
.preview-card:nth-child(4) { background: linear-gradient(135deg, #b8860b, var(--yellow)); color: #333; animation-delay: 0.9s; }
.preview-card:nth-child(5) { background: linear-gradient(135deg, #cc6600, var(--orange)); color: #fff; animation-delay: 1.2s; }
@keyframes floatCard { 0%,100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-10px) rotate(3deg); } }
.diff-section { margin-bottom: 32px; }
.diff-label { font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; color: var(--gray); margin-bottom: 12px; font-weight: 800; }
.diff-btns { display: flex; gap: 12px; justify-content: center; }
.diff-btn { padding: 12px 28px; border-radius: 50px; border: 2px solid var(--bg3); background: var(--bg2); color: var(--light); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
.diff-btn.active { border-color: var(--yellow); color: var(--yellow); background: rgba(255,215,0,0.1); box-shadow: var(--glow-y); }
.start-btn { padding: 18px 60px; background: linear-gradient(135deg, var(--orange), var(--red)); border: none; border-radius: 50px; color: white; font-family: 'Bebas Neue', cursive; font-size: 1.8rem; letter-spacing: 3px; cursor: pointer; box-shadow: 0 8px 30px rgba(230,57,70,0.4); transition: all 0.2s; }
.start-btn:hover { transform: scale(1.05); box-shadow: 0 12px 40px rgba(230,57,70,0.6); }
#gameScreen { padding: 0; justify-content: flex-start; }
.game-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--bg2); border-bottom: 1px solid var(--bg3); }
.header-title { font-family: 'Bebas Neue', cursive; font-size: 1.4rem; letter-spacing: 3px; background: linear-gradient(135deg, var(--yellow), var(--orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.diff-badge { font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; padding: 4px 12px; border-radius: 50px; background: var(--bg3); color: var(--light); }
.score-bars { width: 100%; display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; padding: 12px 16px; background: var(--bg2); border-bottom: 2px solid var(--bg3); align-items: center; }
.score-side { display: flex; flex-direction: column; gap: 2px; }
.score-side.right { text-align: right; align-items: flex-end; }
.score-name { font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--gray); }
.score-pts { font-family: 'Bebas Neue', cursive; font-size: 2rem; line-height: 1; color: var(--white); }
.score-cards-count { font-size: 0.75rem; color: var(--gray); font-weight: 700; }
.vs-badge { font-family: 'Bebas Neue', cursive; font-size: 1.6rem; color: var(--gray); letter-spacing: 2px; text-align: center; }
.arena { width: 100%; max-width: 700px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; flex: 1; }
.ai-zone, .player-zone { display: flex; flex-direction: column; gap: 8px; }
.zone-label { font-size: 0.7rem; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; color: var(--gray); text-align: center; }
.ai-hand-display { display: flex; justify-content: center; gap: 6px; min-height: 70px; align-items: center; }
.card-back { width: 48px; height: 68px; border-radius: 8px; background: linear-gradient(135deg, #1e1c2e, #2d2b45); border: 2px solid var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.4); position: relative; overflow: hidden; }
.card-back::after { content: '‚öî'; font-size: 1rem; color: rgba(255,255,255,0.1); }
.battle-table { background: var(--bg2); border-radius: 20px; border: 2px solid var(--bg3); padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 200px; position: relative; }
.table-row { display: flex; justify-content: center; align-items: center; gap: 10px; min-height: 96px; overflow-x: auto; padding: 0 4px; scrollbar-width: none; } .table-row::-webkit-scrollbar { display: none; }
.table-slot { width: 96px; height: 134px; border-radius: 10px; border: 2px dashed var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--gray); letter-spacing: 1px; position: relative; transition: all 0.3s; overflow: visible; }
.table-slot.has-card { border-style: solid; }
.table-slot-label { font-size: 0.6rem; font-weight: 800; letter-spacing: 2px; color: var(--gray); text-transform: uppercase; }
.slot-vs { font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bg3); user-select: none; }
.game-card { width: 96px; height: 134px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.2s; box-shadow: 0 6px 20px rgba(0,0,0,0.5); user-select: none; flex-shrink: 0; }
.game-card:hover { transform: translateY(-8px) scale(1.05); }
.game-card.selected { transform: translateY(-16px) scale(1.08); }
.game-card.digit { background: linear-gradient(145deg, #c8a900, #ffd700, #e6b800); color: #2d2200; }
.game-card.digit .card-value { font-family: 'Bebas Neue', cursive; font-size: 4.5rem; line-height: 1; }
.game-card.buff { background: linear-gradient(145deg, #b35900, #ff8c00, #cc6600); color: #fff; }
.game-card.super { background: linear-gradient(145deg, #8b0000, #e63946, #c02030); color: #fff; }
.game-card .card-type-icon { font-size: 0.6rem; font-weight: 900; letter-spacing: 1px; opacity: 0.8; text-transform: uppercase; }
.game-card .card-name { font-size: 0.62rem; font-weight: 800; text-align: center; padding: 0 4px; letter-spacing: 0.5px; line-height: 1.2; opacity: 0.9; }
.table-card { width: 96px; height: 134px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 8px 24px rgba(0,0,0,0.6); }
@keyframes cardDrop { 0% { transform: translate(-50%, -120%) scale(0.7) rotate(-10deg); opacity: 0; } 70% { transform: translate(-50%, -44%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
.player-hand { display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 134px; padding: 8px 0; }
.hand-row { display: flex; justify-content: center; gap: 8px; }
.action-area { width: 100%; max-width: 700px; margin: 0 auto; padding: 8px 16px 16px; display: flex; flex-direction: column; gap: 8px; align-items: center; }
.action-btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
.action-btn { padding: 12px 28px; border: none; border-radius: 50px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
.action-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; }
.btn-attack { background: linear-gradient(135deg, var(--yellow), var(--orange)); color: #1a0500; box-shadow: 0 4px 16px rgba(255,140,0,0.4); }
.btn-attack:not(:disabled):hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(255,140,0,0.6); }
.btn-pass { background: var(--bg3); color: var(--light); }
.btn-pass:not(:disabled):hover { background: var(--gray); }
.status-msg { text-align: center; font-weight: 800; font-size: 0.95rem; color: var(--light); min-height: 24px; letter-spacing: 0.5px; }
.status-msg.highlight { color: var(--yellow); }
.status-msg.danger { color: var(--red); }
.status-msg.success { color: var(--green); }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
.overlay.active { display: flex; }
.popup { background: var(--bg2); border-radius: 24px; border: 2px solid var(--bg3); padding: 32px; max-width: 420px; width: 100%; text-align: center; animation: popupIn 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97); }
@keyframes popupIn { from { transform: scale(0.7) rotate(-5deg); opacity: 0; } 70% { transform: scale(1.05); } to { transform: scale(1); opacity: 1; } }
.popup-title { font-family: 'Bebas Neue', cursive; font-size: 2.5rem; letter-spacing: 3px; margin-bottom: 12px; background: linear-gradient(135deg, var(--yellow), var(--orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.popup-body { color: var(--light); font-size: 0.95rem; font-weight: 600; line-height: 1.6; margin-bottom: 24px; }
.popup-body:empty { display: none; margin: 0; }
.popup-cards { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 16px; }
.popup-btn { padding: 12px 28px; border: none; border-radius: 50px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.9rem; cursor: pointer; margin: 4px; transition: all 0.2s; }
.popup-btn-primary { background: linear-gradient(135deg, var(--orange), var(--red)); color: white; box-shadow: 0 4px 16px rgba(230,57,70,0.4); }
.popup-btn-secondary { background: var(--bg3); color: var(--light); }
.popup-btn:hover { transform: scale(1.05); }
.popup-card-select { width: 82px; height: 114px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
.popup-card-select:hover { transform: translateY(-6px) scale(1.06); }
.popup-card-select[data-desc] { position: relative; }
.popup-card-select[data-desc]:hover::after { content: attr(data-desc); position: absolute; bottom: 108%; left: 50%; transform: translateX(-50%); background: rgba(10,9,20,0.97); color: var(--white); font-family: 'Nunito', sans-serif; font-size: 0.68rem; font-weight: 700; padding: 8px 12px; border-radius: 10px; white-space: normal; width: 160px; text-align: center; z-index: 300; line-height: 1.45; pointer-events: none; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
.popup-card-select.chosen { border-color: var(--green); box-shadow: var(--glow-g); }
.game-card.peak-received { box-shadow: 0 0 0 3px #4361ee, 0 0 20px rgba(67,97,238,0.7); }
.game-card.stolen-card { box-shadow: 0 0 0 3px #e63946, 0 0 20px rgba(230,57,70,0.7); }
.game-card.reanimated-card { box-shadow: 0 0 0 3px #4ecdc4, 0 0 20px rgba(78,205,196,0.7); }
.swap-selecting .game-card:not(.digit) { opacity: 0.2; pointer-events: none; }
.swap-selecting .game-card.digit { opacity: 0.75; }
.swap-selecting .game-card.digit:hover { opacity: 1; transform: translateY(-8px) scale(1.05); }
.btn-peak-source { padding: 14px 20px; border: 2px solid #4361ee; border-radius: 16px; background: rgba(67,97,238,0.15); color: #7b9fff; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; text-align: center; width: 100%; }
.btn-peak-source:hover { background: rgba(67,97,238,0.35); color: #fff; border-color: #7b9fff; box-shadow: 0 0 16px rgba(67,97,238,0.5); transform: scale(1.03); }
.btn-peak-source:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }





.result-text { font-family: 'Bebas Neue', cursive; font-size: 3rem; letter-spacing: 4px; line-height: 1; }
.result-sub { font-size: 0.85rem; font-weight: 700; color: var(--light); margin-top: 4px; letter-spacing: 1px; }
#endScreen { justify-content: center; padding: 40px 20px; text-align: center; }
.end-icon { font-size: 5rem; margin-bottom: 8px; animation: bounce 1s ease-in-out infinite alternate; }
@keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1) rotate(5deg); } }
.end-result { font-family: 'Bebas Neue', cursive; font-size: clamp(3rem, 10vw, 6rem); letter-spacing: 4px; line-height: 1; margin-bottom: 8px; }
.end-result.win { color: var(--green); text-shadow: 0 0 30px rgba(78,205,196,0.5); }
.end-result.lose { color: var(--red); text-shadow: 0 0 30px rgba(230,57,70,0.5); }
.end-result.draw { color: var(--yellow); text-shadow: 0 0 30px rgba(255,215,0,0.5); }
.score-breakdown { background: var(--bg2); border-radius: 20px; border: 2px solid var(--bg3); padding: 24px; margin: 24px 0; max-width: 400px; width: 100%; text-align: left; }
.breakdown-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--bg3); font-weight: 700; }
.breakdown-row:last-child { border: none; font-family: 'Bebas Neue', cursive; font-size: 1.3rem; }
.breakdown-label { color: var(--light); }
.breakdown-val { color: var(--white); }
.play-again-btn { padding: 18px 56px; background: linear-gradient(135deg, var(--blue), var(--green)); border: none; border-radius: 50px; color: white; font-family: 'Bebas Neue', cursive; font-size: 1.8rem; letter-spacing: 3px; cursor: pointer; box-shadow: 0 8px 30px rgba(78,205,196,0.3); transition: all 0.2s; margin-top: 8px; }
.play-again-btn:hover { transform: scale(1.05); }
.battle-log { width: 100%; max-width: 700px; margin: 0 auto; padding: 0 16px 4px; }
.log-line { font-size: 0.75rem; font-weight: 700; color: var(--gray); text-align: center; padding: 2px 0; animation: fadeIn 0.3s; }
.log-line.important { color: var(--light); }
.log-line.warn { color: var(--orange); }
.log-line.good { color: var(--green); }
@keyframes fadeIn { from { opacity:0; transform: translateY(4px); } to { opacity:1; } }
.hand-header { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 4px; }
.hand-count { font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; color: var(--gray); background: var(--bg3); padding: 2px 10px; border-radius: 20px; }
.table-card.digit { background: linear-gradient(145deg, #c8a900, #ffd700, #e6b800); color: #2d2200; }
.table-card.buff { background: linear-gradient(145deg, #b35900, #ff8c00, #cc6600); color: #fff; }
.table-card.super { background: linear-gradient(145deg, #8b0000, #e63946, #c02030); color: #fff; }
.table-card .card-value { font-family: 'Bebas Neue', cursive; font-size: 3rem; line-height: 1; }
.table-card .card-name { font-size: 0.55rem; font-weight: 800; text-align: center; padding: 0 4px; opacity: 0.9; line-height: 1.2; }
.modifier-badge { position: absolute; top: -8px; right: -8px; background: var(--green); color: #000; font-size: 0.65rem; font-weight: 900; border-radius: 50px; padding: 2px 6px; z-index: 5; }
@keyframes superPulse { 0%,100% { box-shadow: 0 0 20px rgba(255,140,0,0.5), 0 0 40px rgba(255,140,0,0.2); border-color: var(--orange); } 50% { box-shadow: 0 0 40px rgba(255,140,0,0.9), 0 0 80px rgba(255,140,0,0.4); border-color: var(--yellow); } }
.superbattle-mode { animation: superPulse 0.6s ease-in-out infinite; }
.game-card[data-tip] { position: relative; }
.game-card[data-tip]:hover::after { content: attr(data-tip); position: absolute; bottom: 108%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); color: var(--white); font-size: 0.65rem; font-weight: 700; padding: 6px 10px; border-radius: 8px; white-space: normal; max-width: 180px; text-align: center; z-index: 50; line-height: 1.4; pointer-events: none; border: 1px solid var(--bg3); }
.superbattle-label { text-align: center; font-family: 'Bebas Neue', cursive; font-size: 1.2rem; letter-spacing: 4px; color: var(--orange); display: none; }
.superbattle-label.show { display: block; animation: titlePulse 1s ease-in-out infinite; }
.battle-area { display: grid; grid-template-columns: 72px 1fr 72px; gap: 8px; align-items: center; width: 100%; }
.side-panel { display: flex; flex-direction: column; align-items: center; gap: 6px; height: 100%; justify-content: center; }
.side-label { font-size: 0.55rem; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--gray); text-align: center; }
.side-count { font-size: 0.6rem; font-weight: 800; color: var(--gray); text-align: center; }
.win-stack-visual { position: relative; width: 48px; min-height: 68px; flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
.win-stack-card { position: absolute; width: 44px; height: 62px; border-radius: 7px; border: 1.5px solid rgba(255,255,255,0.08); box-shadow: 0 2px 6px rgba(0,0,0,0.4); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
.win-stack-card.digit { background: linear-gradient(145deg, #b8970a, #ffd700); }
.win-stack-card.buff { background: linear-gradient(145deg, #b35900, #ff8c00); }
.win-stack-card.super { background: linear-gradient(145deg, #8b0000, #e63946); }
.win-stack-card.back { background: linear-gradient(135deg, #1e1c2e, #2d2b45); }
.win-stack-card .wsc-val { font-family: 'Bebas Neue', cursive; font-size: 1.5rem; line-height: 1; }
.win-stack-card .wsc-icon { font-size: 0.9rem; line-height: 1; }

.table-played-row { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; min-height: 0; }
.table-played-card { width: 38px; height: 52px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.28rem; font-weight: 800; text-align: center; padding: 2px; line-height: 1.2; opacity: 0.9; flex-shrink: 0; }
.table-played-card.buff { background: linear-gradient(145deg, #b35900, #ff8c00); color: #fff; }
.table-played-card.super { background: linear-gradient(145deg, #8b0000, #e63946); color: #fff; }
.win-stack-card .wsc-name { font-size: 0.32rem; font-weight: 800; text-align: center; padding: 0 2px; line-height: 1.2; opacity: 0.9; }
.decks-visual { display: flex; flex-direction: column; gap: 10px; align-items: center; flex: 1; justify-content: center; }
.deck-pile { position: relative; width: 48px; cursor: default; }
.deck-pile-card { position: absolute; width: 44px; height: 62px; border-radius: 7px; border: 1.5px solid rgba(255,255,255,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.4); }
.deck-pile-card.digit-back { background: linear-gradient(145deg, #9a7a00, #c8a900); border-color: rgba(255,215,0,0.3); }
.deck-pile-card.buff-back { background: linear-gradient(145deg, #7a3800, #b35900); border-color: rgba(255,140,0,0.3); }
.deck-pile-card.super-back { background: linear-gradient(145deg, #5a0008, #8b0000); border-color: rgba(230,57,70,0.3); }
.deck-label { font-size: 1rem; text-align: center; position: relative; z-index: 10; }
.deck-count { font-family: 'Bebas Neue', cursive; font-size: 1.6rem; color: var(--white); text-align: center; position: relative; z-index: 10; text-shadow: 0 2px 6px rgba(0,0,0,0.9); line-height: 1; }
.deck-empty { opacity: 0.3; font-size: 0.6rem; font-weight: 800; color: var(--gray); text-align: center; }
.flying-card {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  border-radius: 10px;
  box-shadow: 0 16px 48px rgba(0,0,0,0.8);
  transform-origin: center center;
}
.flying-card.digit { background: linear-gradient(145deg, #c8a900, #ffd700, #e6b800); color: #2d2200; }
.flying-card.buff   { background: linear-gradient(145deg, #b35900, #ff8c00, #cc6600); color: #fff; }
.flying-card.super  { background: linear-gradient(145deg, #8b0000, #e63946, #c02030); color: #fff; }

/* ‚îÄ‚îÄ Intro menu layout ‚îÄ‚îÄ */
#introScreen { position: relative; }
.intro-bottom-bar { position: fixed; bottom: 24px; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 28px; z-index: 10; }
.icon-btn { width: 54px; height: 54px; border-radius: 50%; border: 2px solid var(--bg3); background: var(--bg2); color: var(--light); font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
.icon-btn:hover { border-color: var(--yellow); color: var(--yellow); transform: scale(1.08); }
.battlepass-btn { padding: 18px 60px; background: linear-gradient(135deg, #4361ee, #7b2fff); border: none; border-radius: 50px; color: white; font-family: 'Bebas Neue', cursive; font-size: 1.8rem; letter-spacing: 3px; cursor: pointer; box-shadow: 0 8px 30px rgba(67,97,238,0.5); transition: all 0.2s; }
.battlepass-btn:hover { transform: scale(1.05); box-shadow: 0 12px 40px rgba(67,97,238,0.7); }

/* ‚îÄ‚îÄ Settings popup ‚îÄ‚îÄ */
.settings-popup { background: var(--bg2); border-radius: 24px; border: 2px solid var(--bg3); padding: 28px 24px; max-width: 380px; width: 100%; text-align: left; animation: popupIn 0.3s cubic-bezier(0.36,0.07,0.19,0.97); }
.settings-title { font-family: 'Bebas Neue', cursive; font-size: 2rem; letter-spacing: 3px; margin-bottom: 20px; color: var(--white); text-align: center; }
.settings-section { margin-bottom: 18px; }
.settings-label { font-size: 0.75rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--gray); margin-bottom: 10px; }
.settings-options { display: flex; gap: 8px; flex-wrap: wrap; }
.settings-option { padding: 8px 16px; border-radius: 20px; border: 2px solid var(--bg3); background: var(--bg3); color: var(--light); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
.settings-option:hover { border-color: var(--yellow); }
.settings-option.active { border-color: var(--yellow); color: var(--yellow); background: rgba(255,215,0,0.1); }
.card-back-preview { width: 44px; height: 62px; border-radius: 8px; display: inline-block; vertical-align: middle; margin-right: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
.card-back-preview.active { border-color: var(--yellow); box-shadow: 0 0 12px rgba(255,215,0,0.5); }
.board-preview { width: 80px; height: 52px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 800; cursor: pointer; border: 2px solid var(--bg3); transition: all 0.2s; color: rgba(255,255,255,0.7); margin-right: 6px; }
.board-preview.active { border-color: var(--yellow); box-shadow: 0 0 12px rgba(255,215,0,0.5); }
.toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--bg3); }
.toggle-label-text { font-size: 0.9rem; font-weight: 700; color: var(--light); }
.toggle { width: 48px; height: 26px; background: var(--bg3); border-radius: 20px; position: relative; cursor: pointer; transition: background 0.2s; }
.toggle.on { background: var(--yellow); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:#fff; transition: transform 0.2s; }
.toggle.on::after { transform: translateX(22px); }
/* ‚îÄ‚îÄ Battlepass horizontal scroll ‚îÄ‚îÄ */
.bp-scroll-wrap {
  overflow-x: auto;
  overflow-y: visible;
  -webkit-overflow-scrolling: touch;
  padding: 4px 2px 16px;
  margin: 0 -4px;
  /* Custom scrollbar */
  scrollbar-width: thin;
  scrollbar-color: #7b2fff #1a1828;
}
.bp-scroll-wrap::-webkit-scrollbar { height: 6px; }
.bp-scroll-wrap::-webkit-scrollbar-track { background: #1a1828; border-radius: 10px; }
.bp-scroll-wrap::-webkit-scrollbar-thumb {
  background: linear-gradient(90deg, #4361ee, #7b2fff, #c084fc);
  border-radius: 10px;
}

.bp-row { display: flex; gap: 10px; min-width: max-content; margin-bottom: 10px; }
.bp-level-row { align-items: center; margin-bottom: 10px; }

.bp-cell {
  width: 96px;
  flex-shrink: 0;
  border-radius: 16px;
  padding: 12px 8px 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-height: 84px;
  text-align: center;
  box-sizing: border-box;
  border: 2px solid transparent;
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), box-shadow 0.18s;
  cursor: default;
  position: relative;
  overflow: hidden;
}
/* subtle inner shine */
.bp-cell::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 40%;
  background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 100%);
  border-radius: 14px 14px 0 0;
  pointer-events: none;
}
.bp-cell.clickable { cursor: pointer; }
.bp-cell.clickable:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 10px 28px rgba(0,0,0,0.5);
}
.bp-cell.clickable:active { transform: translateY(-1px) scale(1.01); }

/* Free track */
.bp-cell.free-cell {
  background: linear-gradient(160deg, rgba(78,205,196,0.06) 0%, rgba(20,60,55,0.3) 100%);
  border-color: rgba(78,205,196,0.2);
}
.bp-cell.free-cell.unlocked {
  background: linear-gradient(160deg, rgba(78,205,196,0.15) 0%, rgba(20,80,70,0.4) 100%);
  border-color: var(--green);
  box-shadow: 0 0 14px rgba(78,205,196,0.2), inset 0 1px 0 rgba(78,205,196,0.15);
}
.bp-cell.free-cell.claimed {
  background: var(--bg3);
  border-color: rgba(255,255,255,0.05);
  opacity: 0.7;
}

/* Premium track */
.bp-cell.prem-cell {
  background: linear-gradient(160deg, rgba(107,0,200,0.08) 0%, rgba(30,5,60,0.35) 100%);
  border-color: rgba(107,0,200,0.2);
}
.bp-cell.prem-cell.unlocked {
  background: linear-gradient(160deg, rgba(123,47,255,0.2) 0%, rgba(50,0,100,0.5) 100%);
  border-color: #7b2fff;
  box-shadow: 0 0 14px rgba(123,47,255,0.3), inset 0 1px 0 rgba(192,132,252,0.15);
}
.bp-cell.prem-cell.claimed {
  background: var(--bg3);
  border-color: rgba(255,255,255,0.05);
  opacity: 0.7;
}
.bp-cell.locked-prem {
  background: linear-gradient(160deg, rgba(20,0,40,0.6) 0%, rgba(10,0,25,0.8) 100%);
  border-color: rgba(60,0,100,0.4);
  opacity: 0.6;
}

.bp-cell-icon { font-size: 1.5rem; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }
.bp-cell-label { font-size: 0.63rem; font-weight: 800; line-height: 1.3; }
.bp-cell-sub { font-size: 0.5rem; font-weight: 700; color: var(--gray); letter-spacing: 0.5px; }

/* Level nodes */
.bp-lvl-node {
  width: 96px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
}
.bp-lvl-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Bebas Neue', cursive;
  font-size: 1.15rem;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
  transition: box-shadow 0.2s;
}
.bp-lvl-line {
  flex: 1;
  height: 3px;
  border-radius: 2px;
}

/* Crystal shop pack buttons */
.crystal-pack-btn {
  font-family: 'Nunito', sans-serif;
  transition: transform 0.15s, box-shadow 0.15s;
}
.crystal-pack-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
}

/* ‚îÄ‚îÄ Mode selection buttons ‚îÄ‚îÄ */
.mode-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px 20px;
  border-radius: 18px;
  border: 2px solid var(--bg3);
  background: var(--bg2);
  color: var(--white);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}
.mode-btn:hover { transform: translateY(-2px) scale(1.02); }
.mode-solo:hover { border-color: var(--yellow); box-shadow: 0 8px 24px rgba(255,215,0,0.2); }
.mode-multi:hover { border-color: #7b2fff; box-shadow: 0 8px 24px rgba(123,47,255,0.3); }
.mode-icon { font-size: 2rem; flex-shrink: 0; }
.mode-info { flex: 1; }
.mode-title { font-family: 'Bebas Neue', cursive; font-size: 1.5rem; letter-spacing: 2px; line-height: 1; }
.mode-sub { font-size: 0.75rem; font-weight: 700; color: var(--gray); margin-top: 3px; letter-spacing: 0.5px; }
.mode-arrow { font-size: 1.8rem; color: var(--gray); flex-shrink: 0; }
.back-mode-btn {
  align-self: flex-start;
  padding: 8px 18px;
  border-radius: 50px;
  border: 2px solid var(--bg3);
  background: transparent;
  color: var(--gray);
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 1px;
}
.back-mode-btn:hover { border-color: var(--light); color: var(--white); }

/* ‚îÄ‚îÄ Matchmaking radar ‚îÄ‚îÄ */
.mm-radar {
  position: relative;
  width: 160px;
  height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.mm-radar-ring {
  position: absolute;
  border-radius: 50%;
  border: 2px solid rgba(67,97,238,0.4);
  animation: radarPulse 2.5s ease-out infinite;
}
.ring1 { width: 60px;  height: 60px;  animation-delay: 0s; }
.ring2 { width: 110px; height: 110px; animation-delay: 0.6s; }
.ring3 { width: 160px; height: 160px; animation-delay: 1.2s; }
@keyframes radarPulse {
  0%   { opacity: 0.8; transform: scale(0.7); }
  100% { opacity: 0;   transform: scale(1); }
}
.mm-radar-dot {
  width: 18px; height: 18px;
  border-radius: 50%;
  background: #4361ee;
  box-shadow: 0 0 16px #4361ee, 0 0 32px rgba(67,97,238,0.5);
  z-index: 2;
}
.mm-player-dot {
  position: absolute;
  width: 28px; height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--yellow), var(--orange));
  box-shadow: 0 0 12px rgba(255,200,0,0.6);
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 3;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem;
}

/* Opponent dot on radar */
.mm-opp-dot {
  position: absolute;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--red), #ff6b6b);
  box-shadow: 0 0 12px rgba(230,57,70,0.6);
  z-index: 3;
  animation: oppAppear 0.5s cubic-bezier(0.36,0.07,0.19,0.97);
}
@keyframes oppAppear {
  from { transform: scale(0) translate(-50%,-50%); opacity: 0; }
  to   { transform: scale(1) translate(0,0); opacity: 1; }
}

/* ‚îÄ‚îÄ Multiplayer game indicator ‚îÄ‚îÄ */
.mp-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 50px;
  background: linear-gradient(135deg, #4361ee, #7b2fff);
  font-size: 0.65rem;
  font-weight: 800;
  letter-spacing: 1.5px;
  color: white;
  margin-left: 8px;
  vertical-align: middle;
}

/* Waiting for opponent overlay in-game */
.mp-waiting-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 200;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}
.mp-waiting-spinner {
  width: 48px; height: 48px;
  border: 4px solid var(--bg3);
  border-top-color: #4361ee;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="introScreen" class="screen active">
  <div class="game-title">–ß–ò–°–õ–û–ë–ò–¢–í–ê</div>
  <div class="intro-cards-preview">
    <div class="preview-card">7</div>
    <div class="preview-card">üõ°</div>
    <div class="preview-card">3</div>
    <div class="preview-card">‚ö°</div>
    <div class="preview-card">9</div>
  </div>

  <!-- Mode selector -->
  <div id="modeSelect" style="display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;max-width:340px;margin-bottom:40px;">
    <div class="diff-label" style="margin-bottom:0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</div>
    <button class="mode-btn mode-solo" onclick="showSoloPanel()">
      <span class="mode-icon">ü§ñ</span>
      <div class="mode-info">
        <div class="mode-title">–û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞</div>
        <div class="mode-sub">–ü—Ä–æ—Ç–∏–≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</div>
      </div>
      <span class="mode-arrow">‚Ä∫</span>
    </button>
    <button class="mode-btn mode-multi" onclick="showMultiPanel()">
      <span class="mode-icon">‚öî</span>
      <div class="mode-info">
        <div class="mode-title">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</div>
        <div class="mode-sub">–ü—Ä–æ—Ç–∏–≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞</div>
      </div>
      <span class="mode-arrow">‚Ä∫</span>
    </button>
  </div>

  <!-- Solo panel -->
  <div id="soloPanel" style="display:none;flex-direction:column;align-items:center;gap:16px;width:100%;max-width:340px;margin-bottom:40px;">
    <button class="back-mode-btn" onclick="showModeSelect()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="diff-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò</div>
    <div class="diff-btns">
      <button class="diff-btn active" onclick="selectDiff(this,'easy')">üòå –õ—ë–≥–∫–∞—è</button>
      <button class="diff-btn" onclick="selectDiff(this,'hard')">üî• –°–ª–æ–∂–Ω–∞—è</button>
    </div>
    <button class="start-btn" onclick="startGame()">‚öî –ù–ê–ß–ê–¢–¨ –ë–ò–¢–í–£ ‚öî</button>
  </div>

  <!-- Multi panel: choose sub-mode -->
  <div id="multiPanel" style="display:none;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:340px;margin-bottom:40px;">
    <button class="back-mode-btn" onclick="showModeSelect()">‚Üê –ù–∞–∑–∞–¥</button>

    <!-- Nickname row -->
    <div id="mpNicknameDisplay" style="background:var(--bg2);border:2px solid var(--bg3);border-radius:14px;padding:10px 20px;width:100%;text-align:center;display:none;box-sizing:border-box;">
      <div style="font-size:0.6rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:2px;">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</div>
      <div id="mpNicknameValue" style="font-family:'Bebas Neue',cursive;font-size:1.4rem;letter-spacing:2px;color:var(--yellow);"></div>
    </div>
    <div id="mpNoNickWarn" style="display:none;background:rgba(255,140,0,0.1);border:1px solid var(--orange);border-radius:12px;padding:10px 16px;font-size:0.78rem;font-weight:700;color:var(--orange);text-align:center;width:100%;box-sizing:border-box;">
      ‚ö† –£ –≤–∞—Å –Ω–µ—Ç –Ω–∏–∫–Ω–µ–π–º–∞.<br>
      <span onclick="openNicknameOverlay()" style="text-decoration:underline;cursor:pointer;color:var(--yellow);">–°–æ–∑–¥–∞—Ç—å –Ω–∏–∫–Ω–µ–π–º</span> –∏–ª–∏ –≤–æ–π–¥—ë—Ç–µ –∫–∞–∫ ¬´–ò–≥—Ä–æ–∫¬ª
    </div>

    <div class="diff-label" style="margin:4px 0 0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</div>

    <button class="mode-btn mode-multi" onclick="startMatchmaking()" style="width:100%;">
      <span class="mode-icon">üîç</span>
      <div class="mode-info">
        <div class="mode-title">–ë–∏—Ç–≤–∞</div>
        <div class="mode-sub">–ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</div>
      </div>
      <span class="mode-arrow">‚Ä∫</span>
    </button>

    <button class="mode-btn" onclick="showFriendPanel()" style="width:100%;border-color:var(--bg3);" onmouseover="this.style.borderColor='#4ecdc4';this.style.boxShadow='0 8px 24px rgba(78,205,196,0.2)'" onmouseout="this.style.borderColor='var(--bg3)';this.style.boxShadow=''">
      <span class="mode-icon">ü§ù</span>
      <div class="mode-info">
        <div class="mode-title">–ë–∏—Ç–≤–∞ —Å –¥—Ä—É–≥–æ–º</div>
        <div class="mode-sub">–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É –ø–æ —Å—Å—ã–ª–∫–µ</div>
      </div>
      <span class="mode-arrow">‚Ä∫</span>
    </button>
  </div>

  <!-- Friend room panel -->
  <div id="friendPanel" style="display:none;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:340px;margin-bottom:40px;">
    <button class="back-mode-btn" onclick="showMultiPanel()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="diff-label" style="margin:4px 0 0;">–ë–∏—Ç–≤–∞ —Å –¥—Ä—É–≥–æ–º</div>

    <!-- Firebase status -->
    <div id="fbStatusBar" onclick="checkFbStatus()" style="width:100%;background:var(--bg2);border:2px solid var(--bg3);border-radius:12px;padding:10px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s;box-sizing:border-box;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏">
      <div id="fbStatusDot" style="width:10px;height:10px;border-radius:50%;background:var(--gray);flex-shrink:0;"></div>
      <div id="fbStatusText" style="font-size:0.78rem;font-weight:700;color:var(--gray);flex:1;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase</div>
    </div>

    <!-- Create room -->
    <button class="mode-btn" onclick="showCreateRoomPanel()" style="width:100%;" onmouseover="this.style.borderColor='var(--yellow)';this.style.boxShadow='0 8px 24px rgba(255,215,0,0.15)'" onmouseout="this.style.borderColor='var(--bg3)';this.style.boxShadow=''">
      <span class="mode-icon">üè†</span>
      <div class="mode-info">
        <div class="mode-title">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</div>
        <div class="mode-sub">–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
      </div>
      <span class="mode-arrow">‚Ä∫</span>
    </button>

    <!-- Join room -->
    <div style="width:100%;background:var(--bg2);border:2px solid var(--bg3);border-radius:18px;padding:18px;box-sizing:border-box;">
      <div style="font-size:0.7rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:10px;">–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É –∫–æ–º–Ω–∞—Ç—ã</div>
      <input id="joinRoomCode" type="text" maxlength="8" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã"
        style="width:100%;padding:11px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Bebas Neue',cursive;font-size:1.4rem;letter-spacing:4px;text-transform:uppercase;text-align:center;outline:none;box-sizing:border-box;"
        oninput="this.value=this.value.toUpperCase()">
      <input id="joinRoomPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)"
        style="width:100%;padding:11px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;text-align:center;outline:none;box-sizing:border-box;margin-top:8px;">
      <div id="joinRoomError" style="color:var(--red);font-size:0.78rem;font-weight:700;min-height:18px;margin-top:6px;"></div>
      <button onclick="joinFriendRoom()" style="width:100%;margin-top:8px;padding:13px;background:linear-gradient(135deg,#4361ee,#7b2fff);border:none;border-radius:50px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.95rem;cursor:pointer;letter-spacing:1px;transition:all 0.2s;">
        üö™ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
      </button>
    </div>
  </div>

  <!-- Create room panel -->
  <div id="createRoomPanel" style="display:none;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:340px;margin-bottom:40px;">
    <button class="back-mode-btn" onclick="showFriendPanel()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="diff-label" style="margin:4px 0 0;">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</div>

    <div style="width:100%;background:var(--bg2);border:2px solid var(--bg3);border-radius:18px;padding:18px;box-sizing:border-box;display:flex;flex-direction:column;gap:12px;">
      <div>
        <div style="font-size:0.7rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:8px;">–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
        <input id="createRoomPass" type="text" maxlength="20" placeholder="–ë–µ–∑ –ø–∞—Ä–æ–ª—è ‚Äî –æ—Ç–∫—Ä—ã—Ç–∞—è"
          style="width:100%;padding:11px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;text-align:center;outline:none;box-sizing:border-box;"
          oninput="this.style.borderColor=this.value.trim()?'var(--yellow)':'var(--bg)'">
      </div>
      <button onclick="createFriendRoom()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--orange),var(--red));border:none;border-radius:50px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;letter-spacing:1px;">
        üè† –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
      </button>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="intro-bottom-bar">
    <button class="icon-btn" onclick="openAccountPopup()" title="–ê–∫–∫–∞—É–Ω—Ç" id="accountBtn">üë§</button>
    <button class="battlepass-btn" onclick="openBattlepassPopup()">üèÜ –ë–ê–¢–õ–ü–ê–°–°</button>
    <button class="icon-btn" onclick="openSettingsPopup()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
  </div>
</div>

<!-- Matchmaking screen -->
<div id="matchmakingScreen" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;padding:40px 20px;text-align:center;">
    <div style="font-family:'Bebas Neue',cursive;font-size:2.5rem;letter-spacing:4px;background:linear-gradient(135deg,#4361ee,#7b2fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">
      –ü–û–ò–°–ö –ò–ì–†–´
    </div>

    <!-- Animated radar -->
    <div class="mm-radar">
      <div class="mm-radar-ring ring1"></div>
      <div class="mm-radar-ring ring2"></div>
      <div class="mm-radar-ring ring3"></div>
      <div class="mm-radar-dot"></div>
      <div id="mmPlayerDot" class="mm-player-dot" title="–í—ã"></div>
    </div>

    <div>
      <div id="mmStatus" style="font-family:'Bebas Neue',cursive;font-size:1.8rem;letter-spacing:3px;color:var(--white);margin-bottom:8px;">
        –ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...
      </div>
      <div id="mmSubstatus" style="font-size:0.85rem;font-weight:700;color:var(--gray);letter-spacing:1px;">
        –û–∂–∏–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
      </div>
    </div>

    <!-- Timer -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
      <div style="font-size:0.7rem;font-weight:800;letter-spacing:3px;text-transform:uppercase;color:var(--gray);">–í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞</div>
      <div id="mmTimer" style="font-family:'Bebas Neue',cursive;font-size:3.5rem;line-height:1;color:var(--white);letter-spacing:2px;">0:00</div>
    </div>

    <!-- Online players count -->
    <div style="background:var(--bg2);border:2px solid var(--bg3);border-radius:16px;padding:14px 28px;display:flex;gap:24px;align-items:center;">
      <div style="text-align:center;">
        <div style="font-family:'Bebas Neue',cursive;font-size:2rem;color:var(--green);" id="mmOnlineCount">‚Äî</div>
        <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);">–í –°–ï–¢–ò</div>
      </div>
      <div style="width:1px;height:40px;background:var(--bg3);"></div>
      <div style="text-align:center;">
        <div style="font-family:'Bebas Neue',cursive;font-size:2rem;color:var(--orange);" id="mmSearchingCount">‚Äî</div>
        <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);">–ò–©–£–¢ –ò–ì–†–£</div>
      </div>
    </div>

    <!-- Found animation (hidden by default) -->
    <div id="mmFound" style="display:none;flex-direction:column;align-items:center;gap:12px;animation:popupIn 0.4s cubic-bezier(0.36,0.07,0.19,0.97);">
      <div style="font-size:3rem;">‚öî</div>
      <div style="font-family:'Bebas Neue',cursive;font-size:2rem;letter-spacing:3px;color:var(--green);">–°–û–ü–ï–†–ù–ò–ö –ù–ê–ô–î–ï–ù!</div>
      <div id="mmOpponentName" style="font-size:1rem;font-weight:800;color:var(--yellow);letter-spacing:1px;"></div>
      <div style="font-size:0.8rem;color:var(--gray);font-weight:700;">–ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É...</div>
    </div>

    <button onclick="cancelMatchmaking()" style="padding:12px 32px;border-radius:50px;border:2px solid var(--bg3);background:var(--bg2);color:var(--light);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;cursor:pointer;margin-top:8px;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseout="this.style.borderColor='var(--bg3)';this.style.color='var(--light)'">
      ‚úï –û—Ç–º–µ–Ω–∞
    </button>
  </div>
</div>


<!-- Friend Room waiting screen -->
<div id="friendRoomScreen" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:36px 20px;text-align:center;">

    <div style="font-family:'Bebas Neue',cursive;font-size:2.2rem;letter-spacing:4px;background:linear-gradient(135deg,#4ecdc4,#44af69);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">
      –ö–û–ú–ù–ê–¢–ê –î–†–£–ì–ê
    </div>

    <!-- Room code big display -->
    <div style="background:var(--bg2);border:2px solid var(--bg3);border-radius:20px;padding:24px 28px;width:100%;max-width:320px;box-sizing:border-box;">

      <div style="font-size:0.6rem;font-weight:800;letter-spacing:3px;color:var(--gray);text-transform:uppercase;margin-bottom:10px;">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</div>

      <!-- Code itself ‚Äî tap to copy -->
      <div id="frRoomCode"
        onclick="copyRoomCode()"
        title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
        style="font-family:'Bebas Neue',cursive;font-size:3.8rem;letter-spacing:10px;color:var(--yellow);line-height:1;margin-bottom:6px;cursor:pointer;transition:color 0.2s;user-select:all;-webkit-user-select:all;">
        ‚Äî‚Äî
      </div>
      <div style="font-size:0.6rem;color:var(--gray);font-weight:700;margin-bottom:18px;">–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–¥ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>

      <!-- Copy buttons -->
      <button id="frCopyLinkBtn" onclick="copyRoomLink()"
        style="width:100%;padding:13px;background:linear-gradient(135deg,#1a2a4a,#1a3a6b);border:2px solid var(--blue);border-radius:14px;color:#7b9fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;margin-bottom:10px;">
        üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
      </button>
      <button id="frCopyCodeBtn" onclick="copyRoomCode()"
        style="width:100%;padding:13px;background:linear-gradient(135deg,#1a3a20,#1a5c30);border:2px solid var(--green);border-radius:14px;color:var(--green);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;">
        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
      </button>

      <!-- Hint -->
      <div style="margin-top:12px;padding:10px;background:rgba(255,215,0,0.07);border:1px solid rgba(255,215,0,0.2);border-radius:10px;">
        <div style="font-size:0.65rem;font-weight:800;color:var(--yellow);margin-bottom:3px;">üì® –ö–∞–∫ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞?</div>
        <div style="font-size:0.62rem;color:var(--gray);font-weight:700;line-height:1.5;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É —Å—Å—ã–ª–∫—É ‚Äî –æ–Ω –æ—Ç–∫—Ä–æ–µ—Ç –∏ —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥—ë—Ç –≤ –∫–æ–º–Ω–∞—Ç—É. –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é.</div>
      </div>
    </div>

    <div id="frPassRow" style="display:none;width:100%;max-width:320px;box-sizing:border-box;">
      <div style="background:var(--bg2);border:2px solid var(--bg3);border-radius:12px;padding:10px 16px;text-align:center;">
        <div style="font-size:0.6rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:4px;">–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã</div>
        <div id="frPassDisplay" style="font-size:1.1rem;font-weight:800;color:var(--orange);letter-spacing:3px;font-family:'Bebas Neue',cursive;"></div>
      </div>
    </div>

    <!-- Status -->
    <div>
      <div style="display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:6px;">
        <div class="mp-waiting-spinner" style="width:22px;height:22px;border-width:3px;" id="frSpinner"></div>
        <div id="frStatus" style="font-family:'Bebas Neue',cursive;font-size:1.5rem;letter-spacing:2px;color:var(--white);">–û–ñ–ò–î–ê–ï–ú –î–†–£–ì–ê...</div>
      </div>
      <div id="frSubstatus" style="font-size:0.8rem;font-weight:700;color:var(--gray);">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–≥–æ–º</div>
    </div>

    <!-- Players in room -->
    <div style="width:100%;max-width:320px;background:var(--bg2);border:2px solid var(--bg3);border-radius:16px;padding:16px;box-sizing:border-box;">
      <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:12px;">–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:10px;height:10px;border-radius:50%;background:var(--green);flex-shrink:0;"></div>
          <div id="frPlayer1Name" style="font-weight:800;color:var(--white);font-size:0.9rem;flex:1;"></div>
          <div style="font-size:0.65rem;color:var(--gray);font-weight:700;">–•–æ—Å—Ç</div>
        </div>
        <div id="frPlayer2Row" style="display:flex;align-items:center;gap:10px;opacity:0.4;">
          <div id="frP2Dot" style="width:10px;height:10px;border-radius:50%;background:var(--gray);flex-shrink:0;"></div>
          <div id="frPlayer2Name" style="font-weight:800;color:var(--gray);font-size:0.9rem;flex:1;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          <div id="frP2Badge" style="font-size:0.65rem;color:var(--gray);font-weight:700;"></div>
        </div>
      </div>
    </div>

    <!-- Found animation -->
    <div id="frFound" style="display:none;flex-direction:column;align-items:center;gap:10px;animation:popupIn 0.4s cubic-bezier(0.36,0.07,0.19,0.97);">
      <div style="font-size:2.5rem;">‚öî</div>
      <div style="font-family:'Bebas Neue',cursive;font-size:1.8rem;letter-spacing:3px;color:var(--green);">–î–†–£–ì –ü–û–î–ö–õ–Æ–ß–ò–õ–°–Ø!</div>
      <div style="font-size:0.8rem;color:var(--gray);font-weight:700;">–ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É...</div>
    </div>

    <button onclick="cancelFriendRoom()"
      style="padding:11px 28px;border-radius:50px;border:2px solid var(--bg3);background:var(--bg2);color:var(--light);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;transition:all 0.2s;"
      onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'"
      onmouseout="this.style.borderColor='var(--bg3)';this.style.color='var(--light)'">
      ‚úï –û—Ç–º–µ–Ω–∞
    </button>
  </div>
</div>

<!-- Nickname setup overlay (shown after registration) -->
<div class="overlay" id="nicknameOverlay" style="z-index:200;">
  <div class="settings-popup" style="text-align:center;max-width:360px;">
    <div style="font-size:2.5rem;margin-bottom:8px;">üéÆ</div>
    <div class="settings-title" style="margin-bottom:8px;">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º</div>
    <div style="font-size:0.85rem;color:var(--light);font-weight:700;margin-bottom:20px;line-height:1.5;">
      –ù–∏–∫–Ω–µ–π–º –≤–∏–¥–µ–Ω —Å–æ–ø–µ—Ä–Ω–∏–∫–∞–º –≤ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–µ.<br>–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
    </div>
    <input id="nicknameInput" type="text" maxlength="16" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º"
      style="width:100%;padding:14px 18px;background:var(--bg3);border:2px solid var(--bg);border-radius:14px;color:var(--white);font-family:'Nunito',sans-serif;font-size:1rem;font-weight:700;margin-bottom:8px;outline:none;text-align:center;letter-spacing:1px;box-sizing:border-box;"
      oninput="onNicknameInput(this)"
      onkeydown="if(event.key==='Enter') saveNickname()">
    <div id="nicknameHint" style="font-size:0.72rem;color:var(--gray);font-weight:700;min-height:18px;margin-bottom:16px;letter-spacing:0.5px;">2‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _</div>
    <button onclick="saveNickname()"
      style="width:100%;padding:14px;background:linear-gradient(135deg,var(--orange),var(--red));border:none;border-radius:50px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;letter-spacing:1px;margin-bottom:10px;transition:all 0.2s;">
      ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º
    </button>
    <button onclick="skipNickname()"
      style="background:none;border:none;color:var(--gray);font-family:'Nunito',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;padding:6px;text-decoration:underline;text-underline-offset:3px;">
      –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –Ω–∏–∫–Ω–µ–π–º–∞
    </button>
  </div>
</div>

<!-- Settings overlay -->
<div class="overlay" id="settingsOverlay">
  <div class="settings-popup">
    <div class="settings-title">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

    <div class="settings-section">
      <div class="settings-label">üåê –Ø–∑—ã–∫</div>
      <div class="settings-options">
        <button class="settings-option active" onclick="setLang('ru', this)">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
        <button class="settings-option" onclick="setLang('en', this)">üá¨üáß English</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-label">üÉè –†—É–±–∞—à–∫–∏ –∫–∞—Ä—Ç</div>
      <!-- Sub-tabs -->
      <div style="display:flex;gap:0;margin-bottom:12px;border-radius:10px;overflow:hidden;border:2px solid var(--bg3);">
        <button class="back-tab active" onclick="switchBackTab('digit',this)" style="flex:1;padding:7px 4px;background:var(--yellow);color:#2d2200;border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.7rem;cursor:pointer;letter-spacing:0.5px;">üü° –¶–∏—Ñ—Ä—ã</button>
        <button class="back-tab" onclick="switchBackTab('buff',this)" style="flex:1;padding:7px 4px;background:var(--bg3);color:var(--gray);border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.7rem;cursor:pointer;letter-spacing:0.5px;">üü† –ë–∞—Ñ—Ñ—ã</button>
        <button class="back-tab" onclick="switchBackTab('super',this)" style="flex:1;padding:7px 4px;background:var(--bg3);color:var(--gray);border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.7rem;cursor:pointer;letter-spacing:0.5px;">üî¥ –°—É–ø–µ—Ä</button>
      </div>
      <div id="backOptions-digit" class="back-tab-panel settings-options">
        <div class="card-back-preview active" style="background:linear-gradient(135deg,#1e1c2e,#2d2b45);cursor:default;" data-id="dark"></div>
      </div>
      <div id="backOptions-buff" class="back-tab-panel settings-options" style="display:none;">
        <div class="card-back-preview active" style="background:linear-gradient(135deg,#1e1c2e,#2d2b45);cursor:default;" data-id="dark"></div>
      </div>
      <div id="backOptions-super" class="back-tab-panel settings-options" style="display:none;">
        <div class="card-back-preview active" style="background:linear-gradient(135deg,#1e1c2e,#2d2b45);cursor:default;" data-id="dark"></div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-label">üéÆ –°—Ç–æ–ª</div>
      <div class="settings-options" id="boardOptions">
        <div class="board-preview active" style="background:var(--bg2);cursor:default;" data-id="default"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:8px;">
      <button class="popup-btn popup-btn-secondary" onclick="document.getElementById('settingsOverlay').classList.remove('active')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Account overlay -->
<div class="overlay" id="accountOverlay">
  <div class="settings-popup" style="text-align:center;max-width:380px;">

    <!-- AUTH PANEL: login/register -->
    <div id="authPanel">
      <div class="settings-title">üë§ –ê–∫–∫–∞—É–Ω—Ç</div>

      <!-- Tab switcher -->
      <div style="display:flex;gap:0;margin:16px 0 20px;border-radius:12px;overflow:hidden;border:2px solid var(--bg3);">
        <button id="tabLogin" onclick="switchAuthTab('login')"
          style="flex:1;padding:10px;background:var(--orange);color:#fff;border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;letter-spacing:1px;">
          –í–•–û–î
        </button>
        <button id="tabRegister" onclick="switchAuthTab('register')"
          style="flex:1;padding:10px;background:var(--bg3);color:var(--gray);border:none;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;letter-spacing:1px;">
          –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        </button>
      </div>

      <div id="authError" style="color:var(--red);font-size:0.8rem;font-weight:700;min-height:20px;margin-bottom:8px;"></div>

      <input id="authEmail" type="email" placeholder="Email"
        style="width:100%;padding:12px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;margin-bottom:10px;outline:none;">

      <input id="authPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
        style="width:100%;padding:12px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;margin-bottom:10px;outline:none;">

      <input id="authPasswordConfirm" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
        style="width:100%;padding:12px 16px;background:var(--bg3);border:2px solid var(--bg);border-radius:12px;color:var(--white);font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;margin-bottom:10px;outline:none;display:none;">

      <!-- Remember me -->
      <label id="rememberMeRow" style="display:flex;align-items:center;gap:10px;margin-bottom:16px;cursor:pointer;user-select:none;">
        <div id="rememberToggle" onclick="toggleRememberMe()" style="width:42px;height:24px;background:var(--bg3);border-radius:20px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;">
          <div id="rememberThumb" style="position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform 0.2s;"></div>
        </div>
        <span style="font-size:0.82rem;font-weight:700;color:var(--light);">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</span>
      </label>

      <button id="authSubmitBtn" onclick="submitAuth()"
        style="width:100%;padding:14px;background:linear-gradient(135deg,var(--orange),var(--red));border:none;border-radius:50px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;letter-spacing:1px;margin-bottom:10px;">
        –í–û–ô–¢–ò
      </button>

      <button onclick="closeAccountOverlay()"
        style="background:none;border:none;color:var(--gray);font-family:'Nunito',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;padding:4px;">
        –ó–∞–∫—Ä—ã—Ç—å
      </button>
    </div>

    <!-- PROFILE PANEL: shown when logged in -->
    <div id="profilePanel" style="display:none;">
      <div class="settings-title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>

      <div style="background:var(--bg3);border-radius:16px;padding:20px;margin:16px 0;text-align:left;">
        <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:4px;">Email</div>
        <div id="profileEmail" style="font-weight:700;color:var(--white);font-size:0.95rem;margin-bottom:16px;word-break:break-all;"></div>

        <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:4px;">–ù–∏–∫–Ω–µ–π–º</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <div id="profileNickname" style="font-family:'Bebas Neue',cursive;font-size:1.4rem;color:var(--orange);letter-spacing:2px;flex:1;"></div>
          <button onclick="openNicknameOverlay()" style="padding:4px 12px;border-radius:20px;border:1px solid var(--bg3);background:var(--bg3);color:var(--light);font-size:0.7rem;font-weight:800;cursor:pointer;transition:all 0.2s;flex-shrink:0;" onmouseover="this.style.borderColor='var(--yellow)'" onmouseout="this.style.borderColor='var(--bg3)'">‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>

        <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:4px;">–ò–≥—Ä–æ–≤–æ–π ID</div>
        <div id="profileId" style="font-family:'Bebas Neue',cursive;font-size:1.4rem;color:var(--yellow);letter-spacing:3px;margin-bottom:16px;"></div>

        <!-- Crystals -->
        <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#0a0020,#1a0040);border:1px solid #6b00c8;border-radius:12px;padding:10px 16px;margin-bottom:16px;">
          <div style="font-size:1.6rem;">üíé</div>
          <div style="flex:1;">
            <div style="font-size:0.6rem;font-weight:800;letter-spacing:2px;color:#b06aff;text-transform:uppercase;">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
            <div id="profileCrystals" style="font-family:'Bebas Neue',cursive;font-size:1.8rem;color:#d8a0ff;letter-spacing:2px;line-height:1;">0</div>
          </div>
          <button onclick="openCrystalShop()" style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#4361ee,#7b2fff);border:none;color:#fff;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:900;flex-shrink:0;box-shadow:0 0 12px rgba(123,47,255,0.5);">+</button>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
          <div style="background:var(--bg2);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',cursive;font-size:2rem;color:var(--white);" id="profileBattles">0</div>
            <div style="font-size:0.6rem;font-weight:800;letter-spacing:1px;color:var(--gray);text-transform:uppercase;">–ë–∏—Ç–≤</div>
          </div>
          <div style="background:var(--bg2);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',cursive;font-size:2rem;color:var(--green);" id="profileWins">0</div>
            <div style="font-size:0.6rem;font-weight:800;letter-spacing:1px;color:var(--gray);text-transform:uppercase;">–ü–æ–±–µ–¥</div>
          </div>
          <div style="background:var(--bg2);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',cursive;font-size:2rem;color:var(--yellow);" id="profileWinrate">0%</div>
            <div style="font-size:0.6rem;font-weight:800;letter-spacing:1px;color:var(--gray);text-transform:uppercase;">–í–∏–Ω—Ä–µ–π—Ç</div>
          </div>
        </div>

        <!-- XP / Level -->
        <div style="margin-top:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div id="profileLevelBadge" style="font-family:'Bebas Neue',cursive;font-size:1.1rem;background:linear-gradient(135deg,var(--orange),var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px;">–£–†–û–í–ï–ù–¨ 1</div>
            </div>
            <div id="profileXpText" style="font-size:0.7rem;font-weight:800;color:var(--gray);">0 / 100 XP</div>
          </div>
          <div style="height:10px;background:var(--bg);border-radius:50px;overflow:hidden;border:1px solid var(--bg3);">
            <div id="profileXpBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--orange),var(--yellow));border-radius:50px;transition:width 0.5s ease;"></div>
          </div>
          <div id="profileMaxLevel" style="font-size:0.6rem;color:var(--gray);font-weight:700;text-align:center;margin-top:4px;display:none;">üèÜ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;">
        <button onclick="closeAccountOverlay()"
          style="flex:1;padding:12px;background:var(--bg3);border:none;border-radius:50px;color:var(--light);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
        <button onclick="logoutAccount()"
          style="flex:1;padding:12px;background:var(--bg3);border:none;border-radius:50px;color:var(--red);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;">
          –í—ã–π—Ç–∏
        </button>
      </div>
    </div>

  </div>
</div>

<!-- Crystal Shop Overlay -->
<div class="overlay" id="crystalShopOverlay">
  <div style="background:var(--bg2);border-radius:24px;border:2px solid #4361ee;padding:24px 20px;max-width:380px;width:100%;margin:auto;">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:2.5rem;margin-bottom:4px;">üíé</div>
      <div style="font-family:'Bebas Neue',cursive;font-size:1.8rem;letter-spacing:3px;background:linear-gradient(135deg,#4361ee,#7b2fff,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">–ú–ê–ì–ê–ó–ò–ù –ö–†–ò–°–¢–ê–õ–õ–û–í</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-top:6px;">
        <span style="font-size:0.75rem;font-weight:800;color:var(--gray);">–ë–ê–õ–ê–ù–°:</span>
        <span id="shopCrystalBalance" style="font-family:'Bebas Neue',cursive;font-size:1.1rem;color:#d8a0ff;letter-spacing:2px;">0 üíé</span>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
      <button onclick="buyCrystals(100)" style="background:linear-gradient(135deg,#1a1828,#252338);border:2px solid #4361ee;border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;width:100%;text-align:left;">
        <div style="font-size:2rem;">üíé</div>
        <div style="flex:1;">
          <div style="font-family:'Bebas Neue',cursive;font-size:1.3rem;color:#d8a0ff;letter-spacing:2px;">100 –ö–†–ò–°–¢–ê–õ–õ–û–í</div>
          <div style="font-size:0.65rem;font-weight:800;color:var(--gray);">–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä</div>
        </div>
        <div style="font-family:'Bebas Neue',cursive;font-size:1.1rem;color:var(--yellow);background:var(--bg3);padding:6px 12px;border-radius:50px;">$0.99</div>
      </button>
      <button onclick="buyCrystals(500)" style="background:linear-gradient(135deg,#0d1a40,#1a2860);border:2px solid #4361ee;border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;width:100%;text-align:left;position:relative;">
        <div style="position:absolute;top:-8px;right:12px;background:var(--orange);color:#fff;font-size:0.55rem;font-weight:800;padding:2px 8px;border-radius:50px;letter-spacing:1px;">–ü–û–ü–£–õ–Ø–†–ù–û–ï</div>
        <div style="font-size:2rem;">üíéüíé</div>
        <div style="flex:1;">
          <div style="font-family:'Bebas Neue',cursive;font-size:1.3rem;color:#a0c0ff;letter-spacing:2px;">500 –ö–†–ò–°–¢–ê–õ–õ–û–í</div>
          <div style="font-size:0.65rem;font-weight:800;color:var(--gray);">–•–≤–∞—Ç–∏—Ç –Ω–∞ –ü—Ä–µ–º–∏—É–º –ë–ü</div>
        </div>
        <div style="font-family:'Bebas Neue',cursive;font-size:1.1rem;color:var(--yellow);background:var(--bg3);padding:6px 12px;border-radius:50px;">$3.99</div>
      </button>
      <button onclick="buyCrystals(1200)" style="background:linear-gradient(135deg,#1a0a30,#300060);border:2px solid #7b2fff;border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;width:100%;text-align:left;position:relative;">
        <div style="position:absolute;top:-8px;right:12px;background:linear-gradient(135deg,#7b2fff,#c084fc);color:#fff;font-size:0.55rem;font-weight:800;padding:2px 8px;border-radius:50px;letter-spacing:1px;">–í–´–ì–û–î–ù–û +20%</div>
        <div style="font-size:2rem;">üíéüíéüíé</div>
        <div style="flex:1;">
          <div style="font-family:'Bebas Neue',cursive;font-size:1.3rem;color:#c084fc;letter-spacing:2px;">1200 –ö–†–ò–°–¢–ê–õ–õ–û–í</div>
          <div style="font-size:0.65rem;font-weight:800;color:var(--gray);">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</div>
        </div>
        <div style="font-family:'Bebas Neue',cursive;font-size:1.1rem;color:var(--yellow);background:var(--bg3);padding:6px 12px;border-radius:50px;">$7.99</div>
      </button>
    </div>
    <div style="font-size:0.6rem;color:var(--gray);text-align:center;margin-bottom:14px;font-weight:700;">üîí –î–µ–º–æ-–≤–µ—Ä—Å–∏—è. –ü–æ–∫—É–ø–∫–∏ –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ.</div>
    <button onclick="closeCrystalShop()" style="width:100%;padding:12px;background:var(--bg3);border:none;border-radius:50px;color:var(--light);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.9rem;cursor:pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- Battlepass overlay -->
<div class="overlay" id="battlepassOverlay" style="align-items:flex-start;overflow-y:auto;padding:16px 0;">
  <div style="background:var(--bg2);border-radius:24px;border:2px solid var(--bg3);padding:20px;width:calc(100vw - 32px);max-width:600px;margin:auto;">

    <!-- Header -->
    <div style="text-align:center;margin-bottom:14px;">
      <div style="font-family:'Bebas Neue',cursive;font-size:2rem;letter-spacing:4px;background:linear-gradient(135deg,#4361ee,#7b2fff,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">‚ö° –ë–ê–¢–õ–ü–ê–°–°</div>
      <div style="font-size:0.65rem;font-weight:800;letter-spacing:2px;color:var(--gray);">–°–ï–ó–û–ù 1 ‚Ä¢ 10 –£–†–û–í–ù–ï–ô</div>
    </div>

    <!-- XP Progress -->
    <div style="background:var(--bg3);border-radius:12px;padding:10px 14px;margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <span style="font-size:0.65rem;font-weight:800;color:var(--light);letter-spacing:1px;">–ü–†–û–ì–†–ï–°–°</span>
        <span id="bpLevelText" style="font-size:0.65rem;font-weight:800;color:var(--yellow);"></span>
      </div>
      <div style="height:7px;background:var(--bg);border-radius:50px;overflow:hidden;">
        <div id="bpProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4361ee,#7b2fff);border-radius:50px;transition:width 0.5s;"></div>
      </div>
    </div>

    <!-- Premium buy -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;background:linear-gradient(135deg,rgba(67,97,238,0.12),rgba(123,47,255,0.18));border:1px solid #4361ee;border-radius:12px;padding:9px 14px;">
      <div>
        <div style="font-size:0.6rem;font-weight:800;letter-spacing:2px;color:#c084fc;">–ü–†–ï–ú–ò–£–ú –í–ï–¢–ö–ê</div>
        <div id="bpPremiumLabel" style="font-size:0.75rem;font-weight:800;color:var(--white);">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∏–∂–Ω–∏–π —Ä—è–¥ –Ω–∞–≥—Ä–∞–¥</div>
      </div>
      <button id="bpBuyBtn" onclick="buyBattlepass()" style="padding:7px 16px;background:linear-gradient(135deg,#4361ee,#7b2fff);border:none;border-radius:50px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:0.75rem;cursor:pointer;white-space:nowrap;">üíé 500</button>
    </div>

    <!-- Track labels + hint -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:4px;">
        <div style="width:8px;height:8px;border-radius:50%;background:var(--green);"></div>
        <span style="font-size:0.6rem;font-weight:800;color:var(--green);">–ë–ï–°–ü–õ–ê–¢–ù–û</span>
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <div style="width:8px;height:8px;border-radius:50%;background:#7b2fff;"></div>
        <span style="font-size:0.6rem;font-weight:800;color:#b06aff;">–ü–†–ï–ú–ò–£–ú</span>
      </div>
      <span style="margin-left:auto;font-size:0.6rem;color:var(--gray);font-weight:700;opacity:0.7;">‚Üê —Å–≤–∞–π–ø ‚Üí</span>
    </div>

    <!-- Scroll area -->
    <div class="bp-scroll-wrap">
      <div id="bpFreeRow"  class="bp-row"></div>
      <div id="bpLevelRow" class="bp-row bp-level-row"></div>
      <div id="bpPremRow"  class="bp-row"></div>
    </div>

    <div style="text-align:center;margin-top:16px;">
      <button onclick="document.getElementById('battlepassOverlay').classList.remove('active')"
        style="padding:10px 32px;background:var(--bg3);border:none;border-radius:50px;color:var(--light);font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;cursor:pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>
<div id="gameScreen" class="screen">
  <div class="game-header">
    <div class="header-title">‚öî –ß–ò–°–õ–û–ë–ò–¢–í–ê</div>
    <div id="diffBadge" class="diff-badge">EASY</div>
    <button onclick="goIntro()" style="background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem;" title="Menu">‚úï</button>
  </div>
  <div class="score-bars">
    <div class="score-side">
      <div class="score-name">üß† –ò–ò</div>
      <div class="score-pts" id="aiScore">0</div>
      <div class="score-cards-count" id="aiCardCount">‚Äî</div>
    </div>
    <div class="vs-badge">VS</div>
    <div class="score-side right">
      <div class="score-name">üë§ –í–´</div>
      <div class="score-pts" id="playerScore">0</div>
      <div class="score-cards-count" id="playerCardCount">‚Äî</div>
    </div>
  </div>
  <div class="arena">
    <div class="ai-zone">
      <div class="hand-header">
        <div class="zone-label">üß† –†—É–∫–∞ –ò–ò</div>
        <div class="hand-count" id="aiHandCount">0 –∫–∞—Ä—Ç</div>
      </div>
      <div class="ai-hand-display" id="aiHandDisplay"></div>
    </div>
    <div class="battle-area">
      <div class="side-panel side-left">
        <div class="side-label">–°—Ç–æ–ø–∫–∞ –ò–ò</div>
        <div class="win-stack-visual" id="aiWinStackVisual"></div>
        <div class="side-count" id="aiWinCount">0 –∫–∞—Ä—Ç</div>
        <div style="height:1px;width:100%;background:var(--bg3);margin:6px 0;"></div>
        <div class="side-label">–í–∞—à–∞ —Å—Ç–æ–ø–∫–∞</div>
        <div class="win-stack-visual" id="playerWinStackVisual"></div>
        <div class="side-count" id="playerWinCount">0 –∫–∞—Ä—Ç</div>
      </div>
      <div class="battle-table" id="battleTable">
        <div class="superbattle-label" id="superBattleLabel">‚ö° –°–£–ü–ï–†–ë–ò–¢–í–ê ‚ö°</div>
        <div class="table-played-row" id="aiPlayedRow"></div>
        <div class="table-row" id="aiTableRow">
          <div class="table-slot" id="aiMainSlot"><span class="table-slot-label">AI</span></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;justify-content:center;">
          <div class="slot-vs">‚öî</div>
        </div>
        <div class="table-row" id="playerTableRow">
          <div class="table-slot" id="playerMainSlot"><span class="table-slot-label">YOU</span></div>
        </div>
        <div class="table-played-row" id="playerPlayedRow"></div>
      </div>
      <div class="side-panel side-right">
        <div class="side-label">–ö–æ–ª–æ–¥—ã</div>
        <div class="decks-visual">
          <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
            <div style="font-size:0.72rem;font-weight:800;letter-spacing:1px;color:var(--yellow);text-align:center;text-transform:uppercase;">–ö–æ–ª–æ–¥–∞<br>—Ü–∏—Ñ—Ä</div>
            <div class="deck-pile" id="digitDeckVisual"></div>
            <div id="digitDeckCount" style="font-size:1.8rem;font-weight:800;color:var(--light);text-align:center;margin-top:4px;font-family:'Bebas Neue',cursive;line-height:1;">0</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:3px;margin-top:10px;">
            <div style="font-size:0.68rem;font-weight:800;letter-spacing:0.5px;color:var(--red);text-align:center;text-transform:uppercase;">–ö–æ–ª–æ–¥–∞ –∫–∞—Ä—Ç<br>—É—Å–∏–ª–µ–Ω–∏–π</div>
            <div style="width:16px;height:16px;border-radius:50%;background:conic-gradient(#ff8c00 0deg 180deg,#e63946 180deg 360deg);margin:2px auto;"></div>
            <div class="deck-pile" id="enhanceDeckVisual"></div>
            <div id="enhanceDeckCount" style="font-size:1.8rem;font-weight:800;color:var(--light);text-align:center;margin-top:4px;font-family:'Bebas Neue',cursive;line-height:1;">0</div>
          </div>
        </div>
      </div>
    </div>
    <div class="player-zone">
      <div class="hand-header">
        <div class="zone-label">üë§ –í–∞—à–∞ —Ä—É–∫–∞</div>
        <div class="hand-count" id="playerHandCount">0 –∫–∞—Ä—Ç</div>
      </div>
      <div class="player-hand" id="playerHand"></div>
    </div>
  </div>
  <div class="battle-log" id="battleLog"></div>
  <div class="action-area">
    <div class="status-msg" id="statusMsg">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Ü–∏—Ñ—Ä—ã</div>
  </div>
</div>

<div id="endScreen" class="screen">
  <div class="end-icon" id="endIcon">üèÜ</div>
  <div class="end-result" id="endResult">–ü–û–ë–ï–î–ê</div>
  <div style="color:var(--light);font-size:1rem;font-weight:700;margin-bottom:8px;" id="endSub"></div>
  <div class="score-breakdown" id="scoreBreakdown"></div>
  <button class="play-again-btn" onclick="goIntro()">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>


<div class="overlay" id="roundResultOverlay" style="background:rgba(0,0,0,0.45);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);">
  <div class="popup" style="min-width:280px;text-align:center;background:rgba(18,17,28,0.82);backdrop-filter:blur(16px);border:2px solid var(--bg3);">
    <div id="rrRound" style="font-size:0.75rem;font-weight:800;letter-spacing:3px;text-transform:uppercase;color:var(--gray);margin-bottom:6px;">–†–ê–£–ù–î 1</div>
    <div id="rrResult" style="font-family:'Bebas Neue',cursive;font-size:3rem;line-height:1;margin-bottom:4px;">–ü–û–ë–ï–î–ê!</div>
    <div id="rrPoints" style="font-size:1rem;font-weight:800;color:var(--gray);margin-bottom:16px;"></div>
    <div id="rrBuffSection" style="display:none;">
      <div style="font-size:0.75rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--gray);margin-bottom:8px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ</div>
      <div class="popup-cards" id="rrBuffCards"></div>
      <div style="margin:8px 0 4px;">
        <div id="rrTimerBar" style="height:4px;border-radius:4px;background:var(--yellow);width:100%;transition:width 0.1s linear;"></div>
      </div>
      <button class="popup-btn popup-btn-secondary" style="margin-top:8px;" onclick="rrSkip()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
    <div id="rrWinSection" style="display:none;">
      <div id="rrSuperSection" style="display:none;">
        <div style="font-size:0.75rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--gray);margin-bottom:8px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É–ø–µ—Ä–∫–∞—Ä—Ç—É?</div>
        <div class="popup-cards" id="rrSuperCards"></div>
      </div>
      <div style="margin:8px 0 4px;">
        <div id="rrWinTimerBar" style="height:4px;border-radius:4px;background:var(--yellow);width:100%;transition:width 0.1s linear;"></div>
      </div>
      <button class="popup-btn popup-btn-secondary" style="margin-top:8px;" onclick="rrContinue()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="overlay" id="chooseOverlay">
  <div class="popup">
    <div class="popup-title" id="chooseTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É</div>
    <div class="popup-body" id="chooseBody"></div>
    <div class="popup-cards" id="chooseCards"></div>
    <div style="margin:10px 0 4px;">
      <div id="chooseTimerBar" style="height:4px;border-radius:4px;background:var(--yellow);width:100%;transition:width 0.1s linear;"></div>
    </div>
    <div><button class="popup-btn popup-btn-secondary" onclick="cancelChoose()">–û—Ç–º–µ–Ω–∞</button></div>
  </div>
</div>

<div class="overlay" id="peakOverlay">
  <div class="popup" style="max-width:340px;">
    <div class="popup-title" style="background:linear-gradient(135deg,#4361ee,#7b9fff);-webkit-background-clip:text;background-clip:text;">üîÆ –í–µ—Ä—à–∏–Ω–∞</div>
    <div class="popup-body">–û—Ç–∫—É–¥–∞ –≤–∑—è—Ç—å –∫–∞—Ä—Ç—É?</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
      <button class="btn-peak-source" id="peakBtnDigit" onclick="peakChoose('digit')">üü° –ö–æ–ª–æ–¥–∞ —Ü–∏—Ñ—Ä</button>
      <button class="btn-peak-source" id="peakBtnEnhance" onclick="peakChoose('enhance')">üÉè –ö–æ–ª–æ–¥–∞ –∫–∞—Ä—Ç —É—Å–∏–ª–µ–Ω–∏–π</button>
      <button class="btn-peak-source" id="peakBtnOpp" onclick="peakChoose('opp_stack')">‚öî –°—Ç–æ–ø–∫–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</button>
    </div>
    <button class="popup-btn popup-btn-secondary" onclick="cancelPeak()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div class="overlay" id="swapOverlay">
  <div class="popup" style="max-width:340px;">
    <div class="popup-title" style="background:linear-gradient(135deg,var(--orange),var(--yellow));-webkit-background-clip:text;background-clip:text;">üîÑ –ó–∞–º–µ–Ω–∞</div>
    <div class="popup-body">–ù–∞ —Å—Ç–æ–ª–µ: <strong id="swapYourVal" style="color:var(--yellow)">?</strong> (–≤—ã) vs <strong id="swapAIVal" style="color:var(--red)">?</strong> (–ò–ò)<br>–ö–∞–∫—É—é –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ –∑–∞–º–µ–Ω–∏—Ç—å?</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
      <button class="btn-peak-source" style="border-color:var(--yellow);color:var(--yellow);background:rgba(255,215,0,0.1);" onclick="swapChoose('hand')">üü° –ó–∞–º–µ–Ω–∏—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç—É</button>
      <button class="btn-peak-source" id="swapBtnOpp" style="border-color:var(--red);color:var(--red);background:rgba(230,57,70,0.1);" onclick="swapChoose('opp')">üî¥ –ó–∞–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É –ò–ò</button>
    </div>
    <button class="popup-btn popup-btn-secondary" onclick="cancelSwap()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div class="overlay" id="superBattleOverlay">
  <div class="popup">
    <div class="popup-title" style="background:linear-gradient(135deg,var(--orange),var(--yellow));-webkit-background-clip:text;background-clip:text;">‚ö° –°–£–ü–ï–†–ë–ò–¢–í–ê!</div>
    <div class="popup-body">–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã! –û–±–∞ –∏–≥—Ä–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∫–ª–∞–¥—É—Ç –ø–æ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–µ –ª–∏—Ü–æ–º –≤–Ω–∏–∑, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä—ã–≤–∞—é—Ç. –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ —Ä–∞–≤–Ω–æ ‚Äî –ø–æ–≤—Ç–æ—Ä—è—é—Ç. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç <strong>–≤—Å–µ</strong> –∫–∞—Ä—Ç—ã —Ä–∞—É–Ω–¥–∞!</div>
    <button class="popup-btn popup-btn-primary" onclick="closeSuperBattle()">–ü–æ–Ω—è—Ç–Ω–æ!</button>
  </div>
</div>

<div class="overlay" id="confirmOverlay">
  <div class="popup">
    <div class="popup-title" id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</div>
    <div class="popup-body" id="confirmBody"></div>
    <div>
      <button class="popup-btn popup-btn-primary" id="confirmOk" onclick="confirmOk()">–°–≤–æ—è –∫–∞—Ä—Ç–∞</button>
      <button class="popup-btn popup-btn-secondary" onclick="cancelConfirm()">–ö–∞—Ä—Ç–∞ –ò–ò</button>
    </div>
  </div>
</div>

<script>
window.onerror = function(msg,src,line,col,err){console.error('Error line '+line+': '+msg);};

// ‚îÄ‚îÄ Round Result Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _rrTimer = null;
let _rrCallback = null;

function _clearRRTimer() {
  if (_rrTimer) { clearInterval(_rrTimer); _rrTimer = null; }
}

function _startRRTimer(barId, duration, onDone) {
  _clearRRTimer();
  const bar = document.getElementById(barId);
  if (bar) { bar.style.width = '100%'; bar.style.background = 'var(--yellow)'; }
  const start = performance.now();
  _rrTimer = setInterval(() => {
    const elapsed = performance.now() - start;
    const pct = Math.max(0, 1 - elapsed / duration);
    if (bar) {
      bar.style.width = (pct * 100) + '%';
      bar.style.background = pct > 0.4 ? 'var(--yellow)' : pct > 0.2 ? 'var(--orange)' : 'var(--red)';
    }
    if (elapsed >= duration) { _clearRRTimer(); onDone(); }
  }, 100);
}

function showRoundResult(resultType, roundPts, availableBuffs, onBuffChosen, onDone) {
  // resultType: 'win'|'lose'|'draw'
  _rrCallback = onDone;
  const overlay = document.getElementById('roundResultOverlay');
  const rrRound = document.getElementById('rrRound');
  const rrResult = document.getElementById('rrResult');
  const rrPoints = document.getElementById('rrPoints');
  const rrBuff = document.getElementById('rrBuffSection');
  const rrWin = document.getElementById('rrWinSection');

  rrRound.textContent = '–†–ê–£–ù–î ' + G.round;

  if (resultType === 'win') {
    rrResult.textContent = '–ü–û–ë–ï–î–ê!';
    rrResult.style.color = 'var(--green)';
    rrPoints.textContent = roundPts > 0 ? `+${roundPts} –æ—á–∫–æ–≤ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ` : '';
    rrBuff.style.display = 'none';
    rrWin.style.display = '';

    // availableBuffs here = supers for win case
    const rrSuperSection = document.getElementById('rrSuperSection');
    const rrSuperCards = document.getElementById('rrSuperCards');
    if (availableBuffs && availableBuffs.length > 0 && rrSuperSection && rrSuperCards) {
      rrSuperSection.style.display = '';
      rrSuperCards.innerHTML = '';
      availableBuffs.forEach(item => {
        const card = item.card;
        const div = document.createElement('div');
        div.className = `popup-card-select game-card ${card.type}`;
        div.style.cssText = 'width:96px;height:134px;cursor:pointer;';
        div.innerHTML = `<div class="card-name" style="font-size:0.5rem;font-weight:800;text-align:center;padding:4px;line-height:1.3;">${card.nameShort || '?'}</div>`;
        if (card.desc) div.title = card.desc;
        div.onclick = () => {
          _clearRRTimer();
          document.getElementById('roundResultOverlay').classList.remove('active');
          if (typeof onBuffChosen === 'function') onBuffChosen(item);
        };
        rrSuperCards.appendChild(div);
      });
    } else if (rrSuperSection) {
      rrSuperSection.style.display = 'none';
    }

    overlay.classList.add('active');
    _startRRTimer('rrWinTimerBar', 7000, () => rrContinue());
  } else if (resultType === 'draw') {
    rrResult.textContent = '–ù–ò–ß–¨–Ø';
    rrResult.style.color = 'var(--yellow)';
    rrPoints.textContent = '–ö–∞—Ä—Ç—ã –¥–µ–ª—è—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É';
    rrBuff.style.display = 'none';
    rrWin.style.display = '';
    overlay.classList.add('active');
    _startRRTimer('rrWinTimerBar', 7000, () => rrContinue());
  } else {
    // lose
    rrResult.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
    rrResult.style.color = 'var(--red)';
    rrPoints.textContent = roundPts > 0 ? `–ò–ò –ø–æ–ª—É—á–∞–µ—Ç ${roundPts} –æ—á–∫–æ–≤` : '';

    if (availableBuffs && availableBuffs.length > 0) {
      rrBuff.style.display = '';
      rrWin.style.display = 'none';
      // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç—ã —É—Å–∏–ª–µ–Ω–∏–π
      const container = document.getElementById('rrBuffCards');
      container.innerHTML = '';
      availableBuffs.forEach(item => {
        const card = item.card;
        const type = ['digit','buff','super'].includes(card.type) ? card.type : 'buff';
        const div = document.createElement('div');
        div.className = `popup-card-select game-card ${type}`;
        div.style.cssText = 'width:96px;height:134px;cursor:pointer;';
        if (card.type === 'digit' && card.value) {
          div.innerHTML = `<div class="card-value">${card.value}</div>`;
        } else {
          div.innerHTML = `<div class="card-name" style="font-size:0.5rem;font-weight:800;text-align:center;padding:4px;line-height:1.3;">${card.nameShort || '?'}</div>`;
        }
        if (card.desc) div.title = card.desc;
        div.onclick = () => {
          _clearRRTimer();
          document.getElementById('roundResultOverlay').classList.remove('active');
          if (typeof onBuffChosen === 'function') onBuffChosen(item);
        };
        container.appendChild(div);
      });
      overlay.classList.add('active');
      _startRRTimer('rrTimerBar', 7000, () => rrSkip());
    } else {
      // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç ‚Äî —Å—Ä–∞–∑—É win-section (–ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä–∞–∂–µ–Ω–∏–µ)
      rrBuff.style.display = 'none';
      rrWin.style.display = '';
      overlay.classList.add('active');
      _startRRTimer('rrWinTimerBar', 7000, () => rrContinue());
    }
  }
}

function rrSkip() {
  _clearRRTimer();
  document.getElementById('roundResultOverlay').classList.remove('active');
  if (typeof _rrCallback === 'function') { const cb = _rrCallback; _rrCallback = null; cb(null); }
}

function rrContinue() {
  _clearRRTimer();
  document.getElementById('roundResultOverlay').classList.remove('active');
  // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å—É–ø–µ—Ä–∫–∞—Ä—Ç –Ω–∞ —Å–ª—É—á–∞–π —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
  const s = document.getElementById('rrSuperSection');
  if (s) s.style.display = 'none';
  if (typeof _rrCallback === 'function') { const cb = _rrCallback; _rrCallback = null; cb(null); }
}


function flyCardFromRect(card, fromRect, targetSlotId, onComplete) {
  const targetEl = document.getElementById(targetSlotId);
  if (!targetEl) { onComplete(); return; }
  const toRect = targetEl.getBoundingClientRect();

  // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (—Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã)
  const sx = fromRect.left + fromRect.width / 2;
  const sy = fromRect.top + fromRect.height / 2;
  // –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (—Ü–µ–Ω—Ç—Ä —Å–ª–æ—Ç–∞)
  const ex = toRect.left + toRect.width / 2;
  const ey = toRect.top + toRect.height / 2;

  const w = fromRect.width;
  const h = fromRect.height;

  const clone = document.createElement('div');
  clone.className = `flying-card ${card.type}`;
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã
  clone.style.width = w + 'px';
  clone.style.height = h + 'px';
  clone.style.left = (sx - w/2) + 'px';
  clone.style.top = (sy - h/2) + 'px';
  clone.style.display = 'flex';
  clone.style.alignItems = 'center';
  clone.style.justifyContent = 'center';
  clone.style.flexDirection = 'column';

  if (card.type === 'digit') {
    clone.innerHTML = `<div style="font-family:'Bebas Neue',cursive;font-size:4rem;line-height:1;color:#2d2200;">${card.value}</div>`;
  } else {
    const icon = card.type === 'buff' ? 'üü†' : 'üî¥';
    clone.innerHTML = `<div style="font-size:0.9rem;">${icon}</div><div style="font-size:0.85rem;font-weight:800;text-align:center;padding:0 4px;">${card.nameShort}</div>`;
  }
  document.body.appendChild(clone);

  const dx = ex - sx;
  const dy = ey - sy;
  const duration = 420;
  const startTime = performance.now();

  function step(now) {
    const raw = Math.min((now - startTime) / duration, 1);
    // cubic ease-in-out
    const t = raw < 0.5 ? 4*raw*raw*raw : 1-Math.pow(-2*raw+2,3)/2;
    const linearT = raw; // –¥–ª—è –¥—É–≥–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–Ω–µ–π–Ω—ã–π t

    const x = dx * t;
    const y = dy * t - Math.sin(Math.PI * linearT) * 80;
    const scale = 1 + Math.sin(Math.PI * linearT) * 0.12;
    const rot = Math.sin(Math.PI * linearT) * 10 * (dx >= 0 ? 1 : -1);

    clone.style.transform = `translate(${x}px, ${y}px) scale(${scale}) rotate(${rot}deg)`;
    clone.style.opacity = raw > 0.75 ? String(1 - (raw - 0.75) / 0.25) : '1';

    if (raw < 1) {
      requestAnimationFrame(step);
    } else {
      if (clone.parentNode) clone.parentNode.removeChild(clone);
      onComplete();
    }
  }
  requestAnimationFrame(step);
}

function flyCardToSlot(card, fromEl, targetSlotId, onComplete) {
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
  const fromRect = fromEl.getBoundingClientRect();
  const targetEl = document.getElementById(targetSlotId);
  if (!targetEl) { onComplete(); return; }
  const toRect = targetEl.getBoundingClientRect();

  // –°–æ–∑–¥–∞—ë–º –∫–ª–æ–Ω-–∫–∞—Ä—Ç—É
  const clone = document.createElement('div');
  clone.className = `flying-card ${card.type}`;
  clone.style.cssText = `
    width: ${fromRect.width}px;
    height: ${fromRect.height}px;
    left: ${fromRect.left}px;
    top: ${fromRect.top}px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  `;

  // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç—ã
  if (card.type === 'digit') {
    clone.innerHTML = `<div style="font-family:'Bebas Neue',cursive;font-size:4.5rem;line-height:1;color:#2d2200;">${card.value}</div>`;
  } else {
    const icon = card.type === 'buff' ? 'üü†' : 'üî¥';
    clone.innerHTML = `<div style="font-size:0.8rem;opacity:0.8;">${icon}</div><div style="font-size:0.9rem;font-weight:800;text-align:center;padding:0 6px;">${card.nameShort}</div>`;
  }

  document.body.appendChild(clone);

  // –¶–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è ‚Äî —Ü–µ–Ω—Ç—Ä —Å–ª–æ—Ç–∞
  const targetCX = toRect.left + toRect.width / 2 - fromRect.width / 2;
  const targetCY = toRect.top + toRect.height / 2 - fromRect.height / 2;

  // –ê–Ω–∏–º–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ requestAnimationFrame
  const startX = fromRect.left;
  const startY = fromRect.top;
  const dx = targetCX - startX;
  const dy = targetCY - startY;
  const duration = 380; // ms
  const startTime = performance.now();

  function step(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / duration, 1);
    // Easing ‚Äî ease-in-out + –Ω–µ–±–æ–ª—å—à–∞—è –¥—É–≥–∞
    const ease = t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
    const arc = Math.sin(Math.PI * t) * -40; // –¥—É–≥–∞ –≤–≤–µ—Ä—Ö

    const x = startX + dx * ease;
    const y = startY + dy * ease + arc;
    const scale = 1 + Math.sin(Math.PI * t) * 0.08;
    const rot = Math.sin(Math.PI * t) * (dx > 0 ? 8 : -8);

    clone.style.transform = `translate(${x - startX}px, ${y - startY}px) scale(${scale}) rotate(${rot}deg)`;
    clone.style.opacity = t > 0.85 ? (1 - (t - 0.85) / 0.15) : '1';

    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      document.body.removeChild(clone);
      onComplete();
    }
  }
  requestAnimationFrame(step);
}


// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentLang = 'ru';
let currentBoardTheme = 'default';
let currentBackTab = 'digit';

// Per-type card back selections
const currentCardBacks = { digit: 'dark', buff: 'dark', super: 'dark' };

const CARD_BACK_STYLES = {
  dark:   'linear-gradient(135deg,#1e1c2e,#2d2b45)',
  blue:   'linear-gradient(135deg,#0a2463,#1e6fc5)',
  green:  'linear-gradient(135deg,#0a3d0a,#1a6b1a)',
  red:    'linear-gradient(135deg,#3d0a0a,#8b0000)',
  gold:   'linear-gradient(135deg,#5a4000,#c8a900)',
  purple: 'linear-gradient(135deg,#2a0050,#6b00c8)',
};

const BOARD_THEMES = {
  default: { bg: 'var(--bg2)', border: 'var(--bg3)' },
  forest:  { bg: 'linear-gradient(135deg,#0d2b0d,#1a4a1a)', border: '#2d6b2d' },
  space:   { bg: 'linear-gradient(135deg,#050520,#0a0a3a)', border: '#1a1a5a' },
  fire:    { bg: 'linear-gradient(135deg,#2a0500,#6b1a00)', border: '#8b2200' },
};

function openSettingsPopup() {
  renderSettingsBacksAndBoards();
  document.getElementById('settingsOverlay').classList.add('active');
}

function renderSettingsBacksAndBoards() {
  const unlocked = currentUser ? (currentUser.unlockedBacks || {}) : {};
  const unlockedBoards = currentUser ? (currentUser.unlockedBoards || []) : [];

  ['digit','buff','super'].forEach(type => {
    const container = document.getElementById('backOptions-' + type);
    if (!container) return;
    const ids = ['dark', ...(unlocked[type] || [])];
    container.innerHTML = ids.map(id => {
      const styles = {
        dark:   'linear-gradient(135deg,#1e1c2e,#2d2b45)',
        blue:   'linear-gradient(135deg,#0a2463,#1e6fc5)',
        green:  'linear-gradient(135deg,#0a3d0a,#1a6b1a)',
        red:    'linear-gradient(135deg,#3d0a0a,#8b0000)',
        gold:   'linear-gradient(135deg,#5a4000,#c8a900)',
        purple: 'linear-gradient(135deg,#2a0050,#6b00c8)',
      };
      const active = (currentCardBacks[type] === id) ? ' active' : '';
      return `<div class="card-back-preview${active}" onclick="setCardBack('${type}','${id}',this)" style="background:${styles[id]};" data-id="${id}"></div>`;
    }).join('');
  });

  // Board options
  const boardContainer = document.getElementById('boardOptions');
  if (boardContainer) {
    const allBoards = [
      { id:'default', bg:'var(--bg2)' },
      { id:'forest',  bg:'linear-gradient(135deg,#0d2b0d,#1a4a1a)' },
      { id:'space',   bg:'linear-gradient(135deg,#050520,#0a0a3a)' },
      { id:'fire',    bg:'linear-gradient(135deg,#2a0500,#6b1a00)' },
    ];
    boardContainer.innerHTML = allBoards.map(b => {
      const isUnlocked = b.id === 'default' || unlockedBoards.includes(b.id);
      const active = (currentBoardTheme === b.id) ? ' active' : '';
      if (isUnlocked) {
        return `<div class="board-preview${active}" onclick="setBoardTheme('${b.id}',this)" style="background:${b.bg};" data-id="${b.id}"></div>`;
      } else {
        return `<div class="board-preview" style="background:${b.bg};opacity:0.3;cursor:not-allowed;position:relative;" title="–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±–∞—Ç–ª–ø–∞—Å—Å–µ">
          <span style="font-size:0.8rem;">üîí</span>
        </div>`;
      }
    }).join('');
  }
}

// ============================================================
// ACCOUNT SYSTEM
// ============================================================

let currentUser = null;
let authMode = 'login';

// XP thresholds per level (index 0 = level 1 requires 100 xp total, etc.)
const LEVEL_XP = [0, 100, 300, 600, 1000, 1500, 2200, 3100, 4200, 5500, 7000];
// LEVEL_XP[n] = total XP needed to reach level n+1
// Level 1 = 0 xp, Level 2 = 100, Level 3 = 300 ... Level 10 = 5500, max = 7000
const MAX_LEVEL = 10;

function getLevelInfo(xp) {
  let level = 1;
  for (let i = 1; i <= MAX_LEVEL; i++) {
    if (xp >= LEVEL_XP[i]) level = i + 1;
    else break;
  }
  level = Math.min(level, MAX_LEVEL);
  const isMax = level === MAX_LEVEL;
  const xpForThis  = LEVEL_XP[level - 1];
  const xpForNext  = isMax ? LEVEL_XP[MAX_LEVEL] : LEVEL_XP[level];
  const xpInLevel  = xp - xpForThis;
  const xpNeeded   = xpForNext - xpForThis;
  const pct        = isMax ? 100 : Math.min(100, Math.round((xpInLevel / xpNeeded) * 100));
  return { level, isMax, xpInLevel, xpNeeded, pct, totalXp: xp };
}

function generateUserId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = 'NBC-';
  for (let i = 0; i < 8; i++) id += chars[Math.floor(Math.random() * chars.length)];
  return id;
}

function storageKey(email) {
  return 'user:' + email.toLowerCase().trim();
}

async function loadUser(email) {
  try {
    const res = await window.storage.get(storageKey(email));
    return res ? JSON.parse(res.value) : null;
  } catch { return null; }
}

async function saveUser(user) {
  try {
    await window.storage.set(storageKey(user.email), JSON.stringify(user));
  } catch (e) { console.error('Save failed', e); }
}

function switchAuthTab(mode) {
  authMode = mode;
  const isLogin = mode === 'login';
  document.getElementById('tabLogin').style.background = isLogin ? 'var(--orange)' : 'var(--bg3)';
  document.getElementById('tabLogin').style.color = isLogin ? '#fff' : 'var(--gray)';
  document.getElementById('tabRegister').style.background = !isLogin ? 'var(--orange)' : 'var(--bg3)';
  document.getElementById('tabRegister').style.color = !isLogin ? '#fff' : 'var(--gray)';
  document.getElementById('authPasswordConfirm').style.display = isLogin ? 'none' : '';
  document.getElementById('authSubmitBtn').textContent = isLogin ? '–í–û–ô–¢–ò' : '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø';
  document.getElementById('authError').textContent = '';
  // Remember me only relevant on login
  const rmRow = document.getElementById('rememberMeRow');
  if (rmRow) rmRow.style.display = isLogin ? 'flex' : 'none';
}

// ‚îÄ‚îÄ Remember Me toggle ‚îÄ‚îÄ
let _rememberMe = true;

function toggleRememberMe() {
  _rememberMe = !_rememberMe;
  const toggle = document.getElementById('rememberToggle');
  const thumb  = document.getElementById('rememberThumb');
  if (toggle) toggle.style.background = _rememberMe ? 'var(--orange)' : 'var(--bg3)';
  if (thumb)  thumb.style.transform   = _rememberMe ? 'translateX(18px)' : 'translateX(0)';
}

// ‚îÄ‚îÄ Session persistence via localStorage ‚îÄ‚îÄ
const SESSION_KEY = 'chislobitva_session';

function saveSession(email) {
  try { localStorage.setItem(SESSION_KEY, email); } catch(e) {}
}

function clearSession() {
  try { localStorage.removeItem(SESSION_KEY); } catch(e) {}
}

function getSavedSession() {
  try { return localStorage.getItem(SESSION_KEY); } catch(e) { return null; }
}

// ‚îÄ‚îÄ Restore session on page load ‚îÄ‚îÄ
async function tryRestoreSession() {
  const savedEmail = getSavedSession();
  if (!savedEmail) return;
  try {
    const user = await loadUser(savedEmail);
    if (user) {
      loginUser(user, false);
    } else {
      clearSession();
    }
  } catch(e) { clearSession(); }
}

async function submitAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const pass  = document.getElementById('authPassword').value;
  const pass2 = document.getElementById('authPasswordConfirm').value;
  const errEl = document.getElementById('authError');

  if (!email || !pass) { errEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'; return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { errEl.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'; return; }
  if (pass.length < 4) { errEl.textContent = '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞'; return; }

  const btn = document.getElementById('authSubmitBtn');
  btn.textContent = '...';
  btn.disabled = true;

  const existing = await loadUser(email);

  if (authMode === 'register') {
    if (pass !== pass2) { errEl.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; btn.textContent = '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø'; btn.disabled = false; return; }
    if (existing) { errEl.textContent = 'Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'; btn.textContent = '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø'; btn.disabled = false; return; }
    const newUser = { email, password: pass, id: generateUserId(), battles: 0, wins: 0, xp: 0, displayName: '' };
    await saveUser(newUser);
    loginUser(newUser);
    setTimeout(() => openNicknameOverlay(true), 300);
  } else {
    if (!existing) { errEl.textContent = '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'; btn.textContent = '–í–û–ô–¢–ò'; btn.disabled = false; return; }
    if (existing.password !== pass) { errEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; btn.textContent = '–í–û–ô–¢–ò'; btn.disabled = false; return; }
    loginUser(existing);
  }

  btn.disabled = false;
}

function loginUser(user, persist = true) {
  currentUser = user;
  renderProfile();
  document.getElementById('authPanel').style.display = 'none';
  document.getElementById('profilePanel').style.display = '';
  updateAccountBtn();
  if (persist && _rememberMe) saveSession(user.email);
}

function renderProfile() {
  if (!currentUser) return;
  document.getElementById('profileEmail').textContent = currentUser.email;
  document.getElementById('profileId').textContent = currentUser.id;
  const nickEl = document.getElementById('profileNickname');
  if (nickEl) nickEl.textContent = currentUser.displayName || '‚Äî –Ω–µ –∑–∞–¥–∞–Ω ‚Äî';
  document.getElementById('profileBattles').textContent = currentUser.battles || 0;
  document.getElementById('profileWins').textContent = currentUser.wins || 0;
  const wr = currentUser.battles > 0 ? Math.round((currentUser.wins / currentUser.battles) * 100) : 0;
  document.getElementById('profileWinrate').textContent = wr + '%';

  // XP / Level
  const xp = currentUser.xp || 0;
  const info = getLevelInfo(xp);
  document.getElementById('profileLevelBadge').textContent = `–£–†–û–í–ï–ù–¨ ${info.level}`;
  document.getElementById('profileXpBar').style.width = info.pct + '%';
  document.getElementById('profileXpText').textContent = info.isMax
    ? `${xp} XP (–º–∞–∫—Å.)`
    : `${info.xpInLevel} / ${info.xpNeeded} XP`;
  document.getElementById('profileCrystals').textContent = currentUser.crystals || 0;
  const maxEl = document.getElementById('profileMaxLevel');
  if (maxEl) maxEl.style.display = info.isMax ? '' : 'none';
}

function logoutAccount() {
  currentUser = null;
  clearSession();
  updateAccountBtn();
  document.getElementById('profilePanel').style.display = 'none';
  document.getElementById('authPanel').style.display = '';
  document.getElementById('authEmail').value = '';
  document.getElementById('authPassword').value = '';
  document.getElementById('authPasswordConfirm').value = '';
  document.getElementById('authError').textContent = '';
  switchAuthTab('login');
}

function updateAccountBtn() {
  const btn = document.getElementById('accountBtn');
  if (!btn) return;
  btn.textContent = currentUser ? '‚úÖ' : 'üë§';
  btn.title = currentUser ? currentUser.email : '–ê–∫–∫–∞—É–Ω—Ç';
}

function openAccountPopup() {
  const overlay = document.getElementById('accountOverlay');
  if (currentUser) {
    renderProfile();
    document.getElementById('authPanel').style.display = 'none';
    document.getElementById('profilePanel').style.display = '';
  } else {
    document.getElementById('authPanel').style.display = '';
    document.getElementById('profilePanel').style.display = 'none';
    switchAuthTab('login');
  }
  overlay.classList.add('active');
}

function closeAccountOverlay() {
  document.getElementById('accountOverlay').classList.remove('active');
}

async function recordGameResult(won) {
  if (!currentUser) return;
  currentUser.battles = (currentUser.battles || 0) + 1;
  if (won) currentUser.wins = (currentUser.wins || 0) + 1;
  const xpGain = won ? 100 : 50;
  currentUser.xp = (currentUser.xp || 0) + xpGain;
  await saveUser(currentUser);
}


// ============================================================
// BATTLEPASS SYSTEM
// ============================================================

const BP_LEVELS = 10;
const BP_XP_PER_LEVEL = 100; // 100 XP per BP level
const BP_PREMIUM_COST = 500; // crystals

// Rewards definition: level 1-10, free and premium tracks
const BP_REWARDS = [
  { level:1,  free:{ type:'crystals', amount:50,  label:'üíé 50' },           premium:{ type:'card_back', id:'blue',   label:'üé® –°–∏–Ω—è—è —Ä—É–±–∞—à–∫–∞', cardType:'digit' } },
  { level:2,  free:{ type:'card_back', id:'green', label:'üé® –ó–µ–ª. —Ä—É–±–∞—à–∫–∞', cardType:'buff' }, premium:{ type:'crystals', amount:100, label:'üíé 100' } },
  { level:3,  free:{ type:'crystals', amount:75,  label:'üíé 75' },           premium:{ type:'board',     id:'forest', label:'üå≤ –°—Ç–æ–ª –õ–µ—Å' } },
  { level:4,  free:{ type:'card_back', id:'red',  label:'üé® –ö—Ä–∞—Å–Ω. —Ä—É–±–∞—à–∫–∞', cardType:'super' }, premium:{ type:'crystals', amount:150, label:'üíé 150' } },
  { level:5,  free:{ type:'crystals', amount:100, label:'üíé 100' },          premium:{ type:'card_back', id:'gold',   label:'üé® –ó–æ–ª–æ—Ç. —Ä—É–±–∞—à–∫–∞', cardType:'digit' } },
  { level:6,  free:{ type:'card_back', id:'blue', label:'üé® –°–∏–Ω—è—è —Ä—É–±–∞—à–∫–∞', cardType:'buff' },  premium:{ type:'board',    id:'space',  label:'üåå –°—Ç–æ–ª –ö–æ—Å–º–æ—Å' } },
  { level:7,  free:{ type:'crystals', amount:125, label:'üíé 125' },          premium:{ type:'crystals', amount:200, label:'üíé 200' } },
  { level:8,  free:{ type:'card_back', id:'gold', label:'üé® –ó–æ–ª–æ—Ç. —Ä—É–±–∞—à–∫–∞', cardType:'buff' }, premium:{ type:'board',    id:'fire',   label:'üî• –°—Ç–æ–ª –û–≥–æ–Ω—å' } },
  { level:9,  free:{ type:'crystals', amount:150, label:'üíé 150' },          premium:{ type:'card_back', id:'purple', label:'üé® –§–∏–æ–ª. —Ä—É–±–∞—à–∫–∞', cardType:'super' } },
  { level:10, free:{ type:'card_back', id:'purple', label:'üé® –§–∏–æ–ª. —Ä—É–±–∞—à–∫–∞', cardType:'digit' }, premium:{ type:'crystals', amount:500, label:'üíé 500' } },
];

function getBpLevel(xp) {
  return Math.min(BP_LEVELS, Math.floor((xp || 0) / BP_XP_PER_LEVEL));
}

function openBattlepassPopup() {
  renderBattlepass();
  document.getElementById('battlepassOverlay').classList.add('active');
}

function renderBattlepass() {
  const user = currentUser;
  const xp = user ? (user.xp || 0) : 0;
  const bpLevel = getBpLevel(xp);
  const xpInBP = xp % BP_XP_PER_LEVEL;
  const hasPremium = user ? !!user.bpPremium : false;
  const claimed = user ? (user.bpClaimed || []) : [];

  const pct = bpLevel >= BP_LEVELS ? 100 : Math.min(100, Math.round((xpInBP / BP_XP_PER_LEVEL) * 100));
  const bar = document.getElementById('bpProgressBar');
  if (bar) bar.style.width = pct + '%';
  const lt = document.getElementById('bpLevelText');
  if (lt) lt.textContent = bpLevel >= BP_LEVELS
    ? '‚úÖ –ë–ê–¢–õ–ü–ê–°–° –ó–ê–í–ï–†–®–Å–ù'
    : `–£—Ä. ${bpLevel} / ${BP_LEVELS} ‚Ä¢ ${xpInBP} / ${BP_XP_PER_LEVEL} XP`;

  const buyBtn = document.getElementById('bpBuyBtn');
  const premLabel = document.getElementById('bpPremiumLabel');
  if (hasPremium) {
    if (buyBtn) buyBtn.style.display = 'none';
    if (premLabel) premLabel.textContent = '‚úÖ –ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!';
  } else {
    if (buyBtn) buyBtn.style.display = '';
    if (premLabel) premLabel.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∏–∂–Ω–∏–π —Ä—è–¥ –Ω–∞–≥—Ä–∞–¥';
  }

  const freeRow  = document.getElementById('bpFreeRow');
  const levelRow = document.getElementById('bpLevelRow');
  const premRow  = document.getElementById('bpPremRow');
  if (!freeRow || !levelRow || !premRow) return;
  freeRow.innerHTML = '';
  levelRow.innerHTML = '';
  premRow.innerHTML = '';

  BP_REWARDS.forEach((row, idx) => {
    const lvl = row.level;
    const unlocked = bpLevel >= lvl;
    const freeKey = `free_${lvl}`;
    const premKey = `prem_${lvl}`;
    const freeClaimed = claimed.includes(freeKey);
    const premClaimed  = claimed.includes(premKey);
    const isLast = idx === BP_REWARDS.length - 1;

    // FREE cell
    freeRow.innerHTML += buildBpCell(row.free, unlocked, freeClaimed, freeKey, 'free', false);

    // Level node
    levelRow.innerHTML += `
      <div class="bp-lvl-node">
        <div class="bp-lvl-circle" style="
          background:${unlocked ? 'linear-gradient(135deg,var(--orange),var(--yellow))' : 'var(--bg3)'};
          color:${unlocked ? '#1a1000' : 'var(--gray)'};
          box-shadow:${unlocked ? '0 0 14px rgba(255,200,0,0.45)' : 'none'};">
          ${lvl}
        </div>
        ${!isLast ? `<div class="bp-lvl-line" style="background:${unlocked ? 'linear-gradient(90deg,var(--yellow),rgba(255,200,0,0.15))' : 'var(--bg3)'};"></div>` : ''}
      </div>`;

    // PREM cell
    premRow.innerHTML += buildBpCell(row.premium, unlocked && hasPremium, premClaimed, premKey, 'prem', !hasPremium);
  });
}

function buildBpCell(reward, unlocked, claimed, key, track, locked) {
  const isFree = track === 'free';
  const click = unlocked && !claimed && !locked;
  const isCrystal = reward.type === 'crystals';

  let cls = `bp-cell ${isFree ? 'free-cell' : 'prem-cell'}`;
  if (locked) cls = 'bp-cell locked-prem';
  else if (claimed) cls += ' claimed';
  else if (unlocked) cls += ' unlocked';
  if (click) cls += ' clickable';

  const icon  = claimed ? '‚úÖ' : locked ? 'üîí' : unlocked ? (isCrystal ? 'üíé' : 'üéÅ') : 'üîí';
  const color = claimed ? 'var(--gray)' : locked ? '#4a2060'
              : unlocked ? (isFree ? 'var(--green)' : '#d8a0ff') : 'var(--gray)';

  // Premium crystals open shop; everything else claims normally
  const clickAction = click
    ? (isCrystal && !isFree ? `openCrystalShop()` : `claimBpReward('${key}','${track}')`)
    : '';

  return `<div class="${cls}" onclick="${clickAction}">
    <div class="bp-cell-icon">${icon}</div>
    <div class="bp-cell-label" style="color:${color};">${reward.label}</div>
    ${claimed ? '<div class="bp-cell-sub">–ü–æ–ª—É—á–µ–Ω–æ</div>' : ''}
    ${locked  ? '<div class="bp-cell-sub" style="color:#4a2060;">–ü—Ä–µ–º–∏—É–º</div>' : ''}
  </div>`;
}

async function claimBpReward(key, track) {
  if (!currentUser) return;
  const claimed = currentUser.bpClaimed || [];
  if (claimed.includes(key)) return;

  const lvl = parseInt(key.split('_')[1]);
  const row = BP_REWARDS.find(r => r.level === lvl);
  if (!row) return;
  const reward = track === 'free' ? row.free : row.premium;

  // Apply reward
  if (reward.type === 'crystals') {
    currentUser.crystals = (currentUser.crystals || 0) + reward.amount;
    addLog(`üíé +${reward.amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!`, 'good');
  } else if (reward.type === 'card_back') {
    if (!currentUser.unlockedBacks) currentUser.unlockedBacks = {};
    if (!currentUser.unlockedBacks[reward.cardType]) currentUser.unlockedBacks[reward.cardType] = [];
    currentUser.unlockedBacks[reward.cardType].push(reward.id);
    addLog(`üé® –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Ä—É–±–∞—à–∫–∞!`, 'good');
  } else if (reward.type === 'board') {
    if (!currentUser.unlockedBoards) currentUser.unlockedBoards = [];
    currentUser.unlockedBoards.push(reward.id);
    addLog(`üéÆ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Å—Ç–æ–ª!`, 'good');
  }

  currentUser.bpClaimed = [...claimed, key];
  await saveUser(currentUser);
  renderBattlepass();
  renderProfile();
}

async function buyBattlepass() {
  if (!currentUser) { openAccountPopup(); return; }
  const cost = BP_PREMIUM_COST;
  if ((currentUser.crystals || 0) < cost) {
    openCrystalShop(); return;
  }
  currentUser.crystals = (currentUser.crystals || 0) - cost;
  currentUser.bpPremium = true;
  await saveUser(currentUser);
  renderBattlepass();
  renderProfile();
}

// ‚îÄ‚îÄ Crystal Shop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCrystalShop() {
  const bal = document.getElementById('shopCrystalBalance');
  if (bal) bal.textContent = (currentUser ? (currentUser.crystals || 0) : 0) + ' üíé';
  document.getElementById('crystalShopOverlay').classList.add('active');
}

function closeCrystalShop() {
  document.getElementById('crystalShopOverlay').classList.remove('active');
}

async function buyCrystals(amount) {
  if (!currentUser) { closeCrystalShop(); openAccountPopup(); return; }
  currentUser.crystals = (currentUser.crystals || 0) + amount;
  await saveUser(currentUser);
  const bal = document.getElementById('shopCrystalBalance');
  if (bal) bal.textContent = currentUser.crystals + ' üíé';
  renderProfile();
  addLog(`üíé +${amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ!`, 'good');
}

function setLang(lang, btn) {
  currentLang = lang;
  document.querySelectorAll('#settingsOverlay .settings-option').forEach(b => {
    if (b.onclick && b.onclick.toString().includes('setLang')) b.classList.remove('active');
  });
  btn.classList.add('active');
}

function switchBackTab(type, btn) {
  currentBackTab = type;
  document.querySelectorAll('.back-tab').forEach(b => {
    b.style.background = 'var(--bg3)';
    b.style.color = 'var(--gray)';
  });
  const colors = { digit: ['var(--yellow)', '#2d2200'], buff: ['var(--orange)', '#fff'], super: ['var(--red)', '#fff'] };
  btn.style.background = colors[type][0];
  btn.style.color = colors[type][1];
  document.querySelectorAll('.back-tab-panel').forEach(p => p.style.display = 'none');
  document.getElementById('backOptions-' + type).style.display = '';
}

function setCardBack(type, id, el) {
  currentCardBacks[type] = id;
  document.querySelectorAll('#backOptions-' + type + ' .card-back-preview').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  applyCardBack();
}

function applyCardBack() {
  const ds = CARD_BACK_STYLES[currentCardBacks.digit]  || CARD_BACK_STYLES.dark;
  const bs = CARD_BACK_STYLES[currentCardBacks.buff]   || CARD_BACK_STYLES.dark;
  const ss = CARD_BACK_STYLES[currentCardBacks.super]  || CARD_BACK_STYLES.dark;
  let s = document.getElementById('cardBackStyle');
  if (!s) { s = document.createElement('style'); s.id = 'cardBackStyle'; document.head.appendChild(s); }
  s.textContent = [
    '.card-back { background: ' + ds + ' !important; }',
    '.win-stack-card.digit-back { background: ' + ds + ' !important; }',
    '.win-stack-card.buff-back  { background: ' + bs + ' !important; }',
    '.win-stack-card.super-back { background: ' + ss + ' !important; }',
  ].join('\n');
}

function setBoardTheme(id, el) {
  currentBoardTheme = id;
  document.querySelectorAll('#boardOptions .board-preview').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  applyBoardTheme();
}

function applyBoardTheme() {
  const theme = BOARD_THEMES[currentBoardTheme] || BOARD_THEMES.default;
  let s = document.getElementById('boardThemeStyle');
  if (!s) { s = document.createElement('style'); s.id = 'boardThemeStyle'; document.head.appendChild(s); }
  s.textContent = `.battle-table { background: ${theme.bg} !important; border-color: ${theme.border} !important; }`;
}



let G = {};
let difficulty = 'easy';

const BUFF_CARDS = [
  { id:'b1', name:'–í—Ç–æ—Ä–æ–µ\n–¥—ã—Ö–∞–Ω–∏–µ', nameShort:'–í—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ', effect:'second_wind', desc:'+2 –∫ —Ç–≤–æ–µ–π —Ü–∏—Ñ—Ä–µ –Ω–∞ —Å—Ç–æ–ª–µ' },
  { id:'b2', name:'–ü–æ—Å–ª–µ–¥–Ω–∏–π\n—à–∞–Ω—Å', nameShort:'–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å', effect:'last_chance', desc:'–û–±—ä—è–≤–ª—è–µ—Ç –°—É–ø–µ—Ä–±–∏—Ç–≤—É' },
  { id:'b3', name:'–ó–∞–º–µ–Ω–∞', nameShort:'–ó–∞–º–µ–Ω–∞', effect:'swap', desc:'–ú–µ–Ω—è–µ—à—å —Å–≤–æ—é –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏' },
  { id:'b4', name:'–ö—Ä–∞–∂–∞', nameShort:'–ö—Ä–∞–∂–∞', effect:'theft', desc:'–ë–µ—Ä—ë—à—å —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É –∏–∑ —Å—Ç–æ–ø–∫–∏ –ø–æ–±–µ–¥ –≤—Ä–∞–≥–∞' },
  { id:'b5', name:'–†–µ–∞–Ω–∏–º–∞—Ü–∏—è', nameShort:'–†–µ–∞–Ω–∏–º–∞—Ü–∏—è', effect:'reanimation', desc:'–í–µ—Ä–Ω–∏ –æ–¥–Ω—É –∏–∑ —Å–≤–æ–∏—Ö –∫–∞—Ä—Ç, –ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–æ—à–ª–æ–º —Ä–∞—É–Ω–¥–µ, –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä—É–∫—É' },
];

const SUPER_CARDS = [
  { id:'s1', name:'–ó–∞—â–∏—Ç–∞', nameShort:'–ó–∞—â–∏—Ç–∞', effect:'shield', desc:'–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ó–∞–º–µ–Ω—É, –ö—Ä–∞–∂—É, –í–æ—Ä–æ–≤—Å—Ç–≤–æ, –ü–æ–¥–º–µ–Ω—É –∏–ª–∏ –í–µ—Ä—à–∏–Ω—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞' },
  { id:'s2', name:'–ó–∞–º–æ—Ä–æ–∑–∫–∞', nameShort:'–ó–∞–º–æ—Ä–æ–∑–∫–∞', effect:'freeze', desc:'–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∫—Ä–æ–º–µ –ó–∞—â–∏—Ç—ã' },
  { id:'s3', name:'–í–æ—Ä–æ–≤—Å—Ç–≤–æ', nameShort:'–í–æ—Ä–æ–≤—Å—Ç–≤–æ', effect:'rob', desc:'–ö—Ä–∞–∂–∞ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã –∏–∑ —Ä—É–∫–∏ –≤—Ä–∞–≥–∞' },
  { id:'s4', name:'–ü–æ–¥–º–µ–Ω–∞', nameShort:'–ü–æ–¥–º–µ–Ω–∞', effect:'replace', desc:'–ú–µ–Ω—è–µ—à—å –ª—é–±—É—é –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–∑ —Å–≤–æ–µ–π —Ä—É–∫–∏' },
  { id:'s5', name:'–í–µ—Ä—à–∏–Ω–∞', nameShort:'–í–µ—Ä—à–∏–Ω–∞', effect:'peak', desc:'–ë–µ—Ä—ë—à—å –≤–µ—Ä—Ö–Ω—é—é –∫–∞—Ä—Ç—É –∏–∑ –ª—é–±–æ–π –∫–æ–ª–æ–¥—ã (–Ω–µ–ª—å–∑—è –∏–≥—Ä–∞—Ç—å –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ)' },
];

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function makeDigitDeck() {
  const d = [];
  for (let v = 1; v <= 9; v++)
    for (let c = 0; c < 4; c++)
      d.push({ type:'digit', value:v, id:`d${v}_${c}` });
  return shuffle(d);
}

function makeBuffDeck() {
  const d = [];
  BUFF_CARDS.forEach((bc, i) => {
    for (let c = 0; c < 2; c++)
      d.push({ ...bc, type:'buff', id:`buff_${i}_${c}` });
  });
  return shuffle(d);
}

function makeSuperDeck() {
  const d = [];
  SUPER_CARDS.forEach((sc, i) => {
    for (let c = 0; c < 2; c++)
      d.push({ ...sc, type:'super', id:`super_${i}_${c}` });
  });
  return shuffle(d);
}

function dealTo(who, type) {
  if (G[who].hand.length >= 10) return false;
  const deck = type === 'digit' ? G.digitDeck : type === 'buff' ? G.buffDeck : G.superDeck;
  if (deck.length === 0) return false;
  G[who].hand.push(deck.pop());
  return true;
}

function makeEnhanceDeck() {
  return shuffle([...makeBuffDeck(), ...makeSuperDeck()]);
}

function initGame() {
  G = {
    digitDeck: makeDigitDeck(),
    buffDeck: makeBuffDeck(),
    superDeck: makeSuperDeck(),
    enhanceDeck: makeEnhanceDeck(),
    player: { hand:[], winStack:[], shielded:false, lastLost:[], lastRoundLost:false },
    trash: [],
    _swapMode: false,
    _swapTarget: null,
    ai: { hand:[], winStack:[], shielded:false, lastLost:[] },
    table: { playerCard:null, aiCard:null, playerMod:0, aiMod:0, playerShielded:false, aiShielded:false },
    round: 0,
    phase: 'select_digit',
    superBattle: { active:false, playerCards:[], aiCards:[], waitingForPlayer:false },
    frozenInRound: false,
    pendingCard: null,
    gameOver: false,
    log: [],
  };
  for (let i = 0; i < 6; i++) { dealTo('player','digit'); dealTo('ai','digit'); }
  for (let i = 0; i < 2; i++) { dealTo('player','buff'); dealTo('ai','buff'); }
  for (let i = 0; i < 2; i++) { dealTo('player','super'); dealTo('ai','super'); }
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function addLog(msg, cls='') {
  G.log.push({ msg, cls });
  const el = document.getElementById('battleLog');
  if (el) el.innerHTML = G.log.slice(-3).map(l => `<div class="log-line ${l.cls}">${l.msg}</div>`).join('');
}

function setStatus(msg, cls='') {
  const el = document.getElementById('statusMsg');
  if (el) { el.textContent = msg; el.className = 'status-msg ' + cls; }
}

function setBtns(attack, pass_) { /* buttons removed */ }

function calcScore(stack) {
  return stack.reduce((s, c) => {
    if (c.type === 'digit') return s + c.value;
    if (c.type === 'buff') return s + 3;
    if (c.type === 'super') return s + 7;
    return s;
  }, 0);
}

function renderWinStack() {
  _renderOneWinStack('playerWinStackVisual', 'playerWinCount', G.player.winStack);
  _renderOneWinStack('aiWinStackVisual', 'aiWinCount', G.ai.winStack);
}

function _winCardInner(card) {
  return ''; // —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
}

function _renderOneWinStack(elId, countElId, stack) {
  const el = document.getElementById(elId);
  const countEl = document.getElementById(countElId);
  if (!el) return;
  const total = stack.length;
  if (countEl) countEl.textContent = total + ' –∫–∞—Ä—Ç';
  if (total === 0) { el.innerHTML = '<div style="font-size:0.55rem;color:var(--gray);font-weight:800;text-align:center;">–ø—É—Å—Ç–æ</div>'; return; }
  const show = Math.min(total, 8);
  const step = total > 1 ? Math.min(10, Math.floor(110 / show)) : 0;
  const totalH = 62 + step * (show - 1);
  el.style.minHeight = totalH + 'px';
  let html = '';
  for (let i = 0; i < show; i++) {
    const card = stack[stack.length - show + i];
    const isTop = i === show - 1;
    const inner = isTop ? _winCardInner(card) : '';
    html += `<div class="win-stack-card ${card.type || 'back'}" style="bottom:${i * step}px;left:2px;z-index:${i + 1};">${inner}</div>`;
  }
  el.innerHTML = html;
}

function _deckCardInner(card) {
  return ''; // —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
}

function renderDecks() {
  const digitEl = document.getElementById('digitDeckVisual');
  const enhEl = document.getElementById('enhanceDeckVisual');
  if (!digitEl || !enhEl) return;
  const dLen = G.digitDeck.length;
  const eLen = G.enhanceDeck.length;
  const digitCards = G.digitDeck.slice(-6);
  const enhCards = G.enhanceDeck.slice(-6);
  renderDeckPileReal(digitEl, dLen, digitCards);
  renderDeckPileReal(enhEl, eLen, enhCards);
  // Update count labels
  const dc = document.getElementById('digitDeckCount');
  const ec = document.getElementById('enhanceDeckCount');
  if (dc) dc.textContent = dLen;
  if (ec) ec.textContent = eLen;
}

function renderDeckPileReal(container, count, cards) {
  const show = cards.length;
  const step = 3;
  const totalH = 62 + step * Math.max(show - 1, 0);
  container.style.height = (totalH + 28) + 'px';
  container.style.position = 'relative';
  let html = '';
  if (show === 0) {
    html = '<div class="deck-empty" style="position:absolute;top:8px;left:0;right:0;text-align:center;">–ø—É—Å—Ç–æ</div>';
  } else {
    for (let i = 0; i < show; i++) {
      const card = cards[i];
      const cls = card.type === 'digit' ? 'digit-back' : card.type === 'buff' ? 'buff-back' : 'super-back';
      html += `<div class="deck-pile-card ${cls}" style="top:${(show - 1 - i) * step}px;left:2px;z-index:${i + 1};"></div>`;
    }
  }
  
  container.innerHTML = html;
}

function updateUI() {
  if (!document.getElementById('gameScreen')?.classList.contains('active')) return;
  const ps = calcScore(G.player.winStack);
  const as = calcScore(G.ai.winStack);
  const pDigits = G.player.hand.filter(c => c.type === 'digit').length;
  const aDigits = G.ai.hand.filter(c => c.type === 'digit').length;
  setText('playerScore', ps);
  setText('aiScore', as);
  // Score breakdown
  const pDScore = G.player.winStack.filter(c=>c.type==='digit').reduce((s,c)=>s+c.value,0);
  const pBCount = G.player.winStack.filter(c=>c.type==='buff').length;
  const pSCount = G.player.winStack.filter(c=>c.type==='super').length;
  const aDScore = G.ai.winStack.filter(c=>c.type==='digit').reduce((s,c)=>s+c.value,0);
  const aBCount = G.ai.winStack.filter(c=>c.type==='buff').length;
  const aSCount = G.ai.winStack.filter(c=>c.type==='super').length;
  let pBreak = `üü°${pDScore}`;
  if (pBCount) pBreak += ` üü†+${pBCount*3}`;
  if (pSCount) pBreak += ` üî¥+${pSCount*7}`;
  let aBreak = `üü°${aDScore}`;
  if (aBCount) aBreak += ` üü†+${aBCount*3}`;
  if (aSCount) aBreak += ` üî¥+${aSCount*7}`;
  setText('playerCardCount', pBreak);
  setText('aiCardCount', aBreak);
  setText('playerHandCount', `${G.player.hand.length} –∫–∞—Ä—Ç`);
  setText('aiHandCount', `${G.ai.hand.length} –∫–∞—Ä—Ç`);
  renderAIHand();
  renderPlayerHand();
  renderTable();
  renderWinStack();
  renderDecks();
  renderPlayedCards();
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function renderAIHand() {
  const el = document.getElementById('aiHandDisplay');
  if (el) el.innerHTML = G.ai.hand.map(() => `<div class="card-back"></div>`).join('');
}

function cardEl(card, idx) {
  const tip = card.type === 'digit' ? '' : (card.desc || '');
  const sel = G.pendingCard === idx ? ' selected' : '';
  const peak = card._peakNew ? ' peak-received' : '';
  const stolen = card._stolen ? ' stolen-card' : '';
  const reanimated = card._reanimated ? ' reanimated-card' : '';
  let inner = '';
  if (card.type === 'digit') {
    inner = `<div class="card-value">${card.value}</div>`;
  } else {
    const icon = card.type === 'buff' ? 'üü†' : 'üî¥';
    inner = `<div class="card-type-icon">${icon}</div><div class="card-name">${card.nameShort}</div>`;
  }
  const tipAttr = tip ? ` data-tip="${tip}"` : '';
  return `<div class="game-card ${card.type}${sel}${peak}${stolen}${reanimated}" data-idx="${idx}"${tipAttr} onclick="selectCard(${idx})">${inner}</div>`;
}

function renderPlayerHand() {
  const el = document.getElementById('playerHand');
  if (!el) return;
  if (G.player.hand.length === 0) { el.innerHTML = '<div style="color:var(--gray);font-size:0.8rem;font-weight:700;">–ù–µ—Ç –∫–∞—Ä—Ç</div>'; return; }
  // Split into rows of max 5
  const cards = G.player.hand.map((c, i) => cardEl(c, i));
  let html = '';
  for (let i = 0; i < cards.length; i += 5) {
    html += `<div class="hand-row">${cards.slice(i, i + 5).join('')}</div>`;
  }
  el.innerHTML = html;
}

function logCardPlayed(card, who) {
  if (!card || (card.type !== 'buff' && card.type !== 'super')) return;
  if (!G.table.playerPlayed) G.table.playerPlayed = [];
  if (!G.table.aiPlayed) G.table.aiPlayed = [];
  if (who === 'player') {
    G.table.playerPlayed.push(card);
    G.player.winStack.push(card);
  } else {
    G.table.aiPlayed.push(card);
    G.ai.winStack.push(card);
  }
}

function renderPlayedCards() {
  const pRow = document.getElementById('playerPlayedRow');
  const aRow = document.getElementById('aiPlayedRow');
  if (pRow) {
    pRow.innerHTML = (G.table.playerPlayed || []).map(card =>
      `<div class="table-played-card ${card.type}" title="${card.nameShort}">${card.nameShort}</div>`
    ).join('');
  }
  if (aRow) {
    aRow.innerHTML = (G.table.aiPlayed || []).map(card =>
      `<div class="table-played-card ${card.type}" title="${card.nameShort}">${card.nameShort}</div>`
    ).join('');
  }
}

function tableCardHTML(card, mod) {
  if (!card) return '';
  let inner = '';
  if (card.type === 'digit') {
    const dv = card.value + (mod || 0);
    inner = `<div class="card-value">${dv}</div>` + (mod > 0 ? `<div class="modifier-badge">+${mod}</div>` : '');
  } else {
    inner = `<div class="card-name" style="font-size:0.6rem;font-weight:800;text-align:center;padding:4px;">${card.nameShort}</div>`;
  }
  return `<div class="table-card ${card.type}">${inner}</div>`;
}

function renderTable() {
  const sbl = document.getElementById('superBattleLabel');
  const bt = document.getElementById('battleTable');
  const isSuper = G.phase === 'superbattle';
  if (sbl) sbl.classList.toggle('show', isSuper);
  if (bt) bt.classList.toggle('superbattle-mode', isSuper);

  if (isSuper && G.superBattle && G.superBattle.history && G.superBattle.history.length > 0) {
    const hist = G.superBattle.history;
    const aiRow = document.getElementById('aiTableRow');
    const pRow = document.getElementById('playerTableRow');
    if (!aiRow || !pRow) return;

    // –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ä–∞—É–Ω–¥—ã (–≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ) ‚Äî —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ
    let aiHistHtml = '';
    let pHistHtml = '';
    for (let i = 0; i < hist.length - 1; i++) {
      const h = hist[i];
      const slotStyle = `position:relative;width:70px;height:96px;border-radius:12px;border:2px solid var(--bg3);display:flex;align-items:center;justify-content:center;opacity:0.45;transform:scale(0.88);transition:all 0.3s;flex-shrink:0;`;
      aiHistHtml += `<div style="${slotStyle}">${h.aiCard ? tableCardHTML(h.aiCard, 0) : ''}</div>`;
      pHistHtml  += `<div style="${slotStyle}">${h.playerCard ? tableCardHTML(h.playerCard, 0) : ''}</div>`;
    }

    // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—É–Ω–¥ ‚Äî –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã–π —Å–ª–æ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º id –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    const last = hist[hist.length - 1];
    const lastSlotStyle = `position:relative;width:96px;height:134px;border-radius:10px;border:2px solid var(--yellow);display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 16px rgba(255,215,0,0.3);`;
    aiHistHtml += `<div style="${lastSlotStyle}" id="aiMainSlot">${last.aiCard ? tableCardHTML(last.aiCard, G.table.aiMod) : '<span class="table-slot-label" style="font-size:0.6rem;color:var(--gray);">–ò–ò</span>'}</div>`;
    pHistHtml  += `<div style="${lastSlotStyle}" id="playerMainSlot">${last.playerCard ? tableCardHTML(last.playerCard, G.table.playerMod) : '<span class="table-slot-label" style="font-size:0.6rem;color:var(--gray);">–í–´</span>'}</div>`;

    aiRow.innerHTML = aiHistHtml;
    pRow.innerHTML = pHistHtml;
    aiRow.scrollLeft = 9999;
    pRow.scrollLeft = 9999;
  } else {
    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –æ–¥–∏–Ω —Å–ª–æ—Ç
    const ps = document.getElementById('playerMainSlot');
    const as = document.getElementById('aiMainSlot');
    const aiRow = document.getElementById('aiTableRow');
    const pRow = document.getElementById('playerTableRow');
    if (aiRow && !document.getElementById('aiMainSlot')) {
      aiRow.innerHTML = '<div class="table-slot" id="aiMainSlot"><span class="table-slot-label">AI</span></div>';
    }
    if (pRow && !document.getElementById('playerMainSlot')) {
      pRow.innerHTML = '<div class="table-slot" id="playerMainSlot"><span class="table-slot-label">YOU</span></div>';
    }
    const psEl = document.getElementById('playerMainSlot');
    const asEl = document.getElementById('aiMainSlot');
    if (psEl) { psEl.classList.toggle('has-card', !!G.table.playerCard); psEl.innerHTML = G.table.playerCard ? tableCardHTML(G.table.playerCard, G.table.playerMod) : '<span class="table-slot-label">–í–´</span>'; }
    if (asEl) { asEl.classList.toggle('has-card', !!G.table.aiCard); asEl.innerHTML = G.table.aiCard ? tableCardHTML(G.table.aiCard, G.table.aiMod) : '<span class="table-slot-label">–ò–ò</span>'; }
  }
}

function showResultBanner() {} // deprecated

function selectDiff(btn, d) {
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  difficulty = d;
}

function goIntro() { hideAllOverlays(); showScreen('introScreen'); }

function startGame() {
  initGame();
  setText('diffBadge', difficulty === 'hard' ? 'üî• –°–õ–û–ñ–ù–ê–Ø' : 'üòå –õ–Å–ì–ö–ê–Ø');
  showScreen('gameScreen');
  addLog('‚öî –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'important');
  startRound();
}

function startRound() {
  G.round++;
  G.table = { playerCard:null, aiCard:null, playerMod:0, aiMod:0, playerShielded:false, aiShielded:false, playerPlayed:[], aiPlayed:[] };
  G.phase = 'select_digit';
  G.pendingCard = null;
  _superPendingIdx = null;
  G.frozenInRound = false;
  G.player.shielded = false;
  G.ai.shielded = false;
  G.superBattle = { active:false, playerCards:[], aiCards:[], waitingForPlayer:false };
  G._swapMode = false;
  G._swapTarget = null;
  const handEl2 = document.getElementById('playerHand');
  if (handEl2) handEl2.classList.remove('swap-selecting');
  if (checkGameOver()) return;
  addLog(`--- –†–∞—É–Ω–¥ ${G.round} ---`, 'important');
  setStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Ü–∏—Ñ—Ä—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∞—Ç–∞–∫–æ–≤–∞—Ç—å');
  updateUI();
}

let _superPendingIdx = null;

function selectCard(idx) {
  if (G._swapMode) { finishSwapFromHand(idx); return; }
  if (G.superBattle && G.superBattle.waitingForPlayer) { superBattlePlayerPick(idx); return; }
  if (G.phase !== 'select_digit') return;
  const card = G.player.hand[idx];
  if (!card) return;
  if (card && card._peakNew) { card._peakNew = false; }
  if (card && card._stolen) { card._stolen = false; }
  if (card && card._reanimated) { card._reanimated = false; }

  if (card.type === 'digit') {
    G.pendingCard = null;
    _superPendingIdx = null;
    // –ë–µ—Ä—ë–º DOM-—ç–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã –î–û –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –∏—â–µ–º –ø–æ data-idx
    const fromEl = document.querySelector(`#playerHand .game-card[data-idx="${idx}"]`);
    const fromRect = fromEl ? fromEl.getBoundingClientRect() : null;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    G.player.hand.splice(idx, 1);
    G.table.playerCard = card;
    G.phase = 'ai_response';
    addLog(`–í—ã –ø–æ–ª–æ–∂–∏–ª–∏ ${card.value}`);
    setStatus('–ò–ò –¥—É–º–∞–µ—Ç...');

    if (fromRect) {
      // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ —Ä—É–∫—É (–±–µ–∑ –∫–∞—Ä—Ç—ã), –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      renderPlayerHand();
      renderAIHand();
      flyCardFromRect(card, fromRect, 'playerMainSlot', () => {
        updateUI(); // —Ç–µ–ø–µ—Ä—å –∫–∞—Ä—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ–ª–µ
        setTimeout(() => aiPlayDigit(), 200);
      });
    } else {
      updateUI();
      setTimeout(() => aiPlayDigit(), 900);
    }
  } else if (card.type === 'super') {
    // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å, –≤—Ç–æ—Ä–æ–π –∫–ª–∏–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    if (_superPendingIdx === idx) {
      _superPendingIdx = null;
      G.pendingCard = null;
      G.player.hand.splice(idx, 1);
      useSuperCard(card, 'player');
    } else {
      _superPendingIdx = idx;
      G.pendingCard = idx;
      setStatus(`${card.nameShort} ‚Äî –Ω–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å`);
      renderPlayerHand();
    }
  } else {
    // buff ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ
    setStatus('–ö–∞—Ä—Ç—ã —É—Å–∏–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ');
  }
}

function doAttack() {}
function doPass() {}

function aiPlayDigit() {
  const digits = G.ai.hand.filter(c => c.type === 'digit');
  if (digits.length === 0) { checkGameOver(); return; }
  let chosen;
  if (difficulty === 'hard') {
    const pVal = (G.table.playerCard?.value || 0) + G.table.playerMod;
    const winning = digits.filter(d => d.value > pVal);
    chosen = winning.length > 0 ? winning.reduce((a, b) => a.value < b.value ? a : b) : digits.reduce((a, b) => a.value < b.value ? a : b);
  } else {
    chosen = digits[Math.floor(Math.random() * digits.length)];
  }
  G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
  G.table.aiCard = chosen;
  G.phase = 'resolve';
  addLog('–ò–ò –ø–æ–ª–æ–∂–∏–ª –∫–∞—Ä—Ç—É ü§î');
  updateUI();
  setTimeout(() => resolveRound(), 600);
}

function resolveRound() {
  const pVal = (G.table.playerCard?.value || 0) + G.table.playerMod;
  const aVal = (G.table.aiCard?.value || 0) + G.table.aiMod;
  addLog(`‚öî –í—ã: ${pVal} vs –ò–ò: ${aVal}`, 'important');
  if (pVal === aVal) {
    if (G.phase === 'superbattle' && G.superBattle && G.superBattle.active) {
      // –£–∂–µ –≤ —Å—É–ø–µ—Ä–±–∏—Ç–≤–µ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –æ–±–º–µ–Ω, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
      addLog('üî• –°–Ω–æ–≤–∞ —Ä–∞–≤–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!', 'warn');
      setStatus('üî• –†–∞–≤–Ω–æ! –ï—â—ë —Ä–∞—É–Ω–¥!');
      setTimeout(() => superBattleNextExchange(), 1000);
    } else {
      startSuperBattle();
    }
    return;
  }
  if (pVal > aVal) {
    if (aiTryReactiveBuff()) return;
    playerWinsRound();
  } else {
    aiWinsRound();
  }
}

function aiTryReactiveBuff() {
  const buffs = G.ai.hand.filter(c => c.type === 'buff' && ['second_wind','swap'].includes(c.effect));
  if (!buffs.length) return false;
  const pVal = (G.table.playerCard?.value || 0) + G.table.playerMod;
  const aVal = (G.table.aiCard?.value || 0) + G.table.aiMod;
  const gap = pVal - aVal;
  let chosen = null;
  if (difficulty === 'hard') {
    const sw = buffs.find(b => b.effect === 'second_wind');
    if (sw && gap >= 1 && gap <= 2) chosen = sw;
    const sv = buffs.find(b => b.effect === 'swap');
    if (!chosen && sv && G.ai.hand.filter(c => c.type === 'digit').some(d => d.value > pVal)) chosen = sv;
  }
  if (!chosen) return false;
  G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
  addLog(`–ò–ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ${chosen.nameShort}`, 'warn');

  // second_wind and swap affect the round outcome ‚Äî offer freeze
  offerFreezeCounter(chosen.nameShort, () => {
    // Frozen ‚Äî skip effect, continue resolution as-is
    resolveRound();
  }, () => {
    applyBuffEffect(chosen, 'ai');
  });
  return true;
}

function playerWinsRound() {
  const allCards = [G.table.playerCard, G.table.aiCard].filter(Boolean);
  const stackCards = allCards.filter(c => c.type === 'digit');
  G.player.winStack.push(...stackCards);
  G.player.lastLost = [];
  G.player.lastRoundLost = false;
  // –û—á–∏—â–∞–µ–º —Å—Ç–æ–ª —Å—Ä–∞–∑—É
  G.table.playerCard = null;
  G.table.aiCard = null;
  addLog('‚úÖ –í—ã –ø–æ–±–µ–¥–∏–ª–∏ –≤ —Ä–∞—É–Ω–¥–µ!', 'good');
  updateUI();

  const roundPts = stackCards.reduce((s, c) => s + (c.value || 0), 0);

  // –ò–ò –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞—Ñ—Ñ
  const consolation = G.ai.hand.filter(c => c.type === 'buff' && ['theft','reanimation'].includes(c.effect));
  if (consolation.length && Math.random() < (difficulty === 'hard' ? 0.4 : 0.15)) {
    const ch = consolation[Math.floor(Math.random() * consolation.length)];
    G.ai.hand.splice(G.ai.hand.indexOf(ch), 1);
    addLog(`–ò–ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ${ch.nameShort}`, 'warn');
    applyBuffEffect(ch, 'ai');
  }

  // –°—É–ø–µ—Ä–∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
  const supers = G.player.hand
    .map((card, idx) => ({ card, idx }))
    .filter(({ card }) => card.type === 'super' && !['freeze','shield','replace'].includes(card.effect));

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –ø–æ–±–µ–¥—ã —Å —Å—É–ø–µ—Ä–∫–∞—Ä—Ç–∞–º–∏ –≤–Ω—É—Ç—Ä–∏
  showRoundResult('win', roundPts, supers, (chosen) => {
    // chosen ‚Äî –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å—É–ø–µ—Ä–∫–∞—Ä—Ç–∞ –∏–ª–∏ null
    if (chosen) {
      G.player.hand.splice(chosen.idx, 1);
      useSuperCard(chosen.card, 'player');
    }
    afterRound('player');
  }, null);
}

function offerPlayerSupers() { afterRound('player'); } // now handled in showRoundResult

function aiTryUseSuperAfterWin(callback) {
  const supers = G.ai.hand.filter(c => c.type === 'super' && !['freeze','shield'].includes(c.effect));
  if (!supers.length || Math.random() > (difficulty === 'hard' ? 0.55 : 0.25)) { callback(); return; }
  const chosen = supers[Math.floor(Math.random() * supers.length)];
  G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
  addLog(`–ò–ò –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É–ø–µ—Ä–∫–∞—Ä—Ç—É: ${chosen.nameShort}`, 'warn');
  useSuperCard(chosen, 'ai');
  setTimeout(callback, 800);
}

function aiWinsRound() {
  const allCards = [G.table.playerCard, G.table.aiCard].filter(Boolean);
  const stackCards = allCards.filter(c => c.type === 'digit');
  G.ai.winStack.push(...stackCards);
  G.player.lastLost = [G.table.playerCard].filter(c => c.type === 'digit');
  G.player.lastRoundLost = true;
  // –û—á–∏—â–∞–µ–º —Å—Ç–æ–ª —Å—Ä–∞–∑—É
  G.table.playerCard = null;
  G.table.aiCard = null;
  addLog('‚ùå –ò–ò –ø–æ–±–µ–¥–∏–ª –≤ —Ä–∞—É–Ω–¥–µ!', 'warn');
  updateUI();
  const roundPts = stackCards.reduce((s, c) => s + (c.value || 0), 0);
  setTimeout(() => aiTryUseSuperAfterWin(() => offerPlayerBuffs(roundPts)), 400);
}

function offerPlayerBuffs(roundPts=0) {
  const available = G.player.hand
    .map((c, i) => ({ card:c, idx:i }))
    .filter(({ card }) => {
      if (card.type !== 'buff' && card.type !== 'super') return false;
      if (card.effect === 'freeze') return false; // freeze only via counter popup
      if (card.effect === 'shield') return false; // shield is passive only
      if (card.effect === 'reanimation' && (G.round <= 1 || !G.player.lastRoundLost || !G.player.lastLost || G.player.lastLost.length === 0)) return false;
      if (card.effect === 'theft' && (G.round === 1 || G.ai.winStack.length === 0)) return false;
      if (card.effect === 'last_chance' && G.superBattle && G.superBattle.active) return false;
      return true;
    });
  showRoundResult('lose', roundPts, available.length ? available : null, (chosen) => {
    if (!chosen) { afterRound('ai'); return; }
    G.player.hand.splice(chosen.idx, 1);
    if (chosen.card.type === 'super') { useSuperCard(chosen.card, 'player'); afterRound('ai'); }
    else {
      applyBuffEffect(chosen.card, 'player');
      if (['theft', 'reanimation'].includes(chosen.card.effect)) afterRound('ai');
    }
  }, () => afterRound('ai'));
}

function applyBuffEffect(card, who) {
  const opp = who === 'player' ? 'ai' : 'player';
  logCardPlayed(card, who);
  switch (card.effect) {
    case 'second_wind':
      if (who === 'player') {
        aiTryFreeze('–í—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ', () => {
          addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –í—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ!', 'warn');
          resolveRound();
        }, () => {
          G.table.playerMod += 2;
          addLog('–í—ã +2 –∫ —Ü–∏—Ñ—Ä–µ', 'good');
          updateUI();
          setTimeout(() => resolveRound(), 800);
        });
      } else {
        G.table.aiMod += 2;
        addLog('–ò–ò +2 –∫ —Ü–∏—Ñ—Ä–µ', 'good');
        updateUI();
        setTimeout(() => resolveRound(), 800);
      }
      break;
    case 'last_chance': {
      const oppDigits = G[opp].hand.filter(c => c.type === 'digit');
      const myDigits = G[who].hand.filter(c => c.type === 'digit');
      if (oppDigits.length > 0 && myDigits.length > 0) {
        addLog(`–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å ‚Üí –°–£–ü–ï–†–ë–ò–¢–í–ê!`, 'warn');
        // –ö–∞—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Å—Ç–æ–ª–µ ‚Äî –æ–Ω–∏ —É–π–¥—É—Ç –≤ pot –ø—Ä–∏ startSuperBattle
        if (who === 'player') {
          aiTryFreeze('–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å', () => {
            addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å!', 'warn');
            afterRound('ai');
          }, () => {
            startSuperBattle();
          });
        } else {
          startSuperBattle();
        }
      } else {
        addLog('–ù–µ—Ç —Ü–∏—Ñ—Ä –¥–ª—è –°—É–ø–µ—Ä–±–∏—Ç–≤—ã', 'warn');
        afterRound('ai');
      }
      break;
    }
    case 'swap':
      if (who === 'player') offerSwap(); else aiDoSwap();
      break;
    case 'theft': {
      if (G[opp].winStack.length === 0) { addLog('–°—Ç–æ–ø–∫–∞ –ø—É—Å—Ç–∞'); return; }
      if (who === 'player') {
        // Player steals from AI ‚Äî AI can shield
        if (G.ai.shielded) { addLog('–ò–ò –∑–∞—â–∏—â—ë–Ω ‚Äî –ö—Ä–∞–∂–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'warn'); return; }
        aiTryShield('–ö—Ä–∞–∂–∞', () => {
          addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ö—Ä–∞–∂—É –ó–∞—â–∏—Ç–æ–π!', 'warn');
        }, () => {
          aiTryFreeze('–ö—Ä–∞–∂–∞', () => {
            addLog('–ò–ò –∑–∞–º–æ—Ä–æ–∑–∏–ª –ö—Ä–∞–∂—É!', 'warn');
          }, () => {
            const stolen = G.ai.winStack.splice(Math.floor(Math.random() * G.ai.winStack.length), 1)[0];
            if (stolen) stolen._stolen = true;
            G.player.hand.push(stolen);
            addLog('–í—ã —É–∫—Ä–∞–ª–∏ –∫–∞—Ä—Ç—É –∏–∑ —Å—Ç–æ–ø–∫–∏ –ò–ò!', 'good');
            updateUI();
          });
        });
      } else {
        // AI steals from player ‚Äî player can shield
        if (G.player.shielded) { addLog('–í—ã –∑–∞—â–∏—â–µ–Ω—ã ‚Äî –ö—Ä–∞–∂–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'good'); return; }
        offerShieldCounter('–ö—Ä–∞–∂–∞', () => {
          // Shielded ‚Äî blocked
        }, () => {
          offerFreezeCounter('–ö—Ä–∞–∂–∞', () => {
            addLog('–ö—Ä–∞–∂–∞ –ò–ò –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!', 'good');
          }, () => {
            const stolen = G.player.winStack.splice(Math.floor(Math.random() * G.player.winStack.length), 1)[0];
            G.ai.hand.push(stolen);
            addLog('–ò–ò —É–∫—Ä–∞–ª –∫–∞—Ä—Ç—É –∏–∑ –≤–∞—à–µ–π —Å—Ç–æ–ø–∫–∏!', 'warn');
            updateUI();
          });
        });
      }
      break;
    }
    case 'reanimation': {
      const lost = G[who].lastLost;
      if (!lost || lost.length === 0) {
        addLog('–ù–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –∫–∞—Ä—Ç –¥–ª—è —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏', 'warn');
        return;
      }
      if (who === 'player') {
        // Show popup to pick which lost card to recover
        const items = lost.map((c, i) => ({ card: c, idx: i }));
        openChooseOverlay(
          '–†–µ–∞–Ω–∏–º–∞—Ü–∏—è',
          '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –∫–∞—Ä—Ç—É –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—É–Ω–¥–∞, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤ —Ä—É–∫—É',
          items,
          (chosen) => {
            if (!chosen) return;
            chosen.card._reanimated = true;
            G.player.hand.push(chosen.card);
            // Remove chosen card from lastLost
            G[who].lastLost = lost.filter((_, i) => i !== chosen.idx);
            addLog(`–í—ã –≤–µ—Ä–Ω—É–ª–∏ ${chosen.card.type === 'digit' ? chosen.card.value : chosen.card.nameShort} –≤ —Ä—É–∫—É!`, 'good');
            updateUI();
          },
          true
        );
      } else {
        // AI: just take the highest value card from lost
        const best = lost.reduce((a, b) => {
          const va = a.type === 'digit' ? a.value : (a.type === 'buff' ? 3 : 7);
          const vb = b.type === 'digit' ? b.value : (b.type === 'buff' ? 3 : 7);
          return va >= vb ? a : b;
        });
        G[who].hand.push(best);
        G[who].lastLost = lost.filter(c => c !== best);
        addLog(`–ò–ò –≤–µ—Ä–Ω—É–ª ${best.type === 'digit' ? best.value : best.nameShort}`, 'warn');
        updateUI();
      }
      break;
    }
  }
}

let _swapCallback = null;

function offerSwap() {
  const hasHand = G.player.hand.some(c => c.type === 'digit');
  const hasOpp = G.ai.hand.some(c => c.type === 'digit');
  if (!hasHand && !hasOpp) { addLog('–ù–µ—Ç —Ü–∏—Ñ—Ä –¥–ª—è –∑–∞–º–µ–Ω—ã'); resolveRound(); return; }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  const el = document.getElementById('swapOverlay');
  const yv = document.getElementById('swapYourVal');
  const av = document.getElementById('swapAIVal');
  const ob = document.getElementById('swapBtnOpp');
  if (yv) yv.textContent = G.table.playerCard ? G.table.playerCard.value : '?';
  if (av) av.textContent = G.table.aiCard ? G.table.aiCard.value : '?';
  if (ob) ob.disabled = !hasOpp;
  if (el) el.classList.add('active');
}

function swapChoose(source) {
  document.getElementById('swapOverlay').classList.remove('active');

  // –í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –∏–≥—Ä–æ–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ä—Ç—É –ò–ó –°–í–û–ï–ô –†–£–ö–ò
  const digits = G.player.hand
    .map((card, idx) => ({ card, idx }))
    .filter(({ card }) => card.type === 'digit');
  if (!digits.length) { addLog('–ù–µ—Ç —Ü–∏—Ñ—Ä –≤ —Ä—É–∫–µ –¥–ª—è –∑–∞–º–µ–Ω—ã'); resolveRound(); return; }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º ('hand'=—Å–≤–æ—é, 'opp'=–∫–∞—Ä—Ç—É –ò–ò)
  G._swapTarget = source;

  // –í–∫–ª—é—á–∞–µ–º dim-—Ä–µ–∂–∏–º
  const handEl = document.getElementById('playerHand');
  if (handEl) handEl.classList.add('swap-selecting');
  G._swapMode = true;

  const who = source === 'hand'
    ? '—Å–≤–æ—é –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ'
    : '–∫–∞—Ä—Ç—É –ò–ò –Ω–∞ —Å—Ç–æ–ª–µ';
  setStatus(`üîÑ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏ ‚Äî –∑–∞–º–µ–Ω–∏—Ç ${who}`, 'highlight');
  updateUI();
}

function cancelSwap() {
  document.getElementById('swapOverlay').classList.remove('active');
  G._swapMode = false;
  const handEl = document.getElementById('playerHand');
  if (handEl) handEl.classList.remove('swap-selecting');
  resolveRound();
}

function finishSwapFromHand(idx) {
  G._swapMode = false;
  const handEl = document.getElementById('playerHand');
  if (handEl) handEl.classList.remove('swap-selecting');

  const card = G.player.hand[idx];
  if (!card || card.type !== 'digit') { resolveRound(); return; }

  G.player.hand.splice(idx, 1);

  if (G._swapTarget === 'opp') {
    // –ó–∞–º–µ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ò–ò –Ω–∞ —Å—Ç–æ–ª–µ; –∫–∞—Ä—Ç–∞ –ò–ò ‚Üí –≤ —Ä—É–∫—É –∏–≥—Ä–æ–∫–∞ —Å –∑–µ–ª—ë–Ω–æ–π —Ä–∞–º–∫–æ–π
    const displaced = G.table.aiCard;
    G.table.aiCard = card;
    if (displaced) {
      displaced._reanimated = true; // –∑–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞
      G.player.hand.push(displaced);
      addLog(`–ó–∞–º–µ–Ω–∞: –≤–∞—à ${card.value} –≤—Å—Ç–∞–ª –Ω–∞ –º–µ—Å—Ç–æ –ò–ò (${displaced.value}), –∫–∞—Ä—Ç–∞ –ò–ò —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å`, 'good');
    } else {
      addLog(`–ó–∞–º–µ–Ω–∞: –≤–∞—à ${card.value} –≤—Å—Ç–∞–ª –Ω–∞ –º–µ—Å—Ç–æ –ò–ò`, 'good');
    }
  } else {
    // –ó–∞–º–µ–Ω—è–µ–º —Å–≤–æ—é –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ; —Å—Ç–∞—Ä–∞—è —Å–≤–æ—è ‚Üí –≤ —Ä—É–∫—É —Å –∑–µ–ª—ë–Ω–æ–π —Ä–∞–º–∫–æ–π
    const displaced = G.table.playerCard;
    G.table.playerCard = card;
    if (displaced) {
      displaced._reanimated = true; // –∑–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞
      G.player.hand.push(displaced);
      addLog(`–ó–∞–º–µ–Ω–∞: ${displaced.value} ‚Üí ${card.value} –Ω–∞ —Å—Ç–æ–ª–µ, —Å—Ç–∞—Ä–∞—è –∫–∞—Ä—Ç–∞ –≤–µ—Ä–Ω—É–ª–∞—Å—å –≤ —Ä—É–∫—É`, 'good');
    } else {
      addLog(`–ó–∞–º–µ–Ω–∞: ${card.value} –Ω–∞ —Å—Ç–æ–ª–µ`, 'good');
    }
  }

  G._swapTarget = null;
  updateUI();
  setTimeout(() => resolveRound(), 600);
}

// ---- Freeze counter popup ----
// Shows popup when AI uses a card that targets the player, offering –ó–∞–º–æ—Ä–æ–∑–∫–∞
function offerFreezeCounter(cardName, onFreeze, onAllow) {
  const freezeCard = G.player.hand.find(c => c.effect === 'freeze');
  if (!freezeCard || G.frozenInRound) { onAllow(); return; }
  const freezeIdx = G.player.hand.indexOf(freezeCard);
  openChooseOverlay(
    '–û–ø–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω–∏–ª –∫–∞—Ä—Ç—É',
    `¬´${cardName}¬ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ—Ç–∏–≤ –≤–∞—Å. –•–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?`,
    [{ card: freezeCard, idx: freezeIdx }],
    (chosen) => {
      if (!chosen) { onAllow(); return; }
      G.player.hand.splice(chosen.idx, 1);
      G.frozenInRound = true;
      addLog('‚ùÑ –ó–∞–º–æ—Ä–æ–∑–∫–∞! –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!', 'good');
      updateUI();
      onFreeze();
    },
    true
  );
}

// ---- AI freeze counter (50% usage when player's card targets AI) ----
function aiTryFreeze(cardName, onFreeze, onAllow) {
  const freezeCard = G.ai.hand.find(c => c.effect === 'freeze');
  if (!freezeCard || G.frozenInRound || Math.random() < 0.5) { onAllow(); return; }
  G.ai.hand.splice(G.ai.hand.indexOf(freezeCard), 1);
  G.frozenInRound = true;
  addLog(`‚ùÑ –ò–ò –∑–∞–º–æ—Ä–æ–∑–∏–ª ¬´${cardName}¬ª!`, 'warn');
  updateUI();
  onFreeze();
}

// ---- Shield counter popup (player auto-blocks with –ó–∞—â–∏—Ç–∞) ----
// Called when AI uses –ó–∞–º–µ–Ω–∞/–ö—Ä–∞–∂–∞/–í–æ—Ä–æ–≤—Å—Ç–≤–æ/–ü–æ–¥–º–µ–Ω–∞/–í–µ—Ä—à–∏–Ω–∞ against player
function offerShieldCounter(cardName, onShield, onAllow) {
  const shieldCard = G.player.hand.find(c => c.effect === 'shield');
  if (!shieldCard) { onAllow(); return; }
  const shieldIdx = G.player.hand.indexOf(shieldCard);
  openChooseOverlay(
    '–û–ø–ø–æ–Ω–µ–Ω—Ç –∞—Ç–∞–∫—É–µ—Ç –≤–∞—à–∏ –∫–∞—Ä—Ç—ã!',
    `¬´${cardName}¬ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ—Ç–∏–≤ –≤–∞—Å. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ó–∞—â–∏—Ç—É?`,
    [{ card: shieldCard, idx: shieldIdx }],
    (chosen) => {
      if (!chosen) { onAllow(); return; }
      G.player.hand.splice(chosen.idx, 1);
      G.player.shielded = true;
      addLog('üõ° –ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –ê—Ç–∞–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'good');
      updateUI();
      onShield();
    },
    true
  );
}

// ---- AI shield counter (100% usage when player attacks AI) ----
function aiTryShield(cardName, onShield, onAllow) {
  const shieldCard = G.ai.hand.find(c => c.effect === 'shield');
  if (!shieldCard) { onAllow(); return; }
  G.ai.hand.splice(G.ai.hand.indexOf(shieldCard), 1);
  G.ai.shielded = true;
  addLog(`üõ° –ò–ò –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ó–∞—â–∏—Ç—É –æ—Ç ¬´${cardName}¬ª!`, 'warn');
  updateUI();
  onShield();
}

function aiDoSwap() {
  const digits = G.ai.hand.filter(c => c.type === 'digit');
  if (!digits.length) { resolveRound(); return; }
  const chosen = difficulty === 'hard' ? digits.reduce((a, b) => a.value > b.value ? a : b) : digits[Math.floor(Math.random() * digits.length)];
  // Check if swapping would target player's slot ‚Äî offer shield/freeze to player
  if (G.player.shielded) { addLog('–í—ã –∑–∞—â–∏—â–µ–Ω—ã ‚Äî –ó–∞–º–µ–Ω–∞ –ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'good'); resolveRound(); return; }
  offerShieldCounter('–ó–∞–º–µ–Ω–∞', () => {
    // Blocked by shield ‚Äî AI still swaps its OWN card as consolation
    const old = G.table.aiCard;
    G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
    G.table.aiCard = chosen;
    if (old) G.ai.hand.push(old);
    addLog(`–ò–ò –º–µ–Ω—è–µ—Ç —Å–≤–æ—é –∫–∞—Ä—Ç—É ‚Üí ${chosen.value} (–ó–∞–º–µ–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)`, 'warn');
    updateUI();
    resolveRound();
  }, () => {
    offerFreezeCounter('–ó–∞–º–µ–Ω–∞', () => {
      addLog('–ó–∞–º–µ–Ω–∞ –ò–ò –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!', 'good');
      resolveRound();
    }, () => {
      const old = G.table.aiCard;
      G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
      G.table.aiCard = chosen;
      if (old) G.ai.hand.push(old);
      addLog(`–ò–ò –º–µ–Ω—è–µ—Ç –∫–∞—Ä—Ç—É ‚Üí ${chosen.value}`, 'warn');
      updateUI();
      resolveRound();
    });
  });
}

function useSuperCard(card, who) {
  const opp = who === 'player' ? 'ai' : 'player';
  addLog(`${who === 'player' ? '–í—ã' : '–ò–ò'} –∏–≥—Ä–∞–µ—Ç ${card.nameShort}`, who === 'player' ? 'good' : 'warn');
  logCardPlayed(card, who);
  if (G.frozenInRound && card.effect !== 'shield') { addLog('–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω!', 'warn'); updateUI(); return; }
  switch (card.effect) {
    case 'shield':
      addLog('–ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞—Ç–∞–∫–µ!', 'warn');
      // Put it back ‚Äî shield is passive, can only be used reactively
      G[who].hand.push(card);
      updateUI();
      break;
    case 'freeze':
      G.frozenInRound = true;
      addLog('‚ùÑ –ó–∞–º–æ—Ä–æ–∑–∫–∞! –í—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω—ã', 'warn');
      updateUI();
      break;
    case 'rob':
      if (!G[opp].hand.length) { addLog('–†—É–∫–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –ø—É—Å—Ç–∞'); break; }
      if (who === 'ai') {
        if (G.player.shielded) { addLog('–í—ã –∑–∞—â–∏—â–µ–Ω—ã ‚Äî –í–æ—Ä–æ–≤—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!', 'good'); break; }
        offerShieldCounter('–í–æ—Ä–æ–≤—Å—Ç–≤–æ', () => {
          // blocked
        }, () => {
          offerFreezeCounter('–í–æ—Ä–æ–≤—Å—Ç–≤–æ', () => {
            addLog('–í–æ—Ä–æ–≤—Å—Ç–≤–æ –ò–ò –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ!', 'good');
          }, () => {
            const robbed = G.player.hand.splice(Math.floor(Math.random() * G.player.hand.length), 1)[0];
            G.ai.hand.push(robbed);
            addLog('–ò–ò —É–∫—Ä–∞–ª –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏!', 'warn');
            updateUI();
          });
        });
      } else {
        if (G.ai.shielded) { addLog('–ò–ò –∑–∞—â–∏—â—ë–Ω ‚Äî –í–æ—Ä–æ–≤—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!', 'warn'); break; }
        aiTryShield('–í–æ—Ä–æ–≤—Å—Ç–≤–æ', () => {
          addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –í–æ—Ä–æ–≤—Å—Ç–≤–æ –ó–∞—â–∏—Ç–æ–π!', 'warn');
        }, () => {
          aiTryFreeze('–í–æ—Ä–æ–≤—Å—Ç–≤–æ', () => {
            addLog('–ò–ò –∑–∞–º–æ—Ä–æ–∑–∏–ª –í–æ—Ä–æ–≤—Å—Ç–≤–æ!', 'warn');
          }, () => {
            const robbed = G.ai.hand.splice(Math.floor(Math.random() * G.ai.hand.length), 1)[0];
            G.player.hand.push(robbed);
            addLog('–í—ã —É–∫—Ä–∞–ª–∏ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏ –ò–ò!', 'good');
            updateUI();
          });
        });
      }
      break;
    case 'replace':
      if (who === 'player') offerReplace(); else aiDoReplace();
      break;
    case 'peak':
      doPeak(who);
      break;
  }
}

function offerReplace() {
  const digits = G.player.hand.map((c, i) => ({ card:c, idx:i })).filter(({ card }) => card.type === 'digit');
  if (!digits.length) { addLog('–ù–µ—Ç —Ü–∏—Ñ—Ä –≤ —Ä—É–∫–µ'); return; }
  openChooseOverlay('–ü–æ–¥–º–µ–Ω–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏', digits, (chosen) => {
    if (!chosen) return;
    openConfirm('–ö–∞–∫—É—é –∫–∞—Ä—Ç—É –∑–∞–º–µ–Ω–∏—Ç—å?', `–°–≤–æ—é (${G.table.playerCard?.value}) –∏–ª–∏ –ò–ò (${G.table.aiCard?.value})?`,
      () => {
        // Replace own card ‚Äî no shield/freeze trigger
        const old = G.table.playerCard;
        G.table.playerCard = chosen.card;
        G.player.hand.splice(chosen.idx, 1);
        if (old) G.player.hand.push(old);
        addLog(`–ü–æ–¥–º–µ–Ω–∞ —Å–≤–æ–µ–π ‚Üí ${chosen.card.value}`);
        updateUI();
      },
      () => {
        // Replace AI card ‚Äî AI can shield then freeze
        if (G.ai.shielded) { addLog('–ò–ò –∑–∞—â–∏—â—ë–Ω ‚Äî –ü–æ–¥–º–µ–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'warn'); return; }
        aiTryShield('–ü–æ–¥–º–µ–Ω–∞', () => {
          addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ü–æ–¥–º–µ–Ω—É –ó–∞—â–∏—Ç–æ–π!', 'warn');
        }, () => {
          aiTryFreeze('–ü–æ–¥–º–µ–Ω–∞', () => {
            addLog('–ò–ò –∑–∞–º–æ—Ä–æ–∑–∏–ª –ü–æ–¥–º–µ–Ω—É!', 'warn');
          }, () => {
            const old = G.table.aiCard;
            G.table.aiCard = chosen.card;
            G.player.hand.splice(chosen.idx, 1);
            if (old) G.ai.hand.push(old);
            addLog(`–ü–æ–¥–º–µ–Ω–∞ –∫–∞—Ä—Ç—ã –ò–ò ‚Üí ${chosen.card.value}`, 'good');
            updateUI();
          });
        });
      }
    );
  }, true);
}

function aiDoReplace() {
  const digits = G.ai.hand.filter(c => c.type === 'digit');
  if (!digits.length) return;
  const chosen = difficulty === 'hard' ? digits.reduce((a, b) => a.value > b.value ? a : b) : digits[Math.floor(Math.random() * digits.length)];

  const targetPlayer = difficulty === 'hard' && G.table.playerCard &&
    chosen.value > (G.table.aiCard?.value || 0) &&
    chosen.value < G.table.playerCard.value;

  if (targetPlayer) {
    if (G.player.shielded) { addLog('–í—ã –∑–∞—â–∏—â–µ–Ω—ã ‚Äî –ü–æ–¥–º–µ–Ω–∞ –ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'good'); return; }
    offerShieldCounter('–ü–æ–¥–º–µ–Ω–∞', () => {
      // blocked by shield
    }, () => {
      offerFreezeCounter('–ü–æ–¥–º–µ–Ω–∞', () => {
        addLog('–ü–æ–¥–º–µ–Ω–∞ –ò–ò –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!', 'good');
      }, () => {
        const old = G.table.playerCard;
        G.table.playerCard = chosen;
        G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
        if (old) G.player.hand.push(old);
        addLog(`–ò–ò –ø–æ–¥–º–µ–Ω—è–µ—Ç –≤–∞—à—É –∫–∞—Ä—Ç—É ‚Üí ${chosen.value}`, 'warn');
        updateUI();
      });
    });
  } else {
    const old = G.table.aiCard;
    G.ai.hand.splice(G.ai.hand.indexOf(chosen), 1);
    G.table.aiCard = chosen;
    if (old) G.ai.hand.push(old);
    addLog(`–ò–ò –ø–æ–¥–º–µ–Ω—è–µ—Ç —Å–≤–æ—é –∫–∞—Ä—Ç—É ‚Üí ${chosen.value}`, 'warn');
    updateUI();
  }
}

let _peakCallback = null;

function openPeakOverlay(callback) {
  _peakCallback = callback;
  const hasDigit = G.digitDeck.length > 0;
  const hasEnhance = G.enhanceDeck.length > 0;
  const hasOpp = G.ai.winStack.length > 0;
  const d = document.getElementById('peakBtnDigit');
  const e = document.getElementById('peakBtnEnhance');
  const o = document.getElementById('peakBtnOpp');
  if (d) d.disabled = !hasDigit;
  if (e) e.disabled = !hasEnhance;
  if (o) o.disabled = !hasOpp;
  document.getElementById('peakOverlay').classList.add('active');
}

function peakChoose(source) {
  const cb = _peakCallback; _peakCallback = null;
  hideAllOverlays();
  if (typeof cb === 'function') setTimeout(() => cb(source), 100);
}

function cancelPeak() {
  const cb = _peakCallback; _peakCallback = null;
  hideAllOverlays();
  if (typeof cb === 'function') cb(null);
}

function doPeak(who) {
  if (who === 'player') {
    openPeakOverlay((source) => {
      if (!source) return;
      if (source === 'opp_stack') {
        if (G.ai.shielded) { addLog('–ò–ò –∑–∞—â–∏—â—ë–Ω ‚Äî –í–µ—Ä—à–∏–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'warn'); return; }
        aiTryShield('–í–µ—Ä—à–∏–Ω–∞', () => {
          addLog('–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –í–µ—Ä—à–∏–Ω—É –ó–∞—â–∏—Ç–æ–π!', 'warn');
        }, () => {
          aiTryFreeze('–í–µ—Ä—à–∏–Ω–∞', () => {
            addLog('–ò–ò –∑–∞–º–æ—Ä–æ–∑–∏–ª –í–µ—Ä—à–∏–Ω—É!', 'warn');
          }, () => {
            const ri = Math.floor(Math.random() * G.ai.winStack.length);
            const card = G.ai.winStack.splice(ri, 1)[0];
            if (card) { card._cooldown = true; card._peakNew = true; G.player.hand.push(card); addLog('–í–µ—Ä—à–∏–Ω–∞: –≤–∑—è–ª–∏ –∏–∑ —Å—Ç–æ–ø–∫–∏ –ò–ò!', 'good'); updateUI(); }
          });
        });
      } else {
        let card;
        if (source === 'digit') card = G.digitDeck.pop();
        else if (source === 'enhance') card = G.enhanceDeck.pop();
        if (card) { card._cooldown = true; card._peakNew = true; G.player.hand.push(card); addLog('–í–µ—Ä—à–∏–Ω–∞: –ø–æ–ª—É—á–∏–ª–∏ –∫–∞—Ä—Ç—É!', 'good'); updateUI(); }
      }
    });
  } else {
    // AI: pick random available source
    const opts = [];
    if (G.digitDeck.length) opts.push('digit');
    if (G.enhanceDeck.length) opts.push('enhance');
    if (G.player.winStack.length) opts.push('opp_stack');
    if (!opts.length) { addLog('–í–µ—Ä—à–∏–Ω–∞ –ò–ò: –Ω–µ—Ç –∫–∞—Ä—Ç!', 'warn'); return; }
    const src = opts[Math.floor(Math.random() * opts.length)];
    if (src === 'opp_stack') {
      if (G.player.shielded) { addLog('–í—ã –∑–∞—â–∏—â–µ–Ω—ã ‚Äî –í–µ—Ä—à–∏–Ω–∞ –ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!', 'good'); return; }
      offerShieldCounter('–í–µ—Ä—à–∏–Ω–∞', () => {}, () => {
        offerFreezeCounter('–í–µ—Ä—à–∏–Ω–∞', () => { addLog('–í–µ—Ä—à–∏–Ω–∞ –ò–ò –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!', 'good'); }, () => {
          const ri = Math.floor(Math.random() * G.player.winStack.length);
          const card = G.player.winStack.splice(ri, 1)[0];
          if (card) { card._cooldown = true; G.ai.hand.push(card); addLog('–ò–ò: –í–µ—Ä—à–∏–Ω–∞, –±–µ—Ä—ë—Ç –∏–∑ –≤–∞—à–µ–π —Å—Ç–æ–ø–∫–∏', 'warn'); updateUI(); }
        });
      });
    } else {
      let card;
      if (src === 'digit') card = G.digitDeck.pop();
      else if (src === 'enhance') card = G.enhanceDeck.pop();
      if (card) { card._cooldown = true; G.ai.hand.push(card); addLog('–ò–ò: –í–µ—Ä—à–∏–Ω–∞, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—É', 'warn'); updateUI(); }
    }
  }
}

function startSuperBattle() {
  hideAllOverlays();
  G.phase = 'superbattle';
  G.superBattle = {
    active: true,
    pot: [G.table.playerCard, G.table.aiCard].filter(Boolean),
    playerCardsPlayed: [],
    playerPending: null,
    aiPending: null,
    waitingForPlayer: false,
    round: 0,
    history: [],  // [{playerCard, aiCard}] for all rounds
  };
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—ã–µ –∫–∞—Ä—Ç—ã (–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–µ–ª–∏ –∫ —Å—É–ø–µ—Ä–±–∏—Ç–≤–µ)
  if (G.table.playerCard || G.table.aiCard) {
    G.superBattle.history.push({ playerCard: G.table.playerCard, aiCard: G.table.aiCard });
  }
  if (G.table.playerCard) G.superBattle.playerCardsPlayed.push(G.table.playerCard);
  updateUI();
  document.getElementById('superBattleOverlay').classList.add('active');
}

function closeSuperBattle() {
  document.getElementById('superBattleOverlay').classList.remove('active');
  addLog('‚ö° –°–£–ü–ï–†–ë–ò–¢–í–ê! –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –ª–∏—Ü–æ–º –≤–Ω–∏–∑', 'warn');
  superBattleNextExchange();
}

function superBattleNextExchange() {
  G.superBattle.round++;
  G.superBattle.playerPending = null;
  G.superBattle.aiPending = null;
  const pDigits = G.player.hand.filter(c => c.type === 'digit');
  const aDigits = G.ai.hand.filter(c => c.type === 'digit');
  if (!pDigits.length || !aDigits.length) { superBattleResolveWinner(); return; }
  const aiChosen = difficulty === 'hard' ? aDigits.reduce((a, b) => a.value > b.value ? a : b) : aDigits[Math.floor(Math.random() * aDigits.length)];
  G.ai.hand.splice(G.ai.hand.indexOf(aiChosen), 1);
  G.superBattle.aiPending = aiChosen;
  setStatus('‚ö° –°–£–ü–ï–†–ë–ò–¢–í–ê: –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –ª–∏—Ü–æ–º –≤–Ω–∏–∑!');
  setBtns(false, false);
  G.superBattle.waitingForPlayer = true;
  renderPlayerHand();
}

function superBattlePlayerPick(idx) {
  const card = G.player.hand[idx];
  if (!card || card.type !== 'digit') return;

  // –ë–µ—Ä—ë–º –ø–æ–∑–∏—Ü–∏—é –∫–∞—Ä—Ç—ã –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const fromEl = document.querySelector(`#playerHand .game-card[data-idx="${idx}"]`);
  const fromRect = fromEl ? fromEl.getBoundingClientRect() : null;

  G.player.hand.splice(idx, 1);
  G.superBattle.playerPending = card;
  G.superBattle.playerCardsPlayed.push(card);
  G.superBattle.waitingForPlayer = false;
  G.pendingCard = null;
  renderPlayerHand();
  setStatus('‚ö° –ö–∞—Ä—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è...');

  if (fromRect) {
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é —Å –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–æ–π –∏–≥—Ä–æ–∫–∞ (–ò–ò —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω),
    // —á—Ç–æ–±—ã —Å–ª–æ—Ç playerMainSlot —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    G.superBattle.history.push({ playerCard: null, aiCard: G.superBattle.aiPending });
    renderTable(); // —Ä–∏—Å—É–µ–º —Å–ª–æ—Ç —Å –ø—É—Å—Ç—ã–º –º–µ—Å—Ç–æ–º –∏–≥—Ä–æ–∫–∞

    // –ù–∞—Ö–æ–¥–∏–º —Å–≤–µ–∂–µ—Å–æ–∑–¥–∞–Ω–Ω—ã–π playerMainSlot –∏ –ª–µ—Ç–∏–º –≤ –Ω–µ–≥–æ
    const targetEl = document.getElementById('playerMainSlot');
    const targetRect = targetEl ? targetEl.getBoundingClientRect() : null;
    if (targetRect) {
      flyCardFromRect(card, fromRect, 'playerMainSlot', () => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ–π
        G.superBattle.history[G.superBattle.history.length - 1].playerCard = card;
        setTimeout(() => superBattleReveal(), 300);
      });
    } else {
      G.superBattle.history[G.superBattle.history.length - 1].playerCard = card;
      setTimeout(() => superBattleReveal(), 700);
    }
  } else {
    setTimeout(() => superBattleReveal(), 700);
  }
}

function superBattleReveal() {
  const pCard = G.superBattle.playerPending;
  const aCard = G.superBattle.aiPending;
  G.superBattle.pot.push(pCard, aCard);
  addLog(`‚ö° –í—ã: ${pCard.value} vs –ò–ò: ${aCard.value}`, 'important');
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏ (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ playerPick), –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω–µ—Ç
  const hist = G.superBattle.history;
  const last = hist[hist.length - 1];
  if (last && last.playerCard === pCard && last.aiCard === aCard) {
    // —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  } else if (last && last.playerCard === pCard) {
    last.aiCard = aCard; // –¥–æ–ø–æ–ª–Ω—è–µ–º
  } else {
    hist.push({ playerCard: pCard, aiCard: aCard });
  }
  G.table.playerCard = pCard;
  G.table.aiCard = aCard;
  G.table.playerMod = 0;
  G.table.aiMod = 0;
  updateUI();
  if (pCard.value === aCard.value) {
    addLog('üî• –°–Ω–æ–≤–∞ —Ä–∞–≤–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!', 'warn');
    setStatus('üî• –†–∞–≤–Ω–æ! –ï—â—ë —Ä–∞—É–Ω–¥!');
    setTimeout(() => superBattleNextExchange(), 1200);
  } else {
    setTimeout(() => superBattleResolveWinner(), 800);
  }
}

function superBattleResolveWinner() {
  const pot = G.superBattle.pot;
  G.phase = 'resolve';
  const pCard = G.superBattle.playerPending;
  const aCard = G.superBattle.aiPending;
  const pHad = !!pCard;
  const aHad = !!aCard;
  let winner;
  if (!pHad && !aHad) winner = 'draw';
  else if (!pHad) winner = 'ai';
  else if (!aHad) winner = 'player';
  else if (pCard.value > aCard.value) winner = 'player';
  else if (aCard.value > pCard.value) winner = 'ai';
  else winner = 'draw';
  if (winner === 'player') {
    const potDigits = pot.filter(pc => pc && pc.type === 'digit');
    // –ë–∞—Ñ—Ñ—ã/—Å—É–ø–µ—Ä—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ logCardPlayed
    G.player.winStack.push(...potDigits);
    addLog('‚úÖ –í—ã –ø–æ–±–µ–¥–∏–ª–∏ –≤ –°—É–ø–µ—Ä–±–∏—Ç–≤–µ!', 'good');
    showResultBanner('win', `‚ö° –°—É–ø–µ—Ä–±–∏—Ç–≤–∞ –≤–∞—à–∞! +${pot.length} –∫–∞—Ä—Ç`);
    updateUI();
    setTimeout(() => offerPlayerSupers(), 2000);
  } else if (winner === 'ai') {
    const potDigits2 = pot.filter(pc => pc && pc.type === 'digit');
    // –ë–∞—Ñ—Ñ—ã/—Å—É–ø–µ—Ä—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ logCardPlayed
    G.ai.winStack.push(...potDigits2);
    G.player.lastLost = (G.superBattle.playerCardsPlayed || []).filter(pc => pc.type === 'digit');
    G.player.lastRoundLost = true;
    addLog('‚ùå –ò–ò –ø–æ–±–µ–¥–∏–ª –≤ –°—É–ø–µ—Ä–±–∏—Ç–≤–µ!', 'warn');
    showResultBanner('lose', `‚ö° –ò–ò –∑–∞–±–∏—Ä–∞–µ—Ç ${pot.length} –∫–∞—Ä—Ç`);
    updateUI();
    setTimeout(() => offerPlayerBuffs(), 2000);
  } else {
    // –ù–∏—á—å—è –≤ —Å—É–ø–µ—Ä–±–∏—Ç–≤–µ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –µ—â—ë —Ä–∞—É–Ω–¥
    const pDigits = G.player.hand.filter(c => c.type === 'digit');
    const aDigits = G.ai.hand.filter(c => c.type === 'digit');
    if (pDigits.length > 0 && aDigits.length > 0) {
      addLog('üî• –ù–∏—á—å—è –≤ –°—É–ø–µ—Ä–±–∏—Ç–≤–µ! –ï—â—ë —Ä–∞—É–Ω–¥!', 'warn');
      setStatus('üî• –ù–∏—á—å—è! –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!');
      updateUI();
      setTimeout(() => superBattleNextExchange(), 1000);
    } else {
      // –ù–µ—Ç —Ü–∏—Ñ—Ä ‚Äî –¥–µ–ª–∏–º –ø–æ—Ä–æ–≤–Ω—É
      const potD = pot.filter(pc => pc && pc.type === 'digit');
      const half = Math.floor(potD.length / 2);
      G.player.winStack.push(...potD.slice(0, half));
      G.ai.winStack.push(...potD.slice(half));
      addLog('ü§ù –ù–∏—á—å—è ‚Äî –∫–∞—Ä—Ç—ã –¥–µ–ª—è—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É');
      updateUI();
      setTimeout(() => afterRound('draw'), 1500);
    }
  }
}

function afterRound(winner) {
  const pH = G.player.hand.length;
  const aH = G.ai.hand.length;
  if (winner === 'player') {
    dealTo('player', 'digit');
    if (pH < 9) dealTo('player', Math.random() < 0.5 ? 'buff' : 'super');
    const aiNoEnh = G.ai.hand.filter(c => c.type !== 'digit').length === 0;
    if (aiNoEnh && Math.random() < 0.5) dealTo('ai', 'buff'); else dealTo('ai', 'digit');
  } else if (winner === 'ai') {
    dealTo('ai', 'digit');
    if (aH < 9) dealTo('ai', Math.random() < 0.5 ? 'buff' : 'super');
    dealTo('player', 'digit');
  } else {
    dealTo('player', 'digit');
    dealTo('ai', 'digit');
  }
  updateUI();
  if (!checkGameOver()) setTimeout(() => startRound(), 400);
}

function checkGameOver() {
  const pD = G.player.hand.filter(c => c.type === 'digit').length;
  const aD = G.ai.hand.filter(c => c.type === 'digit').length;
  if (pD === 0 || aD === 0) { G.gameOver = true; setTimeout(() => endGame(), 500); return true; }
  return false;
}

function endGame() {
  const pScore = calcScore(G.player.winStack);
  const aScore = calcScore(G.ai.winStack);
  const won = pScore > aScore;
  const draw = pScore === aScore;

  // Save result to account
  if (!draw) recordGameResult(won);
  const pD = G.player.winStack.filter(c => c.type==='digit').reduce((s,c)=>s+c.value,0);
  const pB = G.player.winStack.filter(c => c.type==='buff').length * 3;
  const pS = G.player.winStack.filter(c => c.type==='super').length * 7;
  const aD = G.ai.winStack.filter(c => c.type==='digit').reduce((s,c)=>s+c.value,0);
  const aB = G.ai.winStack.filter(c => c.type==='buff').length * 3;
  const aS = G.ai.winStack.filter(c => c.type==='super').length * 7;
  showScreen('endScreen');
  setText('endIcon', draw ? 'ü§ù' : won ? 'üèÜ' : 'üíÄ');
  const re = document.getElementById('endResult');
  if (re) { re.className = 'end-result ' + (draw ? 'draw' : won ? 'win' : 'lose'); re.textContent = draw ? '–ù–ò–ß–¨–Ø' : won ? '–ü–û–ë–ï–î–ê' : '–ü–û–†–ê–ñ–ï–ù–ò–ï'; }
  setText('endSub', `${pScore} : ${aScore} (–í—ã : –ò–ò)`);
  const sb = document.getElementById('scoreBreakdown');
  if (sb) sb.innerHTML = `
    <div class="breakdown-row"><span class="breakdown-label">üü° –í–∞—à–∏ —Ü–∏—Ñ—Ä—ã</span><span class="breakdown-val">${pD}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">üü† –í–∞—à–∏ –±–∞—Ñ—Ñ—ã (√ó3)</span><span class="breakdown-val">+${pB}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">üî¥ –í–∞—à–∏ —Å—É–ø–µ—Ä–∫–∞—Ä—Ç—ã (√ó7)</span><span class="breakdown-val">+${pS}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">üèÜ –í–ê–® –ò–¢–û–ì</span><span class="breakdown-val">${pScore}</span></div>
    <div class="breakdown-row" style="margin-top:12px"><span class="breakdown-label">üü° –¶–∏—Ñ—Ä—ã –ò–ò</span><span class="breakdown-val">${aD}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">üü† –ë–∞—Ñ—Ñ—ã –ò–ò (√ó3)</span><span class="breakdown-val">+${aB}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">üî¥ –°—É–ø–µ—Ä–∫–∞—Ä—Ç—ã –ò–ò (√ó7)</span><span class="breakdown-val">+${aS}</span></div>
    <div class="breakdown-row"><span class="breakdown-label">ü§ñ –ò–¢–û–ì –ò–ò</span><span class="breakdown-val">${aScore}</span></div>`;
}

const _cb = { choose: null, confirmOk: null, confirmNo: null };

let _chooseTimer = null;

function _clearChooseTimer() {
  if (_chooseTimer) { clearInterval(_chooseTimer); _chooseTimer = null; }
  const bar = document.getElementById('chooseTimerBar');
  if (bar) bar.style.width = '100%';
}

function openChooseOverlay(title, body, items, callback, allowCancel=false) {
  _clearChooseTimer();
  _cb.choose = callback;
  setText('chooseTitle', title);
  setText('chooseBody', body);
  const container = document.getElementById('chooseCards');
  container.innerHTML = '';
  items.forEach(item => {
    const card = item.card;
    const type = ['digit','buff','super'].includes(card.type) ? card.type : 'buff';
    const div = document.createElement('div');
    div.className = `popup-card-select game-card ${type}`;
    div.style.cssText = 'width:96px;height:134px;';
    if (card.type === 'digit' && card.value) {
      div.innerHTML = `<div class="card-value">${card.value}</div>`;
    } else {
      div.innerHTML = `<div class="card-name" style="font-size:0.5rem;font-weight:800;text-align:center;padding:4px;line-height:1.3;">${card.nameShort || card.label || '?'}</div>`;
    }
    if (card.desc) div.setAttribute('data-desc', card.desc);
    div.onclick = () => {
      if (typeof _cb.choose !== 'function') return;
      _clearChooseTimer();
      document.querySelectorAll('.popup-card-select').forEach(c => c.classList.remove('chosen'));
      div.classList.add('chosen');
      const cb = _cb.choose;
      _cb.choose = null;
      setTimeout(() => { hideAllOverlays(); cb(item); }, 200);
    };
    container.appendChild(div);
  });
  const cancelBtn = document.querySelector('#chooseOverlay .popup-btn-secondary');
  if (cancelBtn) cancelBtn.style.display = allowCancel ? '' : 'none';
  document.getElementById('chooseOverlay').classList.add('active');

  // –¢–∞–π–º–µ—Ä 5 —Å–µ–∫—É–Ω–¥
  const bar = document.getElementById('chooseTimerBar');
  if (bar) bar.style.width = '100%';
  const duration = 7000;
  const start = performance.now();
  _chooseTimer = setInterval(() => {
    const elapsed = performance.now() - start;
    const pct = Math.max(0, 1 - elapsed / duration);
    if (bar) {
      bar.style.width = (pct * 100) + '%';
      bar.style.background = pct > 0.4 ? 'var(--yellow)' : pct > 0.2 ? 'var(--orange)' : 'var(--red)';
    }
    if (elapsed >= duration) {
      _clearChooseTimer();
      const cb = _cb.choose; _cb.choose = null;
      hideAllOverlays();
      if (typeof cb === 'function') cb(null);
    }
  }, 100);
}

function cancelChoose() {
  _clearChooseTimer();
  const cb = _cb.choose; _cb.choose = null;
  hideAllOverlays();
  if (typeof cb === 'function') cb(null);
}

function openConfirm(title, body, okCb, noCb) {
  _cb.confirmOk = okCb; _cb.confirmNo = noCb;
  setText('confirmTitle', title);
  setText('confirmBody', body);
  document.getElementById('confirmOverlay').classList.add('active');
}

function confirmOk() {
  const cb = _cb.confirmOk; _cb.confirmOk = null; _cb.confirmNo = null;
  hideAllOverlays();
  if (typeof cb === 'function') cb();
}

function cancelConfirm() {
  const cb = _cb.confirmNo; _cb.confirmOk = null; _cb.confirmNo = null;
  hideAllOverlays();
  if (typeof cb === 'function') cb();
}

function hideAllOverlays() {
  document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showModeSelect() {
  document.getElementById('modeSelect').style.display = 'flex';
  document.getElementById('soloPanel').style.display = 'none';
  document.getElementById('multiPanel').style.display = 'none';
  document.getElementById('friendPanel').style.display = 'none';
  document.getElementById('createRoomPanel').style.display = 'none';
}

function showSoloPanel() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('soloPanel').style.display = 'flex';
  document.getElementById('multiPanel').style.display = 'none';
}

function showMultiPanel() {
  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('soloPanel').style.display = 'none';
  document.getElementById('multiPanel').style.display = 'flex';
  document.getElementById('friendPanel').style.display = 'none';
  document.getElementById('createRoomPanel').style.display = 'none';
  // Show nickname or warning
  const nick = currentUser && currentUser.displayName ? currentUser.displayName : '';
  const dispEl = document.getElementById('mpNicknameDisplay');
  const valEl  = document.getElementById('mpNicknameValue');
  const warnEl = document.getElementById('mpNoNickWarn');
  if (nick) {
    if (dispEl) { dispEl.style.display = ''; }
    if (valEl)  { valEl.textContent = nick; }
    if (warnEl) { warnEl.style.display = 'none'; }
  } else {
    if (dispEl) { dispEl.style.display = 'none'; }
    if (warnEl) { warnEl.style.display = ''; }
  }
}

async function checkFbStatus() {
  const dot  = document.getElementById('fbStatusDot');
  const text = document.getElementById('fbStatusText');
  const bar  = document.getElementById('fbStatusBar');
  if (!dot || !text) return;

  _fbAvailable = null;
  dot.style.background = 'var(--yellow)';
  dot.style.animation = 'spin 0.6s linear infinite';
  text.style.color = 'var(--yellow)';
  text.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase...';

  // Direct check with error capture
  let errMsg = '';
  let httpStatus = '';
  try {
    const r = await Promise.race([
      fetch(FB_URL + '/.json?shallow=true'),
      new Promise((_, rej) => setTimeout(() => rej(new Error('timeout 4s')), 4000))
    ]);
    httpStatus = r.status;
    if (r.ok) {
      _fbAvailable = true;
    } else {
      _fbAvailable = false;
      const body = await r.text().catch(() => '');
      errMsg = 'HTTP ' + r.status + (body ? ': ' + body.slice(0, 60) : '');
    }
  } catch(e) {
    _fbAvailable = false;
    errMsg = e.message;
  }

  dot.style.animation = '';
  if (_fbAvailable) {
    dot.style.background = 'var(--green)';
    text.style.color = 'var(--green)';
    text.textContent = '‚úÖ Firebase –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç';
    if (bar) { bar.style.borderColor = 'var(--green)'; setTimeout(() => { if(bar) bar.style.borderColor = 'var(--bg3)'; }, 3000); }
  } else {
    dot.style.background = 'var(--red)';
    text.style.color = 'var(--red)';
    text.textContent = '‚ùå ' + (errMsg || 'Failed to fetch') + ' | ' + (location.protocol === 'file:' ? 'file://' : location.hostname);
    if (bar) { bar.style.borderColor = 'var(--red)'; setTimeout(() => { if(bar) bar.style.borderColor = 'var(--bg3)'; }, 6000); }
  }
}

function showFriendPanel() {
  document.getElementById('multiPanel').style.display = 'none';
  document.getElementById('friendPanel').style.display = 'flex';
  document.getElementById('createRoomPanel').style.display = 'none';
  document.getElementById('joinRoomError').textContent = '';
  // Auto-check Firebase status when panel opens
  setTimeout(checkFbStatus, 200);
  // Check if URL has a room code to pre-fill
  const urlCode = getCodeFromUrl();
  if (urlCode) {
    const input = document.getElementById('joinRoomCode');
    if (input) { input.value = urlCode; input.style.borderColor = 'var(--yellow)'; }
  }
}

function showCreateRoomPanel() {
  document.getElementById('friendPanel').style.display = 'none';
  document.getElementById('createRoomPanel').style.display = 'flex';
  document.getElementById('createRoomPass').value = '';
  document.getElementById('createRoomPass').style.borderColor = 'var(--bg)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTIPLAYER ENGINE  ‚Äî  Firebase Realtime Database
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Firebase URL ‚Äî –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–π–¥–∏ –≤ console.firebase.google.com
// –∏ —Å–∫–æ–ø–∏—Ä—É–π —Ç–æ—á–Ω—ã–π URL —Å–≤–æ–µ–π Realtime Database
const FB_URL = 'https://numberbattle-23d02-default-rtdb.europe-west1.firebasedatabase.app';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE LAYER ‚Äî Firebase —Å –∞–≤—Ç–æ—Ñ–æ–ª–±–µ–∫–æ–º –Ω–∞ localStorage
// –í —Ä–µ–∞–ª—å–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ = Firebase (–º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏)
// –í iframe Claude.ai = localStorage (–º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _fbAvailable = null; // null=–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏, true=–µ—Å—Ç—å, false=–Ω–µ—Ç

async function fbDetect() {
  if (_fbAvailable !== null) return _fbAvailable;
  try {
    const r = await Promise.race([
      fetch(FB_URL + '/.json?shallow=true'),
      new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 4000))
    ]);
    _fbAvailable = r.ok;
  } catch(e) {
    _fbAvailable = false;
  }
  return _fbAvailable;
}

// ‚îÄ‚îÄ localStorage helpers (fallback) ‚îÄ‚îÄ
function lsSet(path, data) {
  try { localStorage.setItem('fb:' + path, JSON.stringify({ ...data, _ts: Date.now() })); } catch(e) {}
}
function lsGet(path) {
  try { const r = localStorage.getItem('fb:' + path); return r ? JSON.parse(r) : null; } catch(e) { return null; }
}
function lsDel(path) {
  try { localStorage.removeItem('fb:' + path); } catch(e) {}
}
function lsPatch(path, data) {
  const existing = lsGet(path) || {};
  lsSet(path, { ...existing, ...data });
}

// ‚îÄ‚îÄ Unified Firebase REST helpers (—Å –∞–≤—Ç–æ—Ñ–æ–ª–±–µ–∫–æ–º) ‚îÄ‚îÄ
async function fbSet(path, data) {
  if (await fbDetect()) {
    const r = await fetch(`${FB_URL}/${path}.json`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!r.ok) throw new Error('fbSet failed: ' + r.status);
    return r.json();
  } else {
    lsSet(path, data);
    return data;
  }
}

async function fbPatch(path, data) {
  if (await fbDetect()) {
    const r = await fetch(`${FB_URL}/${path}.json`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!r.ok) throw new Error('fbPatch failed: ' + r.status);
    return r.json();
  } else {
    lsPatch(path, data);
    return data;
  }
}

async function fbGet(path) {
  if (await fbDetect()) {
    const r = await fetch(`${FB_URL}/${path}.json`);
    if (!r.ok) throw new Error('fbGet failed: ' + r.status);
    return r.json();
  } else {
    return lsGet(path);
  }
}

async function fbDelete(path) {
  if (await fbDetect()) {
    await fetch(`${FB_URL}/${path}.json`, { method: 'DELETE' });
  } else {
    lsDel(path);
  }
}

// ‚îÄ‚îÄ MP state ‚îÄ‚îÄ
let MP = {
  active: false,
  role: null,
  roomId: null,
  myId: null,
  opponentId: null,
  nickname: '',
  opponentNickname: '',
  pollInterval: null,
  timerInterval: null,
  searchStart: null,
};
let MP_pollGame  = null;
let MP_myTurn    = false;
let _lastSeenSeq = 0;

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
}

// ‚îÄ‚îÄ Matchmaking entry point ‚îÄ‚îÄ
async function startMatchmaking() {
  MP.nickname    = (currentUser && currentUser.displayName) ? currentUser.displayName : ('–ò–≥—Ä–æ–∫_' + Math.floor(Math.random()*9000+1000));
  MP.myId        = genId();
  MP.active      = false;
  MP.role        = null;
  MP.roomId      = null;
  MP.opponentId  = null;
  MP.searchStart = Date.now();
  _lastSeenSeq   = 0;

  showScreen('matchmakingScreen');
  document.getElementById('mmFound').style.display = 'none';
  document.getElementById('mmStatus').textContent  = '–ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...';
  document.getElementById('mmSubstatus').textContent = '–û–∂–∏–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤';
  document.getElementById('mmOnlineCount').textContent = '‚Äî';
  document.getElementById('mmSearchingCount').textContent = '‚Äî';

  startMmTimer();

  try {
    // Write our presence to lobby
    await fbSet(`lobby/${MP.myId}`, {
      id: MP.myId, nick: MP.nickname, ts: Date.now(), status: 'searching'
    });
  } catch(e) { console.error('FB write error', e); }

  startMmPoll();
}

// ‚îÄ‚îÄ Timer ‚îÄ‚îÄ
function startMmTimer() {
  if (MP.timerInterval) clearInterval(MP.timerInterval);
  MP.timerInterval = setInterval(() => {
    const secs = Math.floor((Date.now() - MP.searchStart) / 1000);
    const el = document.getElementById('mmTimer');
    if (el) el.textContent = Math.floor(secs/60) + ':' + String(secs%60).padStart(2,'0');
  }, 500);
}
function stopMmTimer() {
  if (MP.timerInterval) { clearInterval(MP.timerInterval); MP.timerInterval = null; }
}

// ‚îÄ‚îÄ Matchmaking poll ‚îÄ‚îÄ
function startMmPoll() {
  if (MP.pollInterval) clearInterval(MP.pollInterval);
  MP.pollInterval = setInterval(mmTick, 1500);
  mmTick();
}
function stopMatchmakingPoll() {
  if (MP.pollInterval) { clearInterval(MP.pollInterval); MP.pollInterval = null; }
}

async function mmTick() {
  if (!document.getElementById('matchmakingScreen')?.classList.contains('active')) {
    stopMatchmakingPoll(); return;
  }
  try {
    // Refresh our heartbeat
    await fbPatch(`lobby/${MP.myId}`, { ts: Date.now() });

    // Check if we've been matched by someone else
    const myEntry = await fbGet(`lobby/${MP.myId}`);
    if (myEntry && myEntry.status === 'matched' && myEntry.roomId && MP.role === null) {
      await connectAsGuest(myEntry.roomId, myEntry.hostNick || '–ò–≥—Ä–æ–∫');
      return;
    }

    // Read all lobby entries
    const lobby = await fbGet('lobby');
    if (!lobby) return;

    const now = Date.now();
    const entries = Object.values(lobby);
    const alive   = entries.filter(p => now - (p.ts||0) < 30000);
    const others  = alive.filter(p => p.id !== MP.myId && p.status === 'searching');

    // Update counters
    const el_o = document.getElementById('mmOnlineCount');
    const el_s = document.getElementById('mmSearchingCount');
    if (el_o) el_o.textContent = alive.length;
    if (el_s) el_s.textContent = others.length;
    updateRadarDots(others);

    // Try to host
    if (MP.role === null && others.length > 0) {
      await tryBecomeHost(others[0]);
    }

    // Clean up stale entries (only clean our own if stale logic needed)
  } catch(e) { console.error('mmTick error', e); }
}

function updateRadarDots(others) {
  const radar = document.querySelector('.mm-radar');
  if (!radar) return;
  radar.querySelectorAll('.mm-opp-dot').forEach(d => d.remove());
  others.slice(0, 3).forEach((p, i) => {
    const dot = document.createElement('div');
    dot.className = 'mm-opp-dot';
    dot.title = p.nick || '?';
    const angle = (i / 3) * Math.PI * 2 - Math.PI / 2;
    const cx = 80 + Math.cos(angle) * 55;
    const cy = 80 + Math.sin(angle) * 55;
    dot.style.left = (cx - 11) + 'px';
    dot.style.top  = (cy - 11) + 'px';
    radar.appendChild(dot);
  });
}

// ‚îÄ‚îÄ Become host ‚îÄ‚îÄ
async function tryBecomeHost(opponent) {
  if (MP.role !== null) return;

  // Re-read to confirm still searching
  const fresh = await fbGet(`lobby/${opponent.id}`);
  if (!fresh || fresh.status !== 'searching') return;

  MP.role             = 'host';
  MP.roomId           = 'r' + genId();
  MP.opponentId       = opponent.id;
  MP.opponentNickname = opponent.nick || '–ò–≥—Ä–æ–∫';

  // Init game
  initGame();

  // Write room
  await fbSet(`rooms/${MP.roomId}`, {
    id: MP.roomId,
    hostId:    MP.myId,   hostNick: MP.nickname,
    guestId:   opponent.id, guestNick: opponent.nick,
    created:   Date.now(),
    status:    'waiting',
    seq:       0,
    hostAct:   null,
    guestAct:  null,
  });

  // Write initial game state
  await mpWriteGameState();

  // Update opponent lobby entry ‚Üí matched
  await fbPatch(`lobby/${opponent.id}`, {
    status: 'matched', roomId: MP.roomId, hostNick: MP.nickname
  });

  // Update our own lobby entry
  await fbPatch(`lobby/${MP.myId}`, { status: 'matched', roomId: MP.roomId });

  showOpponentFound(opponent.nick || '–ò–≥—Ä–æ–∫');
  setTimeout(() => startMpGame('host'), 2500);
}

// ‚îÄ‚îÄ Connect as guest ‚îÄ‚îÄ
async function connectAsGuest(roomId, hostNick) {
  if (MP.role !== null) return;
  MP.role   = 'guest';
  MP.roomId = roomId;

  const room = await fbGet(`rooms/${roomId}`);
  if (!room) { MP.role = null; return; }

  MP.opponentId       = room.hostId;
  MP.opponentNickname = room.hostNick || hostNick || '–ò–≥—Ä–æ–∫';

  // Load game state from host
  const gs = await fbGet(`rooms/${roomId}/state`);
  if (gs) { try { deserializeGameState(gs); } catch(e) {} }

  showOpponentFound(MP.opponentNickname);
  setTimeout(() => startMpGame('guest'), 2500);
}

function showOpponentFound(name) {
  stopMatchmakingPoll();
  stopMmTimer();
  const el_s = document.getElementById('mmStatus');
  const el_sub = document.getElementById('mmSubstatus');
  const el_f = document.getElementById('mmFound');
  const el_n = document.getElementById('mmOpponentName');
  if (el_s)   el_s.textContent = '';
  if (el_sub) el_sub.textContent = '';
  if (el_f)   el_f.style.display = 'flex';
  if (el_n)   el_n.textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫: ' + name;
}

async function cancelMatchmaking() {
  stopMatchmakingPoll();
  stopMmTimer();
  MP.active = false;
  MP.role   = null;
  try { await fbDelete(`lobby/${MP.myId}`); } catch(e) {}
  goIntro();
  showModeSelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTIPLAYER GAME FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function startMpGame(role) {
  stopMatchmakingPoll();
  stopMmTimer();
  MP.active = true;
  MP_myTurn = (role === 'host');

  showScreen('gameScreen');
  const diffBadge = document.getElementById('diffBadge');
  if (diffBadge) diffBadge.innerHTML = '‚öî –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†';
  const aiName = document.getElementById('aiName');
  if (aiName) aiName.textContent = 'üë§ ' + MP.opponentNickname;

  addLog('‚öî –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'important');
  addLog('–°–æ–ø–µ—Ä–Ω–∏–∫: ' + MP.opponentNickname, 'important');

  if (role === 'host') {
    addLog('üü¢ –í–∞—à —Ö–æ–¥ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É', 'good');
    startRound();
    updateUI();
    await mpWriteGameState();
  } else {
    addLog('‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –æ–∂–∏–¥–∞–µ–º...', 'warn');
    startRound();
    updateUI();
  }

  mpUpdateTurnUI();
  startGamePoll();
}

function mpUpdateTurnUI() {
  if (MP_myTurn) setStatus('üü¢ –í–∞—à —Ö–æ–¥ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Ü–∏—Ñ—Ä—ã');
  else           setStatus('‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...');
}

// ‚îÄ‚îÄ Game state serialization (compact) ‚îÄ‚îÄ
function serializeGameState() {
  return {
    dDeck: G.digitDeck.map(c => c.value),
    bDeck: G.buffDeck.map(c => c.nameShort),
    sDeck: G.superDeck.map(c => c.nameShort),
    pH:    G.player.hand.map(c => ({ t: c.type, v: c.value, n: c.nameShort, e: c.effect })),
    aH:    G.ai.hand.map(c =>    ({ t: c.type, v: c.value, n: c.nameShort, e: c.effect })),
    pW:    G.player.winStack.map(c => ({ t: c.type, v: c.value, n: c.nameShort, e: c.effect })),
    aW:    G.ai.winStack.map(c =>    ({ t: c.type, v: c.value, n: c.nameShort, e: c.effect })),
    tbl:   {
      pC: G.table.playerCard  ? { t: G.table.playerCard.type,  v: G.table.playerCard.value,  n: G.table.playerCard.nameShort,  e: G.table.playerCard.effect }  : null,
      aC: G.table.aiCard      ? { t: G.table.aiCard.type,      v: G.table.aiCard.value,      n: G.table.aiCard.nameShort,      e: G.table.aiCard.effect }      : null,
      pM: G.table.playerMod, aM: G.table.aiMod,
    },
    rnd:   G.round,
    phase: G.phase,
    frz:   G.frozenInRound,
  };
}

function cardFromSerial(o) {
  if (!o) return null;
  const BUFF_MAP = {};
  const SUPER_MAP = {};
  [...(ALL_BUFF_CARDS || []), ...(ALL_SUPER_CARDS || [])].forEach(c => {
    if (c.type === 'buff')  BUFF_MAP[c.nameShort]  = c;
    if (c.type === 'super') SUPER_MAP[c.nameShort] = c;
  });
  if (o.t === 'digit') return { type:'digit', value: o.v };
  if (o.t === 'buff')  return BUFF_MAP[o.n]  || { type:'buff',  nameShort: o.n, effect: o.e, desc: '' };
  if (o.t === 'super') return SUPER_MAP[o.n] || { type:'super', nameShort: o.n, effect: o.e, desc: '' };
  return null;
}

function deserializeGameState(s) {
  if (!s) return;
  const myIsHost = MP.role === 'host';
  // Digit deck rebuild from values
  if (s.dDeck) G.digitDeck = s.dDeck.map(v => ({ type:'digit', value: v }));
  // Hands: host = player, guest = ai from host's perspective
  const rawPH = myIsHost ? s.pH : s.aH;
  const rawAH = myIsHost ? s.aH : s.pH;
  const rawPW = myIsHost ? s.pW : s.aW;
  const rawAW = myIsHost ? s.aW : s.pW;
  G.player.hand      = (rawPH || []).map(cardFromSerial).filter(Boolean);
  G.ai.hand          = (rawAH || []).map(cardFromSerial).filter(Boolean);
  G.player.winStack  = (rawPW || []).map(cardFromSerial).filter(Boolean);
  G.ai.winStack      = (rawAW || []).map(cardFromSerial).filter(Boolean);
  if (s.tbl) {
    G.table.playerCard = myIsHost ? cardFromSerial(s.tbl.pC) : cardFromSerial(s.tbl.aC);
    G.table.aiCard     = myIsHost ? cardFromSerial(s.tbl.aC) : cardFromSerial(s.tbl.pC);
    G.table.playerMod  = myIsHost ? (s.tbl.pM||0) : (s.tbl.aM||0);
    G.table.aiMod      = myIsHost ? (s.tbl.aM||0) : (s.tbl.pM||0);
  }
  G.round         = s.rnd  || G.round;
  G.phase         = s.phase || G.phase;
  G.frozenInRound = s.frz  || false;
}

// ‚îÄ‚îÄ Write game state to Firebase (host only) ‚îÄ‚îÄ
async function mpWriteGameState() {
  if (!MP.roomId) return;
  try {
    await fbSet(`rooms/${MP.roomId}/state`, serializeGameState());
  } catch(e) { console.error('mpWriteGameState error', e); }
}

// ‚îÄ‚îÄ Send action to Firebase ‚îÄ‚îÄ
async function mpSendAction(type, payload) {
  if (!MP.active || !MP.roomId) return;
  try {
    const seq = ++_lastSeenSeq;
    const act = { type, payload, by: MP.myId, seq, ts: Date.now() };
    const field = MP.role === 'host' ? 'hostAct' : 'guestAct';
    const patch = { [field]: act, seq };
    if (MP.role === 'host') {
      patch.state = serializeGameState();
    }
    await fbPatch(`rooms/${MP.roomId}`, patch);
    MP_myTurn = false;
    mpUpdateTurnUI();
    showMpWaiting(true);
  } catch(e) { console.error('mpSendAction error', e); }
}

// ‚îÄ‚îÄ Poll for opponent actions ‚îÄ‚îÄ
function startGamePoll() {
  if (MP_pollGame) clearInterval(MP_pollGame);
  MP_pollGame = setInterval(mpPollTick, 1000);
}

async function mpPollTick() {
  if (!MP.active) { clearInterval(MP_pollGame); return; }
  try {
    const room = await fbGet(`rooms/${MP.roomId}`);
    if (!room) return;

    const oppAct = MP.role === 'host' ? room.guestAct : room.hostAct;
    if (oppAct && oppAct.by === MP.opponentId && oppAct.seq !== _lastSeenSeq) {
      _lastSeenSeq = oppAct.seq;

      // Load latest state (written by host)
      const gs = room.state || null;
      showMpWaiting(false);
      await applyOpponentAction(oppAct, gs);
      MP_myTurn = true;
      mpUpdateTurnUI();
    }
  } catch(e) { console.error('mpPollTick error', e); }
}

async function applyOpponentAction(action, gs) {
  if (gs) { try { deserializeGameState(gs); } catch(e) {} }
  switch(action.type) {
    case 'play_digit':
      addLog(`–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–ª–æ–∂–∏–ª ${action.payload?.value ?? '?'}`, 'warn');
      updateUI();
      setTimeout(() => resolveRound(), 600);
      break;
    case 'play_super':
      addLog(`–°–æ–ø–µ—Ä–Ω–∏–∫ –∏–≥—Ä–∞–µ—Ç —Å—É–ø–µ—Ä–∫–∞—Ä—Ç—É: ${action.payload?.nameShort ?? '?'}`, 'warn');
      updateUI();
      break;
    case 'round_done':
    default:
      updateUI();
  }
}

// ‚îÄ‚îÄ Waiting overlay ‚îÄ‚îÄ
function showMpWaiting(show) {
  let el = document.getElementById('mpWaitingOverlay');
  if (show) {
    if (!el) {
      el = document.createElement('div');
      el.id = 'mpWaitingOverlay';
      el.className = 'mp-waiting-overlay';
      el.innerHTML = `
        <div class="mp-waiting-spinner"></div>
        <div style="font-family:'Bebas Neue',cursive;font-size:1.6rem;letter-spacing:3px;color:var(--white);">–•–û–î –°–û–ü–ï–†–ù–ò–ö–ê</div>
        <div style="font-size:0.8rem;color:var(--gray);font-weight:700;">–û–∂–∏–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è...</div>`;
      document.body.appendChild(el);
    }
    el.style.display = 'flex';
  } else {
    if (el) el.style.display = 'none';
  }
}

// ‚îÄ‚îÄ Override selectCard for multiplayer ‚îÄ‚îÄ
const _realSelectCard = selectCard;
window.selectCard = function(idx) {
  if (MP.active) {
    if (!MP_myTurn) {
      setStatus('‚è≥ –°–µ–π—á–∞—Å —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!');
      return;
    }
    const card = G.player.hand[idx];
    _realSelectCard(idx);
    if (card && card.type === 'digit')  mpSendAction('play_digit', { value: card.value });
    else if (card && card.type === 'super') mpSendAction('play_super', { nameShort: card.nameShort });
  } else {
    _realSelectCard(idx);
  }
};

// ‚îÄ‚îÄ Clean up on game end ‚îÄ‚îÄ
const _origEndGame = endGame;
window.endGame = async function() {
  if (MP.active) {
    clearInterval(MP_pollGame);
    MP.active = false;
    showMpWaiting(false);
    try { await fbDelete(`lobby/${MP.myId}`); } catch(e) {}
    try { await fbPatch(`rooms/${MP.roomId}`, { status: 'done' }); } catch(e) {}
  }
  _origEndGame();
};

// ‚îÄ‚îÄ goIntro cleanup ‚îÄ‚îÄ
const _origGoIntro = goIntro;
window.goIntro = function() {
  if (MP.active || MP.role !== null) {
    clearInterval(MP_pollGame);
    stopMatchmakingPoll();
    stopMmTimer();
    MP.active = false;
    MP.role   = null;
    showMpWaiting(false);
    fbDelete(`lobby/${MP.myId}`).catch(()=>{});
  }
  _origGoIntro();
  showModeSelect();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NICKNAME SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _nicknameAfterReg = false;  // was overlay opened right after registration?

function openNicknameOverlay(afterReg = false) {
  _nicknameAfterReg = afterReg;
  const overlay = document.getElementById('nicknameOverlay');
  const input   = document.getElementById('nicknameInput');
  if (!overlay) return;
  // Pre-fill existing nickname
  if (input && currentUser && currentUser.displayName) {
    input.value = currentUser.displayName;
    input.style.borderColor = 'var(--yellow)';
  } else if (input) {
    input.value = '';
    input.style.borderColor = 'var(--bg)';
  }
  document.getElementById('nicknameHint').textContent = '2‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _';
  document.getElementById('nicknameHint').style.color = 'var(--gray)';
  overlay.classList.add('active');
  setTimeout(() => input && input.focus(), 100);
}

function onNicknameInput(el) {
  const val = el.value;
  const hint = document.getElementById('nicknameHint');
  const valid = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]{2,16}$/.test(val);
  if (val.length === 0) {
    el.style.borderColor = 'var(--bg)';
    hint.textContent = '2‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _';
    hint.style.color = 'var(--gray)';
  } else if (valid) {
    el.style.borderColor = 'var(--green)';
    hint.textContent = '‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º!';
    hint.style.color = 'var(--green)';
  } else {
    el.style.borderColor = 'var(--red)';
    hint.textContent = val.length < 2 ? '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)' : val.length > 16 ? '–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ (–º–∞–∫—Å. 16)' : '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫ _';
    hint.style.color = 'var(--red)';
  }
}

async function saveNickname() {
  const input = document.getElementById('nicknameInput');
  const val = input ? input.value.trim() : '';
  const valid = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]{2,16}$/.test(val);
  if (!valid) {
    document.getElementById('nicknameHint').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º';
    document.getElementById('nicknameHint').style.color = 'var(--red)';
    input && input.focus();
    return;
  }
  if (!currentUser) { closeNicknameOverlay(); return; }
  currentUser.displayName = val;
  await saveUser(currentUser);
  closeNicknameOverlay();
  renderProfile();
  updateAccountBtn();
  // Refresh multi panel if visible
  const mp = document.getElementById('multiPanel');
  if (mp && mp.style.display !== 'none') showMultiPanel();
}

async function skipNickname() {
  if (!currentUser) { closeNicknameOverlay(); return; }
  // Assign auto-nickname if none yet
  if (!currentUser.displayName) {
    currentUser.displayName = '–ò–≥—Ä–æ–∫_' + currentUser.id.slice(-4);
    await saveUser(currentUser);
  }
  closeNicknameOverlay();
  renderProfile();
  updateAccountBtn();
  const mp = document.getElementById('multiPanel');
  if (mp && mp.style.display !== 'none') showMultiPanel();
}

function closeNicknameOverlay() {
  const overlay = document.getElementById('nicknameOverlay');
  if (overlay) overlay.classList.remove('active');
  // If opened from account popup and not after reg, make sure account popup is on top
  if (!_nicknameAfterReg) {
    const acc = document.getElementById('accountOverlay');
    if (acc) acc.classList.add('active');
  }
  _nicknameAfterReg = false;
}


// ‚îÄ‚îÄ Auto-restore session on load + init remember-me toggle ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  // Init remember toggle to ON by default
  const toggle = document.getElementById('rememberToggle');
  const thumb  = document.getElementById('rememberThumb');
  if (toggle) toggle.style.background = 'var(--orange)';
  if (thumb)  thumb.style.transform   = 'translateX(18px)';
  // Try to restore saved session
  tryRestoreSession().then(() => checkUrlForRoom());
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FRIEND ROOM SYSTEM
//  Storage: window.storage (shared: true) ‚Äî works cross-device via Claude storage
//  Room codes are 6-char alphanumeric
//  Same-browser tabs also get BroadcastChannel sync
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const FR_POLL_MS = 800;

let FR = {
  roomCode: null,
  role: null,        // 'host' | 'guest'
  password: null,
  pollInterval: null,
  channel: null,     // BroadcastChannel if available
};

// ‚îÄ‚îÄ Generate 6-char room code ‚îÄ‚îÄ
function genRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

// ‚îÄ‚îÄ URL helpers ‚îÄ‚îÄ
function getRoomUrl(code) {
  const BASE = 'https://tiny-jelly-47d36a.netlify.app/';
  return BASE + '#room=' + code;
}

function getCodeFromUrl() {
  const hash = window.location.hash;
  const match = hash.match(/room=([A-Z0-9]{6})/i);
  return match ? match[1].toUpperCase() : null;
}

// ‚îÄ‚îÄ FR Storage ‚Äî —á–µ—Ä–µ–∑ unified fbSet/fbGet/fbDelete (Firebase –∏–ª–∏ localStorage) ‚îÄ‚îÄ
function frKey(code) { return 'friendrooms/' + code.toUpperCase(); }

async function frRead(code) {
  try {
    return await fbGet(frKey(code));
  } catch(e) { return null; }
}

async function frWrite(code, data) {
  try {
    await fbSet(frKey(code), { ...data, ts: Date.now() });
    if (FR.channel) FR.channel.postMessage({ type: 'room_update', code, data });
  } catch(e) { console.error('frWrite error:', e.message); }
}

async function frDelete(code) {
  try { await fbDelete(frKey(code)); } catch(e) {}
}

// ‚îÄ‚îÄ Create a room ‚îÄ‚îÄ
async function createFriendRoom() {
  const passInput = document.getElementById('createRoomPass');
  const password = passInput ? passInput.value.trim() : '';
  const nick = (currentUser && currentUser.displayName) ? currentUser.displayName : ('–ò–≥—Ä–æ–∫_' + Math.floor(Math.random()*9000+1000));

  const code = genRoomCode();
  FR.roomCode = code;
  FR.role = 'host';
  FR.password = password || null;

  const roomData = {
    code,
    password: password || '',
    hostNick: nick,
    hostId: MP.myId || genId(),
    guestNick: null,
    guestId: null,
    status: 'waiting',
    hostReady: true,
    guestReady: false,
    hostAction: null,
    guestAction: null,
    gameState: null,
    created: Date.now(),
    ts: Date.now(),
  };

  MP.myId = roomData.hostId;
  MP.nickname = nick;
  MP.role = 'host';
  MP.roomId = code;
  initGame();
  roomData.gameState = serializeFRState();

  // Show screen immediately while writing to Firebase
  showFriendRoomScreen(roomData);

  await frWrite(code, roomData);
  setupFRChannel(code);
  startFRHostPoll();
}

// ‚îÄ‚îÄ Join a room ‚îÄ‚îÄ
async function joinFriendRoom() {
  const codeInput = document.getElementById('joinRoomCode');
  const passInput = document.getElementById('joinRoomPass');
  const errEl = document.getElementById('joinRoomError');

  const code = (codeInput ? codeInput.value.trim().toUpperCase() : '');
  const pass = passInput ? passInput.value.trim() : '';

  if (code.length !== 6) { errEl.textContent = '–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã'; return; }

  errEl.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';

  // –§–æ—Ä—Å–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É Firebase (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à)
  _fbAvailable = null;
  const fbOk = await fbDetect();
  errEl.textContent = fbOk ? '‚è≥ Firebase ‚úÖ –ò—â–µ–º –∫–æ–º–Ω–∞—Ç—É...' : '‚è≥ –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º. –ò—â–µ–º –∫–æ–º–Ω–∞—Ç—É...';

  let room = null;
  try {
    room = await frRead(code);
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ' + e.message; return;
  }

  // –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –µ—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
  if (!room) {
    if (fbOk) {
      // Firebase –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–æ –∫–æ–º–Ω–∞—Ç—ã –Ω–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ø—Ä—è–º—É—é
      try {
        const rawR = await fetch(FB_URL + '/friendrooms/' + code + '.json');
        const rawText = await rawR.text();
        errEl.textContent = '‚ùå Firebase –≤–µ—Ä–Ω—É–ª: ' + rawR.status + ' / ' + rawText.slice(0, 80);
      } catch(e2) {
        errEl.textContent = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (fetch: ' + e2.message + ')';
      }
    } else {
      errEl.textContent = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage. –•–æ—Å—Ç –∏ –≥–æ—Å—Ç—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.';
    }
    return;
  }
  if (Date.now() - room.created > 30 * 60 * 1000) { errEl.textContent = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ —É—Å—Ç–∞—Ä–µ–ª–∞ (>30 –º–∏–Ω)'; return; }
  if (room.status === 'active' || room.status === 'done') { errEl.textContent = '‚ùå –ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å'; return; }
  if (room.password && room.password !== pass) { errEl.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; return; }
  if (room.guestNick) { errEl.textContent = '‚ùå –ú–µ—Å—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ'; return; }

  errEl.textContent = '';

  const nick = (currentUser && currentUser.displayName) ? currentUser.displayName : ('–ò–≥—Ä–æ–∫_' + Math.floor(Math.random()*9000+1000));
  const guestId = genId();

  FR.roomCode = code;
  FR.role = 'guest';
  FR.password = room.password || null;
  MP.myId = guestId;
  MP.nickname = nick;
  MP.role = 'guest';
  MP.roomId = code;
  MP.opponentId = room.hostId;
  MP.opponentNickname = room.hostNick;

  room.guestNick = nick;
  room.guestId = guestId;
  room.status = 'active';
  await frWrite(code, room);

  if (room.gameState) deserializeFRState(room.gameState);

  setupFRChannel(code);

  showScreen('friendRoomScreen');
  showFRFound(room.hostNick);
  setTimeout(() => startMpGame('guest'), 2000);
}

// ‚îÄ‚îÄ Show friend room screen (host) ‚îÄ‚îÄ
function showFriendRoomScreen(room) {
  showScreen('friendRoomScreen');

  const codeEl = document.getElementById('frRoomCode');
  if (codeEl) codeEl.textContent = room.code;

  const passRow = document.getElementById('frPassRow');
  const passDis = document.getElementById('frPassDisplay');
  if (room.password) {
    if (passRow) passRow.style.display = '';
    if (passDis) passDis.textContent = room.password;
  } else {
    if (passRow) passRow.style.display = 'none';
  }

  const p1 = document.getElementById('frPlayer1Name');
  if (p1) p1.textContent = room.hostNick + ' (–≤—ã)';

  const p2row  = document.getElementById('frPlayer2Row');
  const p2name = document.getElementById('frPlayer2Name');
  const p2dot  = document.getElementById('frP2Dot');
  if (p2row)  p2row.style.opacity    = '0.4';
  if (p2name) p2name.textContent     = '–û–∂–∏–¥–∞–Ω–∏–µ...';
  if (p2dot)  p2dot.style.background = 'var(--gray)';

  const frFound  = document.getElementById('frFound');
  const frStatus = document.getElementById('frStatus');
  const frSub    = document.getElementById('frSubstatus');
  if (frFound)  frFound.style.display = 'none';
  if (frStatus) frStatus.textContent  = '–û–ñ–ò–î–ê–ï–ú –î–†–£–ì–ê...';
  if (frSub)    frSub.textContent     = '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–≥–æ–º';
}

// ‚îÄ‚îÄ Robust clipboard helper ‚îÄ‚îÄ
function copyText(text, onSuccess, onFail) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(onSuccess).catch(() => fallbackCopy(text, onSuccess, onFail));
  } else {
    fallbackCopy(text, onSuccess, onFail);
  }
}

function fallbackCopy(text, onSuccess, onFail) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0;';
  document.body.appendChild(ta);
  ta.focus(); ta.select();
  try {
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if (ok) onSuccess(); else onFail(text);
  } catch(e) {
    document.body.removeChild(ta);
    onFail(text);
  }
}

// ‚îÄ‚îÄ Copy room link ‚îÄ‚îÄ
function copyRoomLink() {
  const code = FR.roomCode;
  if (!code) return;
  const url = getRoomUrl(code);
  const btn = document.getElementById('frCopyLinkBtn');
  copyText(url,
    () => {
      if (btn) { btn.textContent = '‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'; btn.style.color = '#4ecdc4'; btn.style.borderColor = 'var(--green)'; }
      setTimeout(() => {
        if (btn) { btn.textContent = 'üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'; btn.style.color = '#7b9fff'; btn.style.borderColor = 'var(--blue)'; }
      }, 2000);
    },
    (text) => { prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', text); }
  );
}

// ‚îÄ‚îÄ Copy room code ‚îÄ‚îÄ
function copyRoomCode() {
  const code = FR.roomCode;
  if (!code) return;
  const btn    = document.getElementById('frCopyCodeBtn');
  const codeEl = document.getElementById('frRoomCode');

  copyText(code,
    () => {
      if (btn)    { btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; btn.style.background = 'linear-gradient(135deg,#0a3d20,#0d6b38)'; btn.style.color = '#4ecdc4'; btn.style.borderColor = 'var(--green)'; }
      if (codeEl) { codeEl.style.color = 'var(--green)'; }
      setTimeout(() => {
        if (btn)    { btn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥'; btn.style.background = 'linear-gradient(135deg,#1a3a20,#1a5c30)'; btn.style.color = 'var(--green)'; btn.style.borderColor = 'var(--green)'; }
        if (codeEl) { codeEl.style.color = 'var(--yellow)'; }
      }, 2000);
    },
    (text) => { prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:', text); }
  );
}

// ‚îÄ‚îÄ BroadcastChannel for same-browser comms ‚îÄ‚îÄ
function setupFRChannel(code) {
  try {
    if (FR.channel) FR.channel.close();
    FR.channel = new BroadcastChannel('chislobitva_' + code);
    FR.channel.onmessage = (e) => {
      if (e.data && e.data.type === 'room_update') frHandleExternalUpdate(e.data.data);
    };
  } catch(ex) { FR.channel = null; }
}

function frHandleExternalUpdate(data) {
  if (!data) return;
  if (FR.role === 'host' && data.guestNick && !MP.opponentId) {
    // Guest joined!
    MP.opponentId = data.guestId;
    MP.opponentNickname = data.guestNick;
    onFriendJoined(data);
  }
  if (data.guestAction && FR.role === 'host') frApplyOppAction(data.guestAction);
  if (data.hostAction && FR.role === 'guest') frApplyOppAction(data.hostAction);
}

// ‚îÄ‚îÄ Host polls for guest joining ‚îÄ‚îÄ
let _frLastGuestId = null;
let _frLastActionSeen = null;

function startFRHostPoll() {
  if (FR.pollInterval) clearInterval(FR.pollInterval);
  FR.pollInterval = setInterval(async () => {
    if (FR.role !== 'host') return;
    const room = await frRead(FR.roomCode);
    if (!room) return;
    if (room.guestId && room.guestId !== _frLastGuestId) {
      _frLastGuestId = room.guestId;
      MP.opponentId = room.guestId;
      MP.opponentNickname = room.guestNick;
      onFriendJoined(room);
    }
  }, FR_POLL_MS);
}

function startFRGamePoll() {
  if (FR.pollInterval) clearInterval(FR.pollInterval);
  _frLastActionSeen = null;
  FR.pollInterval = setInterval(async () => {
    const room = await frRead(FR.roomCode);
    if (!room) return;
    const oppAction = FR.role === 'host' ? room.guestAction : room.hostAction;
    const key = oppAction ? (oppAction.seq + '_' + oppAction.ts) : null;
    if (key && key !== _frLastActionSeen) {
      _frLastActionSeen = key;
      if (room.gameState) deserializeFRState(room.gameState);
      frApplyOppAction(oppAction);
    }
  }, FR_POLL_MS);
}

function onFriendJoined(room) {
  clearInterval(FR.pollInterval);
  showFRFound(room.guestNick);
  setTimeout(() => {
    startFRGamePoll();
    startMpGame('host');
  }, 2000);
}

function showFRFound(name) {
  const p2row = document.getElementById('frPlayer2Row');
  const p2name = document.getElementById('frPlayer2Name');
  const p2dot = document.getElementById('frP2Dot');
  const p2badge = document.getElementById('frP2Badge');
  const frFound = document.getElementById('frFound');
  const frStatus = document.getElementById('frStatus');
  const frSub = document.getElementById('frSubstatus');
  const spinner = document.getElementById('frSpinner');

  if (p2row) p2row.style.opacity = '1';
  if (p2name) { p2name.textContent = name; p2name.style.color = 'var(--white)'; }
  if (p2dot) p2dot.style.background = 'var(--green)';
  if (p2badge) p2badge.textContent = '–ì–æ—Å—Ç—å';
  if (frFound) frFound.style.display = 'flex';
  if (frStatus) frStatus.textContent = '';
  if (frSub) frSub.textContent = '';
  if (spinner) spinner.style.display = 'none';
}

function cancelFriendRoom() {
  clearInterval(FR.pollInterval);
  if (FR.channel) { FR.channel.close(); FR.channel = null; }
  if (FR.roomCode) frDelete(FR.roomCode); // async, fire-and-forget
  FR.roomCode = null;
  FR.role = null;
  MP.active = false;
  MP.role = null;
  // Clear URL hash
  history.replaceState(null, '', window.location.pathname);
  goIntro();
  showFriendPanel();
}

// ‚îÄ‚îÄ Serialise game state for storage ‚îÄ‚îÄ
function serializeFRState() {
  return {
    digitDeck:   G.digitDeck,
    enhanceDeck: G.enhanceDeck,
    hostHand:    G.player.hand,
    guestHand:   G.ai.hand,
    hostWin:     G.player.winStack,
    guestWin:    G.ai.winStack,
    table:       G.table,
    round:       G.round,
    phase:       G.phase,
    frozen:      G.frozenInRound,
    hostLost:    G.player.lastLost,
    guestLost:   G.ai.lastLost,
    superBattle: G.superBattle,
  };
}

function deserializeFRState(s) {
  if (!s) return;
  const myHost = MP.role === 'host';
  G.digitDeck   = s.digitDeck   || [];
  G.enhanceDeck = s.enhanceDeck || [];
  G.player.hand      = myHost ? (s.hostHand  || []) : (s.guestHand || []);
  G.ai.hand          = myHost ? (s.guestHand || []) : (s.hostHand  || []);
  G.player.winStack  = myHost ? (s.hostWin   || []) : (s.guestWin  || []);
  G.ai.winStack      = myHost ? (s.guestWin  || []) : (s.hostWin   || []);
  G.table            = s.table       || G.table;
  G.round            = s.round       || 1;
  G.phase            = s.phase       || G.phase;
  G.frozenInRound    = s.frozen      || false;
  G.player.lastLost  = myHost ? (s.hostLost  || []) : (s.guestLost || []);
  G.ai.lastLost      = myHost ? (s.guestLost || []) : (s.hostLost  || []);
  G.superBattle      = s.superBattle || G.superBattle;
}

// ‚îÄ‚îÄ Send action in friend room ‚îÄ‚îÄ
async function frSendAction(type, payload) {
  if (!FR.roomCode) return;
  const room = await frRead(FR.roomCode);
  if (!room) return;
  const seq = Date.now();
  const action = { type, payload, by: MP.myId, seq, ts: Date.now() };
  if (FR.role === 'host') {
    room.hostAction = action;
    room.gameState = serializeFRState();
  } else {
    room.guestAction = action;
  }
  await frWrite(FR.roomCode, room);
  MP_myTurn = false;
  mpUpdateTurnUI();
  showMpWaiting(true);
}

function frApplyOppAction(action) {
  if (!action) return;
  showMpWaiting(false);
  switch(action.type) {
    case 'play_digit':
      addLog('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–ª–æ–∂–∏–ª ' + action.payload.value, 'warn');
      updateUI();
      setTimeout(() => resolveRound(), 600);
      break;
    case 'play_super':
      addLog('–°–æ–ø–µ—Ä–Ω–∏–∫: ' + action.payload.nameShort, 'warn');
      updateUI();
      break;
    case 'superbattle_pick':
      addLog('–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ä—Ç—É...', 'warn');
      setTimeout(() => superBattleReveal(), 800);
      break;
    default:
      updateUI();
  }
  MP_myTurn = true;
  mpUpdateTurnUI();
}

// ‚îÄ‚îÄ Override selectCard + mpSendAction for friend room mode ‚îÄ‚îÄ
const _frOrigSelectCard = window.selectCard;
window.selectCard = function(idx) {
  if (FR.roomCode && FR.role) {
    // Friend room mode
    if (!MP_myTurn) { setStatus('‚è≥ –°–µ–π—á–∞—Å —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!', 'danger'); return; }
    const card = G.player.hand[idx];
    _frOrigSelectCard(idx);
    if (card && card.type === 'digit') frSendAction('play_digit', { value: card.value });
    else if (card && card.type === 'super') frSendAction('play_super', { nameShort: card.nameShort });
  } else {
    _frOrigSelectCard(idx);
  }
};

// ‚îÄ‚îÄ Check URL on load for room invite links ‚îÄ‚îÄ
function checkUrlForRoom() {
  const code = getCodeFromUrl();
  if (!code) return;
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ö–æ–¥–∏–º –≤ –∫–æ–º–Ω–∞—Ç—É –ø–æ —Å—Å—ã–ª–∫–µ
  setTimeout(async () => {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∫–æ–¥–∞
    const input = document.getElementById('joinRoomCode');
    if (input) input.value = code;
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    const errEl = document.getElementById('joinRoomError');
    if (errEl) errEl.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...';
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
    showMultiPanel();
    showFriendPanel();
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã UI –æ—Ç—Ä–∏—Å–æ–≤–∞–ª—Å—è
    await new Promise(r => setTimeout(r, 300));
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ö–æ–¥–∏–º
    await joinFriendRoom();
    // –û—á–∏—â–∞–µ–º —Ö—ç—à –∏–∑ URL
    try { history.replaceState(null, '', window.location.pathname); } catch(e) {}
  }, 800);
}

// ‚îÄ‚îÄ Cleanup friend room on game end ‚îÄ‚îÄ
const _frOrigEndGame = window.endGame;
window.endGame = async function() {
  if (FR.roomCode) {
    clearInterval(FR.pollInterval);
    if (FR.channel) { FR.channel.close(); FR.channel = null; }
    frRead(FR.roomCode).then(room => {
      if (room) { room.status = 'done'; frWrite(FR.roomCode, room); }
    }).catch(() => {});
    try { await frDelete(FR.roomCode); } catch(e) {}
    FR.roomCode = null;
    FR.role = null;
  }
  _frOrigEndGame && _frOrigEndGame();
};

</script>
</body>
</html>
